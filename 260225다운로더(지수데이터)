import sys
import os
import time
import pandas as pd
from datetime import datetime
from PyQt5.QtWidgets import QApplication
from PyQt5.QAxContainer import QAxWidget
from PyQt5.QtCore import QEventLoop

# ==========================================
# ğŸ’¡ [ì‚¬ìš©ì ì„¤ì •] ì§€ìˆ˜ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì„¤ì •
# ==========================================
START_YEAR = 2016                  # ë‹¤ìš´ë¡œë“œ ì‹œì‘ ì—°ë„ (ì˜ˆ: 10ë…„ ì¹˜ -> 2016)
END_YEAR = 2026                    # ë‹¤ìš´ë¡œë“œ ì¢…ë£Œ ì—°ë„ (ì˜ˆ: í˜„ì¬ -> 2026)
SAVE_DIR = "common_market_data"    # ğŸ“‚ ê³µí†µ ì§€ìˆ˜ ë°ì´í„°ë¥¼ ì €ì¥í•  ë©”ì¸ í´ë”ëª…
# ==========================================

class KiwoomDownloader(QAxWidget):
    def __init__(self):
        super().__init__()
        self._create_kiwoom_instance()
        self._set_signal_slots()
        self._login()

        self.remained_data = False
        self.ohlcv_data = []
        self.screen_no = "0101"

    def _create_kiwoom_instance(self):
        self.setControl("KHOPENAPI.KHOpenAPICtrl.1")

    def _set_signal_slots(self):
        self.OnEventConnect.connect(self._on_event_connect)
        self.OnReceiveTrData.connect(self._on_receive_tr_data)

    def _login(self):
        self.login_event_loop = QEventLoop()
        self.dynamicCall("CommConnect()")
        self.login_event_loop.exec_()

    def _on_event_connect(self, err_code):
        if err_code == 0:
            print("âœ… í‚¤ì›€ API ë¡œê·¸ì¸ ì„±ê³µ")
        else:
            print(f"âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ (ì—ëŸ¬ì½”ë“œ: {err_code})")
        self.login_event_loop.exit()

    # [í•µì‹¬] ì—…ì¢…(ì§€ìˆ˜) ì¼ë´‰ ì°¨íŠ¸ ì¡°íšŒ (opt20006)
    def request_index_daily_chart(self, index_code, start_year, end_year):
        self.ohlcv_data = []
        self.remained_data = True
        next_val = 0

        # ëª©í‘œ ê¸°ê°„ì˜ ì‹œì‘ê³¼ ë ë‚ ì§œ ì„¤ì • (YYYYMMDD)
        start_date_str = f"{start_year}0101"
        end_date_str = f"{end_year}1231"

        while self.remained_data:
            # 001: ì½”ìŠ¤í”¼, 101: ì½”ìŠ¤ë‹¥ ë“±
            self.dynamicCall("SetInputValue(QString, QString)", "ì—…ì¢…ì½”ë“œ", index_code)
            self.dynamicCall("SetInputValue(QString, QString)", "ê¸°ì¤€ì¼ì", end_date_str)
            self._comm_rq_data("opt20006", "ì—…ì¢…ì¼ë´‰ì°¨íŠ¸ì¡°íšŒ", next_val, self.screen_no)

            if self.ohlcv_data:
                last_date_str = self.ohlcv_data[-1][0]  # í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì˜ ë§ˆì§€ë§‰ ì¼ì (YYYYMMDD)
                if last_date_str:
                    # ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ëª©í‘œ ê¸°ê°„ ì‹œì‘ì¼ë³´ë‹¤ ê³¼ê±°ë¡œ ë„˜ì–´ê°€ë©´ ì¡°ê¸° ì¢…ë£Œ
                    if last_date_str < start_date_str:
                        break

            if self.remained_data:
                next_val = 2
                time.sleep(0.5)  # TR í†µì‹  ê³¼ë¶€í•˜ ë°©ì§€

        if not self.ohlcv_data:
            return pd.DataFrame()

        df = pd.DataFrame(self.ohlcv_data, columns=['Date', 'Open', 'High', 'Low', 'Close', 'Volume'])
        
        # ì¼ë´‰ì— ë§ì¶° ë‚ ì§œ íŒŒì‹± í˜•ì‹ ë³€ê²½ (YYYYMMDD)
        df['Date'] = pd.to_datetime(df['Date'], format='%Y%m%d')
        
        # ì •í™•íˆ ì‚¬ìš©ìê°€ ì§€ì •í•œ ê¸°ê°„ì˜ ë°ì´í„°ë§Œ í•„í„°ë§ í›„ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
        df = df[(df['Date'].dt.year >= start_year) & (df['Date'].dt.year <= end_year)]
        df = df.sort_values(by='Date').reset_index(drop=True)

        return df

    def _comm_rq_data(self, trcode, rqname, next_val, screen_no):
        self.tr_event_loop = QEventLoop()
        ret = self.dynamicCall("CommRqData(QString, QString, int, QString)", rqname, trcode, next_val, screen_no)
        if ret != 0:
            print(f"\nâŒ TR ìš”ì²­ ì‹¤íŒ¨ ({rqname}) - ì—ëŸ¬ì½”ë“œ: {ret}")
            self.remained_data = False
            return
        self.tr_event_loop.exec_()

    def _get_comm_data_float(self, trcode, rqname, index, item_name):
        """ì§€ìˆ˜ëŠ” ì†Œìˆ˜ì ì´ í¬í•¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ floatë¡œ ë³€í™˜"""
        val = self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, index, item_name).strip()
        try:
            return abs(float(val)) if val else 0.0
        except ValueError:
            return 0.0

    def _get_comm_data_int(self, trcode, rqname, index, item_name):
        """ê±°ë˜ëŸ‰ ë“±ì€ ì •ìˆ˜ë¡œ ë³€í™˜"""
        val = self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, index, item_name).strip()
        try:
            return abs(int(val)) if val else 0
        except ValueError:
            return 0

    def _on_receive_tr_data(self, screen_no, rqname, trcode, record_name, next_val, unused1, unused2, unused3, unused4):
        # ì—°ì†ì¡°íšŒ(ë‹¤ìŒ í˜ì´ì§€) ë°ì´í„° ìœ ë¬´ í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
        self.remained_data = (next_val == '2')
        count = self.dynamicCall("GetRepeatCnt(QString, QString)", trcode, rqname)

        for i in range(count):
            date = self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "ì¼ì").strip()
            open_ = self._get_comm_data_float(trcode, rqname, i, "ì‹œê°€")
            high = self._get_comm_data_float(trcode, rqname, i, "ê³ ê°€")
            low = self._get_comm_data_float(trcode, rqname, i, "ì €ê°€")
            close = self._get_comm_data_float(trcode, rqname, i, "í˜„ì¬ê°€")
            volume = self._get_comm_data_int(trcode, rqname, i, "ê±°ë˜ëŸ‰")

            self.ohlcv_data.append([date, open_, high, low, close, volume])

        self.tr_event_loop.exit()


def main():
    app = QApplication(sys.argv)

    print("ğŸš€ í‚¤ì›€ì¦ê¶Œ API ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘...")
    kiwoom = KiwoomDownloader()

    # ìƒë‹¨ ì„¤ì •ê°’ ë°˜ì˜
    save_dir = SAVE_DIR
    if not os.path.exists(save_dir):
        os.makedirs(save_dir)

    # ğŸ’¡ í‚¤ì›€ì¦ê¶Œ ì—…ì¢…ì½”ë“œ (001: ì¢…í•©(ì½”ìŠ¤í”¼), 101: ì¢…í•©(ì½”ìŠ¤ë‹¥))
    target_indices = [
        ("001", "ì½”ìŠ¤í”¼"),
        ("101", "ì½”ìŠ¤ë‹¥")
    ]

    print(f"ğŸš€ ë‹¤ìš´ë¡œë“œ ì‹œì‘ ({START_YEAR}ë…„ ~ {END_YEAR}ë…„ ì§€ìˆ˜ ë°ì´í„°)...")

    for idx, (code, name) in enumerate(target_indices):
        print(f"[{idx + 1}/{len(target_indices)}] {name}({code}) ì§€ìˆ˜ ë°ì´í„° ìš”ì²­ ì¤‘...", end=" ", flush=True)

        try:
            df = kiwoom.request_index_daily_chart(code, START_YEAR, END_YEAR)

            if not df.empty:
                file_path = os.path.join(save_dir, f"{name}_ì¼ë´‰ì§€ìˆ˜.xlsx")
                df.to_excel(file_path, index=False)
                print(f"ì™„ë£Œ ({len(df)}ì¼ì¹˜ ì €ì¥ë¨)")
            else:
                print("ë°ì´í„° ì—†ìŒ")

            time.sleep(0.5)  # TR ì´ˆë‹¹ ìš”ì²­ íšŸìˆ˜ ì œí•œ ë°©ì–´

        except Exception as e:
            print(f"ì‹¤íŒ¨ ({e})")

    print(f"\nğŸ‰ '{save_dir}' í´ë”ì— 2ê°œì˜ ì§€ìˆ˜ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!")
    sys.exit()


if __name__ == "__main__":
    main()
