# ==========================================
# ğŸ“Š [ìƒì„¸ ê±°ë˜ ë‚´ì—­ ë¦¬í¬íŠ¸] 1ë¶„ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + 60ì´í‰(VWAPëŒ€ì²´) + ë°´ë“œí­/RSI/ATR êµ¬ê°„ ë¶„ì„
# =======================================================================================================================
# ì¢…ëª©ëª…          | ë§¤ìˆ˜ì¼       | ë§¤ìˆ˜ì‹œê°„ | ë§¤ë„ì‹œê°„ | ë³´ìœ (ë¶„) |     ë§¤ìˆ˜ê°€ |     ë§¤ë„ê°€ | ëŒíŒŒìƒìŠ¹ë¥  |  ìˆ˜ìµë¥  | ìµœëŒ€ìˆ˜ìµë¥  |   RSI |  ATR(%) |   ADX | ë°´ë“œí­(%)
# -----------------------------------------------------------------------------------------------------------------------
# ...
# =======================================================================================================================
import matplotlib

# í™”ë©´ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì—ì„œ ì´ë¯¸ì§€ ìƒì„± (ì¶©ëŒ ë°©ì§€)
matplotlib.use('Agg')

import backtrader as bt
import pandas as pd
import os
import math
import unicodedata
from datetime import time, timedelta
from collections import defaultdict
import matplotlib.pyplot as plt

# -----------------------------------------------------------------------------
# [ì¶”ê°€] í•œê¸€/ì˜ë¬¸ ì½˜ì†” ì¶œë ¥ ì •ë ¬ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ë„ˆë¹„ ê³„ì‚° í•¨ìˆ˜
# í•œê¸€ ë“± ë™ì•„ì‹œì•„ ë¬¸ìëŠ” 1.7ì¹¸, ì˜ë¬¸/ìˆ«ìëŠ” 1ì¹¸ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì‹œê°ì  í­ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------
def calc_width(s):
    return int(round(sum(1.7 if unicodedata.east_asian_width(c) in 'WF' else 1 for c in str(s))))

def lpad(s, w):
    s = str(s)
    return s + ' ' * max(0, w - calc_width(s))

def rpad(s, w):
    s = str(s)
    return ' ' * max(0, w - calc_width(s)) + s

# -----------------------------------------------------------------------------
# CustomPandasData í´ë˜ìŠ¤
# -----------------------------------------------------------------------------
class CustomPandasData(bt.feeds.PandasData):
    lines = ('rsi',)
    params = (
        ('datetime', None),
        ('open', 'Open'),
        ('high', 'High'),
        ('low', 'Low'),
        ('close', 'Close'),
        ('volume', 'Volume'),
        ('openinterest', None),
        ('rsi', 'rsi'),
    )


# -----------------------------------------------------------------------------
# RSI ê³„ì‚° í•¨ìˆ˜ (ë°ì´í„° ì „ì²˜ë¦¬ìš©)
# -----------------------------------------------------------------------------
def calculate_rsi(series, period=14):
    delta = series.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    return 100 - (100 / (1 + rs))


# -----------------------------------------------------------------------------
# [ë³µì›] ìˆ˜ìµë¥  Top 5 / Bottom 5 ì°¨íŠ¸ ì €ì¥ í•¨ìˆ˜
# -----------------------------------------------------------------------------
def save_chart(t, folder, prefix, rank):
    try:
        df = pd.read_excel(t['file_path'])
        df.columns = [c.strip() for c in df.columns]
        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume', 'ì¼ì': 'Date', 'ì²´ê²°ì‹œê°„': 'Date'}
        df = df.rename(columns=rename_map)

        if 'Date' in df.columns:
            if pd.api.types.is_numeric_dtype(df['Date']):
                df['Date'] = df['Date'].astype(str)
            df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            return

        cols_to_numeric = ['Close']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()

        open_dt = pd.to_datetime(f"{t['open_date']} {t['open_time']}")
        close_dt = pd.to_datetime(f"{t['date']} {t['close_time']}")

        # ì°¨íŠ¸ ë²”ìœ„: ë§¤ìˆ˜ 1ì‹œê°„ ì „ ~ ë§¤ë„ 1ì‹œê°„ í›„ (ë¶„ë´‰ íë¦„ íŒŒì•…ìš©)
        start_dt = open_dt - pd.Timedelta(hours=1)
        end_dt = close_dt + pd.Timedelta(hours=1)

        mask = (df.index >= start_dt) & (df.index <= end_dt)
        plot_df = df.loc[mask]

        if plot_df.empty:
            return

        plt.figure(figsize=(10, 5))
        
        # í•œê¸€ í°íŠ¸ ì„¤ì •
        if os.name == 'nt':
            plt.rcParams['font.family'] = 'Malgun Gothic'
        else:
            plt.rcParams['font.family'] = 'AppleGothic'
        plt.rcParams['axes.unicode_minus'] = False

        plt.plot(plot_df.index, plot_df['Close'], color='gray', linewidth=1.5, label='Close Price')
        
        # ì§„ì…/ì²­ì‚° íƒ€ì  ë§ˆí‚¹
        plt.scatter(open_dt, t['entry_price'], color='red', marker='^', s=150, label='Buy', zorder=5)
        plt.scatter(close_dt, t['exit_price'], color='blue', marker='v', s=150, label='Sell', zorder=5)

        plt.title(f"[{prefix} {rank}] {t['stock_name']} (ìˆ˜ìµë¥ : {t['profit_pct']:.2f}%)")
        plt.grid(True, linestyle='--', alpha=0.6)
        plt.legend()
        plt.xticks(rotation=45)
        plt.tight_layout()

        # íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ë³€í™˜
        safe_name = "".join([c for c in t['stock_name'] if c.isalpha() or c.isdigit() or c == ' ']).rstrip()
        filename = f"{prefix}_{rank}_{safe_name}.png"
        
        plt.savefig(os.path.join(folder, filename))
        plt.close()
    except Exception as e:
        plt.close()


# ==========================================
# [ì „ëµ] 1ë¶„ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + ì´í‰ì„  í•„í„° + ì´ˆë‹¨íƒ€ ë§¤ë„
# ==========================================
# ğŸ’¡ [í•µì‹¬] ì•„ë˜ì˜ ì„¤ì •ê°’ë“¤ë§Œ ë³€ê²½í•˜ë©´ ì „ì²´ ë°±í…ŒìŠ¤íŠ¸ ë¡œì§ì´ ìë™ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
STRATEGY_PARAMS = (
    ('target_pct', 0.015),  # 1.5% ìƒìŠ¹
    ('vol_surge', 3.0),     # ê±°ë˜ëŸ‰ 300% (3ë°°)
    ('vol_period', 20),     # ê±°ë˜ëŸ‰ í‰ê· ì„ êµ¬í•  ê¸°ì¤€ ìº”ë“¤ ìˆ˜
    ('ma_trend_fast', 10),  # ì¶”ì„¸ìš© ë‹¨ê¸°ì„ 
    ('ma_trend_slow', 20),  # ì¶”ì„¸ìš© ì¤‘ê¸°ì„ 
    ('ma_vwap_proxy', 60),  # VWAP ëŒ€ì²´ë¥¼ ìœ„í•œ ì´í‰ì„  (1ì‹œê°„ í‰ê· )
    ('ma_fast', 3),         # ë§¤ë„ìš© ë‹¨ê¸°ì„ 
    ('ma_slow', 5),         # ë§¤ë„ìš© ì¤‘ê¸°ì„ 
    ('slippage_pct', 0.005),# [ì¶”ê°€] ë¶„ì„ ë¦¬í¬íŠ¸ìš© ìŠ¬ë¦¬í”¼ì§€ ì„¤ì • (ê¸°ë³¸ 0.5%)
    ('boll_period', 20),
    ('boll_dev', 2.0),
    ('debug', False),
)

class CustomDailyStrategy(bt.Strategy):
    """
    [ìƒì„¸ ì „ëµ ì„¤ëª… ë° ì˜ì›…ë¬¸ HTS(0156) ì¡°ê±´ê²€ìƒ‰ ì„¤ì • ê°€ì´ë“œ]
    ================================================================================
    ì´ ì „ëµì€ 1ë¶„ë´‰ ì´ˆë‹¨íƒ€(ìŠ¤ìº˜í•‘)ì— ë§ì¶°ì ¸ ìˆìœ¼ë©°, ì˜ì›…ë¬¸ HTSì—ì„œ 100% ë™ì¼í•˜ê²Œ êµ¬í˜„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    (ê¸°ì¡´ì— êµ¬ìƒí–ˆë˜ VWAP ì¡°ê±´ì€ HTS 0156 ê²€ìƒ‰ì‹ì—ì„œ ì§€ì›í•˜ì§€ ì•Šì•„, 
    ëŒ€ì²´ ì§€í‘œì¸ '1ë¶„ ì£¼ê¸° 60ì´í‰ì„ (ì•½ 1ì‹œê°„ ë‹¨ê°€)'ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì •í™•íˆ í˜¸í™˜ë˜ê²Œ í–ˆìŠµë‹ˆë‹¤.)

    ğŸ“Œ [HTS ì¡°ê±´ê²€ìƒ‰ ì„¤ì • ì„¸íŒ… (0156 í™”ë©´) - ëª¨ë“  ì£¼ê¸°ëŠ” '1ë¶„'ìœ¼ë¡œ í†µì¼]
    
    [A] ë³€ë™ì„± ëŒíŒŒ (ìº”ë“¤ í•˜ë‚˜ì—ì„œ 1.5% ê¸‰ë“± ì–‘ë´‰)
        -> [ë©”ë‰´] ì‹œì„¸ë¶„ì„ > ê°€ê²©ì¡°ê±´ > ì£¼ê°€ë“±ë½ë¥ 
        -> [ì„¤ì •] 1ë¶„ì£¼ê¸°, 0ë´‰ì „(í˜„ì¬) ì‹œê°€ ëŒ€ë¹„ 0ë´‰ì „ ì¢…ê°€ ë“±ë½ë¥  1.5% ì´ìƒ
    
    [B] ìˆ˜ê¸‰ í­ë°œ (ê±°ë˜ëŸ‰ 300% í­ì¦)
        -> [ë©”ë‰´] ì‹œì„¸ë¶„ì„ > ê±°ë˜ëŸ‰/ê±°ë˜ëŒ€ê¸ˆ > ê±°ë˜ëŸ‰ë¹„ìœ¨(në´‰)
        -> [ì„¤ì •] 1ë¶„ì£¼ê¸°, 1ë´‰ì „ 20ë´‰ í‰ê· ê±°ë˜ëŸ‰ ëŒ€ë¹„ 0ë´‰ì „ ê±°ë˜ëŸ‰ 300% ì´ìƒ
    
    [C] ì¶”ì„¸ í•„í„° (10ì„  > 20ì„  ì •ë°°ì—´)
        -> [ë©”ë‰´] ê¸°ìˆ ì ë¶„ì„ > ì£¼ê°€ì´ë™í‰ê·  > ì£¼ê°€ì´ë™í‰ê· ë°°ì—´(3ê°œ)
        -> [ì„¤ì •] 1ë¶„ì£¼ê¸°, ì¢…ê°€ 1 > ì¢…ê°€ 10 > ì¢…ê°€ 20 (ë‹¨ìˆœ) 
           (ì˜ì›…ë¬¸ì—” 2ê°œ ë¹„êµê°€ ì—†ìœ¼ë¯€ë¡œ, í˜„ì¬ê°€(1)ê°€ ê°€ì¥ ìœ„ì— ìˆëŠ” 3ê°œ ì •ë°°ì—´ë¡œ ì„¤ì •)
    
    [D] ì„¸ë ¥/ê°œë¯¸ í‰ê· ë‹¨ê°€ ìƒíšŒ í•„í„° (VWAP ì™„ë²½ ëŒ€ì²´ -> 60ì´í‰ ìƒíšŒ)
        -> [ë©”ë‰´] ê¸°ìˆ ì ë¶„ì„ > ì£¼ê°€ì´ë™í‰ê·  > ì£¼ê°€ì´ë™í‰ê· ë¹„êµ
        -> [ì„¤ì •] 1ë¶„ì£¼ê¸°, [ë‹¨ìˆœ]ì¢…ê°€ 60 < [ë‹¨ìˆœ]ì¢…ê°€ 1 (í˜„ì¬ ì£¼ê°€ê°€ 60ì´í‰ì„  ìœ„ì— ìœ„ì¹˜)

    2. ë§¤ë„ ì²­ì‚° ì¡°ê±´ (íŒŒì´ì¬ ë§¤ë§¤ ë¡œì§)
       A. 3ë¶„ì„  < 5ë¶„ì„  ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ê°€ ì‹œì¥ê°€ ì²­ì‚°
    ================================================================================
    """
    params = STRATEGY_PARAMS

    def __init__(self):
        # íŒŒë¼ë¯¸í„° ê°’ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì´ë™í‰ê· ì„  ìƒì„±
        self.ma_fast_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_fast)
        self.ma_slow_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_slow)

        self.ma_trend_fast_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_trend_fast)
        self.ma_trend_slow_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_trend_slow)
        
        self.ma_vwap_proxy_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_vwap_proxy)

        self.vol_sma = bt.indicators.SimpleMovingAverage(self.data.volume, period=self.p.vol_period)

        # ë³´ì¡°ì§€í‘œ ì„¤ì • (ë¶„ì„ìš©ìœ¼ë¡œë§Œ ìˆ˜ì§‘)
        typical_price = (self.data.high + self.data.low + self.data.close) / 3.0
        self.bband = bt.indicators.BollingerBands(typical_price, period=self.p.boll_period, devfactor=self.p.boll_dev)
        self.atr = bt.indicators.ATR(self.data, period=14)
        self.adx = bt.indicators.ADX(self.data, period=14)

        # ìˆ˜ë™ í¬ì§€ì…˜ ê´€ë¦¬ìš©
        self.my_position = None
        self.trades_history = []
        self.peak_price = 0 

    def next(self):
        # [ë™ì  ê³„ì‚°] íŒŒë¼ë¯¸í„°ë¡œ ì„¤ì •ëœ ì´í‰ì„ ë“¤ ì¤‘ ê°€ì¥ ê¸´ ê¸°ê°„ì˜ ë°ì´í„°ê°€ ìŒ“ì¼ ë•Œê¹Œì§€ ëŒ€ê¸°
        if len(self.data) < max(self.p.ma_vwap_proxy + 1, self.p.boll_period + 2, self.p.vol_period + 1, self.p.ma_trend_slow + 1, self.p.ma_slow + 2):
            return

        current_date = self.data.datetime.date(0)
        current_time = self.data.datetime.time(0)

        # ----------------------------------------------------------------------
        # [1] ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ë„(ì²­ì‚°) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position:
            if self.data.high[0] > self.peak_price:
                self.peak_price = self.data.high[0]

            # [ë³µì›/ë™ì ê³„ì‚°] ë°ë“œí¬ë¡œìŠ¤ ë°©ì–´ ê°€ê²© ê³„ì‚° (ë‹¨ê¸° ì´í‰ì„ ì´ ì¤‘ê¸° ì´í‰ì„ ì„ í•˜í–¥ ì´íƒˆí•˜ê²Œ ë§Œë“œëŠ” ì˜ˆì¸¡ ê°€ê²©)
            # íŒŒë¼ë¯¸í„° ê°’(F, S)ì´ ì–´ë–»ê²Œ ë³€í•˜ë“  ë²”ìš©ì ìœ¼ë¡œ ê³„ì‚°í•´ë‚´ëŠ” ìˆ˜í•™ ê³µì‹ ì ìš©
            F = self.p.ma_fast
            S = self.p.ma_slow
            sum_F = sum(self.data.close[-i] for i in range(1, F))
            sum_S = sum(self.data.close[-i] for i in range(1, S))
            cross_price_raw = (F * sum_S - S * sum_F) / (S - F) if S != F else 0
            cross_price = round(cross_price_raw)

            sell_signal = False
            sell_price = 0
            sell_reason = ""

            # ë§¤ë„ ì¡°ê±´ 1: ì§ì „ ìº”ë“¤ì— ì´ë¯¸ ë‹¨ê¸°ì„ ì´ ì¤‘ê¸°ì„  ì•„ë˜ë¡œ ë‚´ë ¤ê°„(ë°ë“œí¬ë¡œìŠ¤) ìƒíƒœë¼ë©´, í˜„ì¬ ì‹œê°€ì— ì¦‰ì‹œ ì‹œì¥ê°€ ë§¤ë„
            if self.ma_fast_line[-1] < self.ma_slow_line[-1]:
                sell_signal = True
                sell_price = self.data.open[0]
                sell_reason = "ì§ì „ ì´ë¯¸ ë°ë“œí¬ë¡œìŠ¤ ìƒíƒœ"
            # ë§¤ë„ ì¡°ê±´ 2: ì¥ì¤‘ ìµœì €ê°€ê°€ ë°ë“œí¬ë¡œìŠ¤ ë°©ì–´ ê°€ê²©ì„ ì´íƒˆí•œ ê²½ìš°
            elif self.data.low[0] <= cross_price:
                sell_signal = True
                # ë§Œì•½ ì‹œê°€ë¶€í„° ê°­í•˜ë½í•˜ì—¬ ë°ë“œí¬ë¡œìŠ¤ ê°€ê²© ì•„ë˜ì—ì„œ ì¶œë°œí–ˆë‹¤ë©´ ì‹œê°€ì— ë§¤ë„
                if self.data.open[0] < cross_price:
                    sell_price = self.data.open[0]
                    sell_reason = "ê°­í•˜ë½ ë°ë“œí¬ë¡œìŠ¤"
                # ì •ìƒì ìœ¼ë¡œ ì‹œì‘ í›„ í•˜ë½í•˜ì—¬ í„°ì¹˜í–ˆë‹¤ë©´ í•´ë‹¹ ê°€ê²©(cross_price)ì— ë§¤ë„
                else:
                    sell_price = cross_price
                    sell_reason = "ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ í„°ì¹˜"

            if sell_signal:
                entry_price = self.my_position['price']
                buy_size = self.my_position['size']
                buy_reason = self.my_position['reason']
                entry_rsi = self.my_position.get('rsi', 0)
                entry_atr = self.my_position.get('atr', 0)
                entry_adx = self.my_position.get('adx', 0)
                entry_bandwidth = self.my_position.get('bandwidth', 0)
                entry_surge = self.my_position.get('surge_pct', 0)  # [ì¶”ê°€] ë§¤ìˆ˜ ì‹œ ëŒíŒŒìƒìŠ¹ë¥  ì „ë‹¬
                entry_bar = self.my_position.get('entry_bar', len(self))
                open_date = self.my_position['date']
                open_time = self.my_position['time']

                # ë¶„ë´‰ì´ë¯€ë¡œ hold_daysëŠ” ë³´ìœ  ìº”ë“¤(ë¶„) ê°¯ìˆ˜ê°€ ë©ë‹ˆë‹¤.
                hold_mins = len(self) - entry_bar
                pnl = (sell_price - entry_price) * buy_size
                profit_pct = ((sell_price - entry_price) / entry_price) * 100
                max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100

                self.trades_history.append({
                    'open_date': open_date,
                    'open_time': open_time,
                    'date': current_date,
                    'close_time': current_time,
                    'hold_mins': hold_mins,
                    'profit_pct': profit_pct,
                    'max_profit_pct': max_profit_pct,
                    'pnl': pnl,
                    'is_win': pnl > 0,
                    'entry_price': entry_price,
                    'exit_price': sell_price,
                    'entry_rsi': entry_rsi,
                    'entry_atr': entry_atr,
                    'entry_adx': entry_adx,
                    'entry_bandwidth': entry_bandwidth,
                    'entry_surge': entry_surge,  # [ì¶”ê°€] ë§¤ìˆ˜ ì‹œ ëŒíŒŒìƒìŠ¹ë¥  ê¸°ë¡
                    'size': buy_size,
                    'status': 'Closed',
                    'buy_reason': buy_reason,
                    'sell_reason': sell_reason
                })
                self.my_position = None
                self.peak_price = 0
                return

        # ----------------------------------------------------------------------
        # [2] ë¯¸ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ìˆ˜(ì§„ì…) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position is None:
            # [ì¡°ê±´ A] ë¶„ë´‰ ìº” ë‹¨ì¼ ê¸‰ë“± ë° í™•ì‹¤í•œ ì–‘ë´‰(Close > Open)
            surge_pct = (self.data.close[0] / self.data.open[0]) - 1
            if surge_pct < self.p.target_pct: return
            if self.data.close[0] <= self.data.open[0]: return

            # [ì¡°ê±´ B] ê±°ë˜ëŸ‰ í­ì¦: ì§ì „ Në´‰ í‰ê·  ê±°ë˜ëŸ‰ ëŒ€ë¹„ Më°° ì´ìƒ
            if self.data.volume[0] < self.vol_sma[-1] * self.p.vol_surge: return

            # [ì¡°ê±´ C] ì¶”ì„¸ í•„í„°: ë‹¨ê¸°ì„ ì´ ì¤‘ê¸°ì„  ìœ„ì— ìˆëŠ” ì •ë°°ì—´ ìƒíƒœ
            if self.ma_trend_fast_line[0] <= self.ma_trend_slow_line[0]: return

            # [ì¡°ê±´ D] HTS êµ¬í˜„ìš© VWAP ëŒ€ì²´: ê¸´ ì¶”ì„¸ ì´í‰ì„  ìœ„ì— ìœ„ì¹˜í•˜ì—¬ í•˜ë½ì¥ íœ©ì˜ ë°©ì§€
            if self.data.close[0] <= self.ma_vwap_proxy_line[0]: return

            # --- [ì¶”í›„ ì ìš©ìš© ë³´ì¡°ì§€í‘œ ì¡°ê±´ ì£¼ì„ ì²˜ë¦¬] ---
            # ë°´ë“œí­ í•„í„°
            top = self.bband.lines.top[-1]
            bot = self.bband.lines.bot[-1]
            mid = self.bband.lines.mid[-1]
            if mid == 0: return
            bandwidth = (top - bot) / mid
            # if bandwidth > 0.03: return # ì˜ˆ: 3% ì´ˆê³¼ì‹œ ì§„ì… ê¸ˆì§€ (ë„ˆë¬´ ë„“ì–´ì§)

            # RSI, ADX, ATR í•„í„°
            # if self.data.rsi[-1] >= 80 or self.data.rsi[-1] <= 50: return
            # if not (60 <= self.adx[-1] <= 80): return
            # atr_pct = (self.atr[-1] / self.data.close[0] * 100) if self.data.close[0] > 0 else 0
            # if not (0.2 < atr_pct < 1.0): return
            # -----------------------------------------------

            buy_price = self.data.close[0] # ì¡°ê±´ì„ ë§Œì¡±í•œ í•´ë‹¹ ë¶„ë´‰ì˜ ì¢…ê°€ì— ì¦‰ì‹œ ì²´ê²° ê°€ì •

            cash = 10000000
            size = math.floor(cash / buy_price)

            buy_reason = f"1ë¶„ë´‰ ìˆ˜ê¸‰/{self.p.ma_vwap_proxy}ì„  ëŒíŒŒ"
            self.my_position = {
                'price': buy_price,
                'date': current_date,
                'time': current_time,
                'size': size,
                'reason': buy_reason,
                'rsi': self.data.rsi[-1],
                'atr': self.atr[-1],
                'adx': self.adx[-1],
                'bandwidth': bandwidth,
                'surge_pct': surge_pct,  # [ì¶”ê°€] ë§¤ìˆ˜ ì‹œ í•´ë‹¹ ë´‰ì˜ ì‹œê°€ ëŒ€ë¹„ ì¢…ê°€ ìƒìŠ¹ë¥  ì €ì¥
                'entry_bar': len(self)
            }
            self.peak_price = buy_price

    def stop(self):
        # ë§ˆì§€ë§‰ ìº”ë“¤ ê°•ì œ ì²­ì‚° ë¡œì§
        if self.my_position:
            current_date = self.data.datetime.date(0)
            current_time = self.data.datetime.time(0)
            current_price = self.data.close[0]
            entry_price = self.my_position['price']
            buy_size = self.my_position['size']

            if current_price > self.peak_price:
                self.peak_price = current_price

            pnl = (current_price - entry_price) * buy_size
            profit_pct = ((current_price - entry_price) / entry_price) * 100
            max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100
            entry_rsi = self.my_position.get('rsi', 0)
            entry_atr = self.my_position.get('atr', 0)
            entry_adx = self.my_position.get('adx', 0)
            entry_bandwidth = self.my_position.get('bandwidth', 0)
            entry_surge = self.my_position.get('surge_pct', 0)  # [ì¶”ê°€] ë§¤ìˆ˜ ì‹œ ëŒíŒŒìƒìŠ¹ë¥  ì „ë‹¬
            entry_bar = self.my_position.get('entry_bar', len(self))
            hold_mins = len(self) - entry_bar

            self.trades_history.append({
                'open_date': self.my_position['date'],
                'open_time': self.my_position['time'],
                'date': current_date,
                'close_time': current_time,
                'hold_mins': hold_mins,
                'profit_pct': profit_pct,
                'max_profit_pct': max_profit_pct,
                'pnl': pnl,
                'is_win': pnl > 0,
                'entry_price': entry_price,
                'exit_price': current_price,
                'entry_rsi': entry_rsi,
                'entry_atr': entry_atr,
                'entry_adx': entry_adx,
                'entry_bandwidth': entry_bandwidth,
                'entry_surge': entry_surge,  # [ì¶”ê°€] ë§¤ìˆ˜ ì‹œ ëŒíŒŒìƒìŠ¹ë¥  ê¸°ë¡
                'size': buy_size,
                'status': 'Holding',
                'buy_reason': 'ì¢…ë£Œ ì²­ì‚°',
                'sell_reason': 'ì¢…ë£Œ ì²­ì‚°'
            })


# ==========================================
# ì‹¤í–‰ í•¨ìˆ˜ (ë‹¨ì¼ êµ¬ê°„)
# ==========================================
def run_single_backtest(file_path, is_first_run=False):
    try:
        df = pd.read_excel(file_path)
        df.columns = [c.strip() for c in df.columns]

        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date', 'ì²´ê²°ì‹œê°„': 'Date'}
        df = df.rename(columns=rename_map)

        if 'Date' in df.columns:
            if pd.api.types.is_numeric_dtype(df['Date']):
                df['Date'] = df['Date'].astype(str)
            df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            if not isinstance(df.index, pd.DatetimeIndex):
                return None

        # ë¶„ë´‰ í…ŒìŠ¤íŠ¸ì´ë¯€ë¡œ ê¸°ê°„ í•„í„° ì ìš© ê°€ëŠ¥
        df = df[df.index >= '2025-01-01']

        cols_to_numeric = ['Close', 'Open', 'High', 'Low', 'Volume']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()
            else:
                return None

        df = df.dropna(subset=[c for c in cols_to_numeric if c in df.columns])

        if len(df) >= 14:
            df['rsi'] = calculate_rsi(df['Close'], period=14)
            df['rsi'] = df['rsi'].fillna(50)
        else:
            df['rsi'] = 50

        # [ë™ì  ê³„ì‚°] ì „ì—­ íŒŒë¼ë¯¸í„° ì„¤ì •ê°’ì— ë§ì¶° í•„ìš”í•œ ìµœì†Œ ë°ì´í„° ìˆ˜ëŸ‰ ê³„ì‚°
        p = dict(STRATEGY_PARAMS)
        req_len = max(p['ma_vwap_proxy'] + 1, p['boll_period'] + 2, p['vol_period'] + 1, p['ma_trend_slow'] + 1, p['ma_slow'] + 2)
        if len(df) < req_len:
            return None

        cerebro = bt.Cerebro(runonce=False)
        cerebro.broker.setcash(100000000)

        # íŒŒë¼ë¯¸í„°ëŠ” Strategy í´ë˜ìŠ¤ ë‚´ë¶€ì— ì •ì˜ëœ ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ìœ„ì„
        cerebro.addstrategy(CustomDailyStrategy, debug=is_first_run)

        cerebro.adddata(CustomPandasData(dataname=df))

        strats = cerebro.run()
        trades_hist = strats[0].trades_history

        return {
            'trades': len(trades_hist),
            'wins': sum(1 for t in trades_hist if t['is_win']),
            'total_profit': sum(t['pnl'] for t in trades_hist),
            'history': trades_hist
        }

    except Exception as e:
        if is_first_run: print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        return None


def main():
    print(CustomDailyStrategy.__doc__)
    p = dict(STRATEGY_PARAMS)
    
    # ì¶œë ¥ í…ìŠ¤íŠ¸ë“¤ë„ íŒŒë¼ë¯¸í„° ê°’ì„ ê·¸ëŒ€ë¡œ ì½ì–´ì™€ì„œ í‘œì‹œí•˜ë„ë¡ ì—°ë™
    print("=== ğŸ¯ [1ë¶„ë´‰ ì´ˆë‹¨íƒ€ ì „ëµ] ê°œë³„ ê²Œì„ë³„ ìƒì„¸ ì„±ê³¼ ë¦¬í¬íŠ¸ ===")
    print(f"ğŸ“Œ ì„¤ì •: {p['target_pct']*100:.1f}% ê¸‰ë“±ì–‘ë´‰, ê±°ë˜ëŸ‰ {int(p['vol_surge']*100)}% í­ì¦, {p['ma_trend_fast']}>{p['ma_trend_slow']}ì„  ì •ë°°ì—´, {p['ma_vwap_proxy']}ì„  ì´í‰ ìƒíšŒ")
    print(f"ğŸ“Œ ì²­ì‚°: {p['ma_fast']}ì„ /{p['ma_slow']}ì„  ë°ë“œí¬ë¡œìŠ¤ ì´íƒˆ ì‹œ ì¦‰ì‹œ ë§¤ë„")
    print("ğŸ“Œ ê¸°ê°„: 2025-01-01 ~ í˜„ì¬")

    data_dir = ("stock_data_min")
    if not os.path.exists(data_dir):
        print(f"ğŸš¨ '{data_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤! 1ë¶„ë´‰ ë°ì´í„°ë¥¼ í´ë” ì•ˆì— ë„£ì–´ì£¼ì„¸ìš”.")
        return

    files = [os.path.join(data_dir, f) for f in os.listdir(data_dir) if f.endswith(".xlsx")]
    print(f"ğŸ“‚ ë¶„ì„ ëŒ€ìƒ: {len(files)}ê°œ ì¢…ëª©\n")

    print(f"\nğŸ“Š [ì „ì²´ ê±°ë˜ ë‚´ì—­ ìƒì„¸]")
    # [ìˆ˜ì •] í‘œ ì»¬ëŸ¼ì— 'ëŒíŒŒìƒìŠ¹ë¥ ' ì¶”ê°€
    header_1 = f"{lpad('ì¢…ëª©ëª…', 14)} | {lpad('ë§¤ìˆ˜ì¼', 10)} | {lpad('ë§¤ìˆ˜ì‹œê°„', 8)} | {lpad('ë§¤ë„ì‹œê°„', 8)} | {rpad('ë³´ìœ (ë¶„)', 8)} | {rpad('ë§¤ìˆ˜ê°€', 10)} | {rpad('ë§¤ë„ê°€', 10)} | {rpad('ëŒíŒŒìƒìŠ¹ë¥ ', 11)} | {rpad('ìˆ˜ìµë¥ ', 9)} | {rpad('ìµœëŒ€ìˆ˜ìµ', 9)} | {rpad('RSI', 6)} | {rpad('ATR(%)', 7)} | {rpad('ADX', 6)} | {rpad('ë°´ë“œí­(%)', 10)}"
    print("=" * calc_width(header_1))
    print(header_1)
    print("-" * calc_width(header_1))

    total_stats = {'trades': 0, 'profit': 0, 'wins': 0, 'slippage': 0, 'hold_mins': 0, 'gross_profit': 0, 'gross_loss': 0}
    all_history = []

    daily_buys = defaultdict(int)
    monthly_daily_buys = defaultdict(lambda: defaultdict(int))
    yearly_daily_buys = defaultdict(lambda: defaultdict(int))

    rsi_stats = {
        '50 ì´í•˜': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '50ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '60ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '70ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '80ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '90ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
    }

    atr_stats = {
        '2% ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '2%~4%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '4%~6%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '6%~8%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '8% ì´ìƒ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
    }

    adx_stats = {
        '20 ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '20~40': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '40~60': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '60~80': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '80 ì´ìƒ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
    }

    bw_stats = {
        '1% ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '1~1.5%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '1.5~2%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '2~2.5%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '2.5~3%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '3% ì´ìƒ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
    }

    # ë§¤ìˆ˜ì‹œê°„ëŒ€ë³„ ì§‘ê³„
    time_stats = {
        '09:05 ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '09:05~09:30': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '09:30~12:00': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '12:00~15:00': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '15:00 ì´í›„': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
    }

    # [ì¶”ê°€] ëŒíŒŒìƒìŠ¹ë¥ ë³„ ì§‘ê³„ (0.5% ë‹¨ìœ„)
    surge_stats = {
        '1.5% ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '1.5~2.0%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '2.0~2.5%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '2.5~3.0%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '3.0~3.5%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
        '3.5% ì´ìƒ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0},
    }

    monthly_stats = defaultdict(lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'hold_mins': 0, 'gross_profit': 0, 'gross_loss': 0})
    yearly_stats = defaultdict(lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'hold_mins': 0, 'gross_profit': 0, 'gross_loss': 0})

    for idx, file_path in enumerate(files):
        stock_name = os.path.basename(file_path).split('_')[-1].replace('.xlsx', '')
        is_first = (idx == 0)
        res = run_single_backtest(file_path, is_first_run=is_first)

        if res and res['trades'] > 0:
            total_stats['trades'] += res['trades']
            total_stats['profit'] += res['total_profit']
            total_stats['wins'] += res['wins']

            for t in res['history']:
                t['stock_name'] = stock_name
                t['file_path'] = file_path  # ì°¨íŠ¸ ê·¸ë¦¬ê¸°ìš© íŒŒì¼ ê²½ë¡œ ì €ì¥
                all_history.append(t)

                close_date_str = t['date'] if isinstance(t['date'], str) else t['date'].strftime('%Y-%m-%d')
                open_date_str = t['open_date'] if isinstance(t['open_date'], str) else t['open_date'].strftime('%Y-%m-%d')

                open_time_str = t['open_time'] if isinstance(t['open_time'], str) else t['open_time'].strftime('%H:%M')
                close_time_str = t['close_time'] if isinstance(t['close_time'], str) else t['close_time'].strftime('%H:%M')

                hold_mins = t.get('hold_mins', 0)
                total_stats['hold_mins'] += hold_mins
                daily_buys[open_date_str] += 1

                profit_pct = t['profit_pct']
                max_profit_pct = t.get('max_profit_pct', 0.0)
                entry_price = t['entry_price']
                exit_price = t['exit_price']
                rsi_val = t.get('entry_rsi', 0)
                atr_raw = t.get('entry_atr', 0)
                atr_val = (atr_raw / entry_price * 100) if entry_price > 0 else 0
                adx_val = t.get('entry_adx', 0)
                
                # [ì¶”ê°€] ëŒíŒŒìƒìŠ¹ë¥  ì¶”ì¶œ
                surge_raw = t.get('entry_surge', 0)
                surge_pct_val = surge_raw * 100

                bw_raw = t.get('entry_bandwidth', 0)
                bw_pct = bw_raw * 100

                buy_size = t.get('size', 0)
                slippage_cost = entry_price * buy_size * p['slippage_pct']

                total_stats['slippage'] += slippage_cost

                t_gross_profit = t['pnl'] if t['pnl'] > 0 else 0
                t_gross_loss = abs(t['pnl']) if t['pnl'] <= 0 else 0
                total_stats['gross_profit'] += t_gross_profit
                total_stats['gross_loss'] += t_gross_loss

                # RSI ì§‘ê³„
                bucket = ""
                if rsi_val <= 50: bucket = '50 ì´í•˜'
                elif rsi_val < 60: bucket = '50ëŒ€'
                elif rsi_val < 70: bucket = '60ëŒ€'
                elif rsi_val < 80: bucket = '70ëŒ€'
                elif rsi_val < 90: bucket = '80ëŒ€'
                else: bucket = '90ëŒ€'
                if bucket:
                    rsi_stats[bucket]['games'] += 1
                    rsi_stats[bucket]['profit'] += t['pnl']
                    rsi_stats[bucket]['slippage'] += slippage_cost
                    rsi_stats[bucket]['gross_profit'] += t_gross_profit
                    rsi_stats[bucket]['gross_loss'] += t_gross_loss
                    if t['is_win']: rsi_stats[bucket]['wins'] += 1

                # ATR ì§‘ê³„
                a_bucket = ""
                if atr_val < 2: a_bucket = '2% ë¯¸ë§Œ'
                elif atr_val < 4: a_bucket = '2%~4%'
                elif atr_val < 6: a_bucket = '4%~6%'
                elif atr_val < 8: a_bucket = '6%~8%'
                else: a_bucket = '8% ì´ìƒ'
                atr_stats[a_bucket]['games'] += 1
                atr_stats[a_bucket]['profit'] += t['pnl']
                atr_stats[a_bucket]['slippage'] += slippage_cost
                atr_stats[a_bucket]['gross_profit'] += t_gross_profit
                atr_stats[a_bucket]['gross_loss'] += t_gross_loss
                if t['is_win']: atr_stats[a_bucket]['wins'] += 1

                # ADX ì§‘ê³„
                dx_bucket = ""
                if adx_val < 20: dx_bucket = '20 ë¯¸ë§Œ'
                elif adx_val < 40: dx_bucket = '20~40'
                elif adx_val < 60: dx_bucket = '40~60'
                elif adx_val < 80: dx_bucket = '60~80'
                else: dx_bucket = '80 ì´ìƒ'
                adx_stats[dx_bucket]['games'] += 1
                adx_stats[dx_bucket]['profit'] += t['pnl']
                adx_stats[dx_bucket]['slippage'] += slippage_cost
                adx_stats[dx_bucket]['gross_profit'] += t_gross_profit
                adx_stats[dx_bucket]['gross_loss'] += t_gross_loss
                if t['is_win']: adx_stats[dx_bucket]['wins'] += 1

                # ë°´ë“œí­ ì§‘ê³„ (0.5% ë‹¨ìœ„)
                b_bucket = ""
                if bw_pct < 1.0: b_bucket = '1% ë¯¸ë§Œ'
                elif bw_pct < 1.5: b_bucket = '1~1.5%'
                elif bw_pct < 2.0: b_bucket = '1.5~2%'
                elif bw_pct < 2.5: b_bucket = '2~2.5%'
                elif bw_pct < 3.0: b_bucket = '2.5~3%'
                else: b_bucket = '3% ì´ìƒ'
                
                bw_stats[b_bucket]['games'] += 1
                bw_stats[b_bucket]['profit'] += t['pnl']
                bw_stats[b_bucket]['slippage'] += slippage_cost
                bw_stats[b_bucket]['gross_profit'] += t_gross_profit
                bw_stats[b_bucket]['gross_loss'] += t_gross_loss
                if t['is_win']: bw_stats[b_bucket]['wins'] += 1

                # ë§¤ìˆ˜ì‹œê°„ëŒ€ë³„ ì§‘ê³„
                try:
                    time_parts = open_time_str.split(':')
                    h, m = int(time_parts[0]), int(time_parts[1])
                    total_mins = h * 60 + m
                    t_bucket = ""
                    if total_mins < 9 * 60 + 5: t_bucket = '09:05 ë¯¸ë§Œ'
                    elif total_mins < 9 * 60 + 30: t_bucket = '09:05~09:30'
                    elif total_mins < 12 * 60: t_bucket = '09:30~12:00'
                    elif total_mins < 15 * 60: t_bucket = '12:00~15:00'
                    else: t_bucket = '15:00 ì´í›„'
                    
                    time_stats[t_bucket]['games'] += 1
                    time_stats[t_bucket]['profit'] += t['pnl']
                    time_stats[t_bucket]['slippage'] += slippage_cost
                    time_stats[t_bucket]['gross_profit'] += t_gross_profit
                    time_stats[t_bucket]['gross_loss'] += t_gross_loss
                    if t['is_win']: time_stats[t_bucket]['wins'] += 1
                except Exception:
                    pass

                # [ì¶”ê°€] ëŒíŒŒìƒìŠ¹ë¥  êµ¬ê°„ë³„ ì§‘ê³„ (0.5% ë‹¨ìœ„)
                s_bucket = ""
                if surge_pct_val < 1.5: s_bucket = '1.5% ë¯¸ë§Œ'
                elif surge_pct_val < 2.0: s_bucket = '1.5~2.0%'
                elif surge_pct_val < 2.5: s_bucket = '2.0~2.5%'
                elif surge_pct_val < 3.0: s_bucket = '2.5~3.0%'
                elif surge_pct_val < 3.5: s_bucket = '3.0~3.5%'
                else: s_bucket = '3.5% ì´ìƒ'
                
                surge_stats[s_bucket]['games'] += 1
                surge_stats[s_bucket]['profit'] += t['pnl']
                surge_stats[s_bucket]['slippage'] += slippage_cost
                surge_stats[s_bucket]['gross_profit'] += t_gross_profit
                surge_stats[s_bucket]['gross_loss'] += t_gross_loss
                if t['is_win']: surge_stats[s_bucket]['wins'] += 1

                # ì›”ë³„/ë…„ë„ë³„ ì§‘ê³„
                dt_obj = t['open_date'] if not isinstance(t['open_date'], str) else pd.to_datetime(t['open_date'])
                ym = dt_obj.strftime('%Y-%m')
                y = dt_obj.strftime('%Y')

                monthly_daily_buys[ym][open_date_str] += 1
                yearly_daily_buys[y][open_date_str] += 1

                monthly_stats[ym]['games'] += 1
                monthly_stats[ym]['profit'] += t['pnl']
                monthly_stats[ym]['slippage'] += slippage_cost
                monthly_stats[ym]['hold_mins'] += hold_mins
                monthly_stats[ym]['gross_profit'] += t_gross_profit
                monthly_stats[ym]['gross_loss'] += t_gross_loss
                if t['is_win']: monthly_stats[ym]['wins'] += 1

                yearly_stats[y]['games'] += 1
                yearly_stats[y]['profit'] += t['pnl']
                yearly_stats[y]['slippage'] += slippage_cost
                yearly_stats[y]['hold_mins'] += hold_mins
                yearly_stats[y]['gross_profit'] += t_gross_profit
                yearly_stats[y]['gross_loss'] += t_gross_loss
                if t['is_win']: yearly_stats[y]['wins'] += 1

                mark = "ğŸ”´" if profit_pct > 0 else "ğŸ”µ"
                hold_str = f"{hold_mins}ë¶„"
                ep_str = f"{entry_price:,.0f}"
                xp_str = f"{exit_price:,.0f}"
                surge_str = f"{surge_pct_val:.2f}%"  # [ì¶”ê°€] í¬ë§·íŒ…
                pct_str = f"{profit_pct:.2f}%"
                max_pct_str = f"{max_profit_pct:.2f}%"
                atr_str = f"{atr_val:.2f}%"
                bw_str = f"{bw_pct:.2f}%"

                # í•œê¸€ í­ ê³ ë ¤í•œ ì»¤ìŠ¤í…€ ì¶œë ¥ (ëŒíŒŒìƒìŠ¹ë¥  ì»¬ëŸ¼ ì¶”ê°€ ë°˜ì˜)
                row_str = f"{lpad(stock_name, 14)} | {lpad(open_date_str, 10)} | {lpad(open_time_str, 8)} | {lpad(close_time_str, 8)} | {rpad(hold_str, 8)} | {rpad(ep_str, 10)} | {rpad(xp_str, 10)} | {rpad(surge_str, 11)} | {rpad(pct_str, 9)} | {rpad(max_pct_str, 9)} | {rpad(f'{rsi_val:.1f}', 6)} | {rpad(atr_str, 7)} | {rpad(f'{adx_val:.1f}', 6)} | {rpad(bw_str, 10)}"
                print(f"{row_str} {mark}")

    print("=" * calc_width(header_1))

    avg_win_rate = (total_stats['wins'] / total_stats['trades'] * 100) if total_stats['trades'] > 0 else 0
    total_virtual_profit = total_stats['profit'] - total_stats['slippage']
    total_loss_ratio = (total_stats['slippage'] / abs(total_stats['profit']) * 100) if total_stats['profit'] != 0 else 0
    
    total_gross_loss_with_slippage = total_stats['gross_loss'] + total_stats['slippage']
    total_loss_profit_ratio = (total_gross_loss_with_slippage / total_stats['gross_profit'] * 100) if total_stats['gross_profit'] > 0 else 0
    
    avg_hold_mins = (total_stats['hold_mins'] / total_stats['trades']) if total_stats['trades'] > 0 else 0
    avg_daily_buys = (total_stats['trades'] / len(daily_buys)) if daily_buys else 0

    avg_1hit_rtn = ((total_virtual_profit / total_stats['trades']) / 10000000 * 100) if total_stats['trades'] > 0 else 0
    
    # ë°ì´íŠ¸ë ˆì´ë”© ê¸°ì¤€(í•˜ë£¨ ì¥ 390ë¶„)ìœ¼ë¡œ 1ë‹¬(20ì¼) íšŒì „ìœ¨ì„ ì¬ì¡°ì •
    turnover_rate = ((390 / avg_hold_mins) * 20) if avg_hold_mins > 0 else 0
    expected_games = turnover_rate * 10
    expected_10slot_rtn = expected_games * avg_1hit_rtn

    print(
        f"\nğŸ“ˆ [ì „ì²´ ìš”ì•½] ì´ ë§¤ë§¤ íšŸìˆ˜: {total_stats['trades']}íšŒ, í‰ê·  ìŠ¹ë¥ : {avg_win_rate:.2f}%, "
        f"í‰ê·  ë³´ìœ ê¸°ê°„: {avg_hold_mins:.1f}ë¶„, ì¼í‰ê·  í¬ì°©: {avg_daily_buys:.1f}ê°œ\n"
        f"ì´ ìˆ˜ìµê¸ˆ: {total_stats['profit']:,.0f}ì› | "
        f"ê°€ìƒìˆ˜ìµê¸ˆ({p['slippage_pct']*100:.1f}%ìŠ¬ë¦¬í”¼ì§€): {total_virtual_profit:,.0f}ì› | "
        f"ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨: {total_loss_ratio:.2f}% | ì†ì‹¤/ìˆ˜ìµë¹„: {total_loss_profit_ratio:.2f}%\n"
        f"ğŸ’¡ [ì˜ˆìƒ ì„±ê³¼(ì›”ê¸°ì¤€)] 1íƒ€í‰ê· ìˆ˜ìµë¥ : {avg_1hit_rtn:.2f}% | íšŒì „ë¥ : {turnover_rate:.2f}íšŒ | "
        f"ì˜ˆìƒê²Œì„ìˆ˜: {expected_games:.1f}ë²ˆ | 10ìŠ¬ë¡¯ë‹¹ìˆ˜ìµë¥ : {expected_10slot_rtn:.2f}%"
    )

    # RSI ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [RSI êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    header_rsi = f"{lpad('RSI êµ¬ê°„', 14)} | {rpad('ê²Œì„ìˆ˜', 10)} | {rpad('ìŠ¹ë¥ ', 10)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)}"
    print("=" * calc_width(header_rsi))
    print(header_rsi)
    print("-" * calc_width(header_rsi))
    for bucket in ['50 ì´í•˜', '50ëŒ€', '60ëŒ€', '70ëŒ€', '80ëŒ€', '90ëŒ€']:
        s = rsi_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        print(f"{lpad(bucket, 14)} | {rpad(games_str, 10)} | {rpad(win_str, 10)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)}")

    # ATR ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ATR(%) êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    header_atr = f"{lpad('ATR(%) êµ¬ê°„', 14)} | {rpad('ê²Œì„ìˆ˜', 10)} | {rpad('ìŠ¹ë¥ ', 10)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)}"
    print("=" * calc_width(header_atr))
    print(header_atr)
    print("-" * calc_width(header_atr))
    for bucket in ['2% ë¯¸ë§Œ', '2%~4%', '4%~6%', '6%~8%', '8% ì´ìƒ']:
        s = atr_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        print(f"{lpad(bucket, 14)} | {rpad(games_str, 10)} | {rpad(win_str, 10)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)}")

    # ADX ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ADX êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    header_adx = f"{lpad('ADX êµ¬ê°„', 14)} | {rpad('ê²Œì„ìˆ˜', 10)} | {rpad('ìŠ¹ë¥ ', 10)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)}"
    print("=" * calc_width(header_adx))
    print(header_adx)
    print("-" * calc_width(header_adx))
    for bucket in ['20 ë¯¸ë§Œ', '20~40', '40~60', '60~80', '80 ì´ìƒ']:
        s = adx_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        print(f"{lpad(bucket, 14)} | {rpad(games_str, 10)} | {rpad(win_str, 10)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)}")

    # ë°´ë“œí­ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ì „ì¼ê¸°ì¤€ ë°´ë“œí­(%) êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    header_bw = f"{lpad('ë°´ë“œí­ êµ¬ê°„', 14)} | {rpad('ê²Œì„ìˆ˜', 10)} | {rpad('ìŠ¹ë¥ ', 10)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)}"
    print("=" * calc_width(header_bw))
    print(header_bw)
    print("-" * calc_width(header_bw))
    for bucket in ['1% ë¯¸ë§Œ', '1~1.5%', '1.5~2%', '2~2.5%', '2.5~3%', '3% ì´ìƒ']:
        s = bw_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        print(f"{lpad(bucket, 14)} | {rpad(games_str, 10)} | {rpad(win_str, 10)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)}")

    # ë§¤ìˆ˜ì‹œê°„ëŒ€ë³„ ì„±ê³¼ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ë§¤ìˆ˜ì‹œê°„ëŒ€ë³„ ì„±ê³¼ ë¶„ì„]")
    header_time = f"{lpad('ë§¤ìˆ˜ì‹œê°„ëŒ€', 14)} | {rpad('ê²Œì„ìˆ˜', 10)} | {rpad('ìŠ¹ë¥ ', 10)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)}"
    print("=" * calc_width(header_time))
    print(header_time)
    print("-" * calc_width(header_time))
    for bucket in ['09:05 ë¯¸ë§Œ', '09:05~09:30', '09:30~12:00', '12:00~15:00', '15:00 ì´í›„']:
        s = time_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        print(f"{lpad(bucket, 14)} | {rpad(games_str, 10)} | {rpad(win_str, 10)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)}")

    # [ì¶”ê°€] ëŒíŒŒìƒìŠ¹ë¥  ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ì§„ì… ì‹œì  ëŒíŒŒìƒìŠ¹ë¥  êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    header_surge = f"{lpad('ëŒíŒŒìƒìŠ¹ë¥  êµ¬ê°„', 16)} | {rpad('ê²Œì„ìˆ˜', 10)} | {rpad('ìŠ¹ë¥ ', 10)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)}"
    print("=" * calc_width(header_surge))
    print(header_surge)
    print("-" * calc_width(header_surge))
    for bucket in ['1.5% ë¯¸ë§Œ', '1.5~2.0%', '2.0~2.5%', '2.5~3.0%', '3.0~3.5%', '3.5% ì´ìƒ']:
        s = surge_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        print(f"{lpad(bucket, 16)} | {rpad(games_str, 10)} | {rpad(win_str, 10)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)}")

    # ì›”ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ì›”ë³„ ì„±ê³¼ ë¶„ì„]")
    header_monthly = f"{lpad('ì›” (Month)', 10)} | {rpad('ê²Œì„ìˆ˜', 7)} | {rpad('ë§¤ìˆ˜ì¢…ëª©ìˆ˜í‰ê· ', 14)} | {rpad('í‰ê· ë³´ìœ ê¸°ê°„', 12)} | {rpad('ìŠ¹ë¥ ', 9)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)} | {rpad('1íƒ€ìˆ˜ìµë¥ ', 10)} | {rpad('íšŒì „ë¥ ', 8)} | {rpad('ì˜ˆìƒê²Œì„ìˆ˜', 10)} | {rpad('10ìŠ¬ë¡¯ìˆ˜ìµë¥ ', 14)}"
    print("=" * calc_width(header_monthly))
    print(header_monthly)
    print("-" * calc_width(header_monthly))
    for ym in sorted(monthly_stats.keys()):
        s = monthly_stats[ym]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        avg_monthly_buys = s['games'] / len(monthly_daily_buys[ym]) if monthly_daily_buys[ym] else 0

        # ë¶„ë´‰ ì „ìš© ì›”ë³„ ê¸°ëŒ€ìˆ˜ìµ ê³„ì‚°
        m_avg_hold = s['hold_mins'] / s['games'] if s['games'] > 0 else 0
        m_1hit_rtn = ((virtual_profit / s['games']) / 10000000 * 100) if s['games'] > 0 else 0
        m_turnover = ((390 / m_avg_hold) * 20) if m_avg_hold > 0 else 0
        m_exp_games = m_turnover * 10
        m_10slot_rtn = m_exp_games * m_1hit_rtn
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        buys_str = f"{avg_monthly_buys:.1f}ê°œ"
        hold_str = f"{m_avg_hold:.1f}ë¶„"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        hit_str = f"{m_1hit_rtn:.2f}%"
        turn_str = f"{m_turnover:.2f}"
        exp_str = f"{m_exp_games:.1f}ë²ˆ"
        slot_str = f"{m_10slot_rtn:.2f}%"

        print(f"{lpad(ym, 10)} | {rpad(games_str, 7)} | {rpad(buys_str, 14)} | {rpad(hold_str, 12)} | {rpad(win_str, 9)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)} | {rpad(hit_str, 10)} | {rpad(turn_str, 8)} | {rpad(exp_str, 10)} | {rpad(slot_str, 14)}")

    # ë…„ë„ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ë…„ë„ë³„ ì„±ê³¼ ë¶„ì„]")
    header_yearly = f"{lpad('ë…„ë„ (Year)', 11)} | {rpad('ê²Œì„ìˆ˜', 7)} | {rpad('ë§¤ìˆ˜ì¢…ëª©ìˆ˜í‰ê· ', 14)} | {rpad('í‰ê· ë³´ìœ ê¸°ê°„', 12)} | {rpad('ìŠ¹ë¥ ', 9)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)} | {rpad('1íƒ€ìˆ˜ìµë¥ ', 10)} | {rpad('íšŒì „ë¥ (ë…„)', 10)} | {rpad('ì˜ˆìƒê²Œì„ìˆ˜', 10)} | {rpad('10ìŠ¬ë¡¯ìˆ˜ìµë¥ ', 14)}"
    print("=" * calc_width(header_yearly))
    print(header_yearly)
    print("-" * calc_width(header_yearly))
    for y in sorted(yearly_stats.keys()):
        s = yearly_stats[y]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        avg_yearly_buys = s['games'] / len(yearly_daily_buys[y]) if yearly_daily_buys[y] else 0

        # ë¶„ë´‰ ì „ìš© ì—°ë„ë³„ ê¸°ëŒ€ìˆ˜ìµ ê³„ì‚°
        y_avg_hold = s['hold_mins'] / s['games'] if s['games'] > 0 else 0
        y_1hit_rtn = ((virtual_profit / s['games']) / 10000000 * 100) if s['games'] > 0 else 0
        y_turnover = ((390 / y_avg_hold) * 240) if y_avg_hold > 0 else 0
        y_exp_games = y_turnover * 10
        y_10slot_rtn = y_exp_games * y_1hit_rtn
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        buys_str = f"{avg_yearly_buys:.1f}ê°œ"
        hold_str = f"{y_avg_hold:.1f}ë¶„"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        hit_str = f"{y_1hit_rtn:.2f}%"
        turn_str = f"{y_turnover:.2f}"
        exp_str = f"{y_exp_games:.1f}ë²ˆ"
        slot_str = f"{y_10slot_rtn:.2f}%"

        print(f"{lpad(y, 11)} | {rpad(games_str, 7)} | {rpad(buys_str, 14)} | {rpad(hold_str, 12)} | {rpad(win_str, 9)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)} | {rpad(hit_str, 10)} | {rpad(turn_str, 10)} | {rpad(exp_str, 10)} | {rpad(slot_str, 14)}")
    print("=" * calc_width(header_yearly))

    # ==========================================
    # [ì¶”ê°€] ì°¨íŠ¸ ìƒì„±: ìˆ˜ìµë¥  Top 5 / Bottom 5
    # ==========================================
    if all_history:
        chart_dir = "saved_charts_min"
        if not os.path.exists(chart_dir):
            os.makedirs(chart_dir)
            
        print(f"\n\nğŸ“Š [ì°¨íŠ¸ ìƒì„± ì¤‘...] '{chart_dir}' í´ë”ì— ìˆ˜ìµë¥  Top 5 / Bottom 5 ì°¨íŠ¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.")
        
        # ìˆ˜ìµë¥  ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        sorted_history = sorted(all_history, key=lambda x: x['profit_pct'], reverse=True)
        top_5 = sorted_history[:5]
        
        # ë°ì´í„°ê°€ 5ê°œ ì´ìƒì¼ ê²½ìš° í•˜ìœ„ 5ê°œ ì¶”ì¶œ
        bottom_5 = sorted_history[-5:] if len(sorted_history) > 5 else []

        targets = [("Top", i+1, t) for i, t in enumerate(top_5)]
        
        # Bottomì€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë’¤ì§‘ì–´ì„œ ê°€ì¥ ìˆ˜ìµë¥ ì´ ë‚®ì€ ê²ƒì´ 1ìœ„ê°€ ë˜ë„ë¡ ì²˜ë¦¬
        targets += [("Bottom", i+1, t) for i, t in enumerate(reversed(bottom_5))]
        
        for prefix, rank, t in targets:
            save_chart(t, chart_dir, prefix, rank)
            
        print("âœ… ì°¨íŠ¸ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")


if __name__ == "__main__":
    main()
