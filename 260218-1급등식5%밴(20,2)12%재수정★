# ==========================================
# ğŸ“Š [ê°œë³„ ê²Œì„ë³„ ìƒì„¸ ì„±ê³¼ ë¦¬í¬íŠ¸]
# ==========================================================================================================
# ì¢…ëª©ëª…          | ë§¤ìˆ˜ì¼       | ë§¤ë„ì¼       |     ë§¤ìˆ˜ê°€ |     ë§¤ë„ê°€ |  ìˆ˜ìµë¥  | ìµœëŒ€ìˆ˜ìµë¥ 
# ----------------------------------------------------------------------------------------------------------
# ... (ë°ì´í„° ì¶œë ¥) ...
# ==========================================================================================================
import matplotlib

# í™”ë©´ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì—ì„œ ì´ë¯¸ì§€ ìƒì„± (ì¶©ëŒ ë°©ì§€)
matplotlib.use('Agg')

import backtrader as bt
import pandas as pd
import os
import math
from datetime import time, timedelta
from collections import defaultdict
import matplotlib.pyplot as plt


# ==========================================
# [ì „ëµ] ì¼ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + ë°´ë“œí­ êµ¬ê°„ í•„í„° + ì •ë°€ ë§¤ë„
# ==========================================
class CustomDailyStrategy(bt.Strategy):
    """
    [ìƒì„¸ ì „ëµ ì„¤ëª…]
    ================================================================================
    1. ë§¤ìˆ˜ ì§„ì… ì¡°ê±´ (ëª¨ë‘ ë§Œì¡± ì‹œ) - ë‹¹ì¼ ëŒíŒŒ í™•ì¸ ì¦‰ì‹œ ì§„ì… ê°€ì •
       A. [ë³€ë™ì„± ëŒíŒŒ]
          - ì˜¤ëŠ˜ ê³ ê°€(High)ê°€ 'ì „ì¼ ì¢…ê°€ + 5%' ê°€ê²©ì„ ë„˜ì—ˆìœ¼ë©´ ëŒíŒŒë¡œ ì¸ì •.
          - ë§¤ìˆ˜ê°€ê²©: ëª©í‘œê°€(ì „ì¼ì¢…ê°€+5%)ì™€ ì‹œê°€(Open) ì¤‘ í° ê°’. (ê°­ìƒìŠ¹ ì‹œ ì‹œê°€ ë§¤ìˆ˜)
       B. [ìœ ë™ì„±] (ì˜¤ëŠ˜) ê±°ë˜ëŒ€ê¸ˆ 50ì–µ ì› ì´ìƒ.
       C. [ì¶”ì„¸] (ì˜¤ëŠ˜) ê¸°ì¤€ 3ì¼ì„  > 5ì¼ì„  ì •ë°°ì—´ ìƒíƒœ.
       D. [ìˆ˜ë ´] (ì „ì¼) ê¸°ì¤€ ë³¼ë¦°ì €ë°´ë“œ ë°´ë“œí­ì´ ì„¤ì •ëœ êµ¬ê°„ ë‚´ ìœ„ì¹˜.

    2. ë§¤ë„ ì²­ì‚° ì¡°ê±´ - ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ ì¦‰ì‹œ ì²­ì‚° ê°€ì •
       - ì˜¤ëŠ˜ ê¸°ì¤€ 3ì¼ì„ ê³¼ 5ì¼ì„ ì´ ë§Œë‚˜ëŠ” ê°€ê²©(Cross Price) ê³„ì‚°.
       - ì˜¤ëŠ˜ ì €ê°€(Low)ê°€ ì´ ê°€ê²© ì´í•˜ë¼ë©´ ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ ë°œìƒìœ¼ë¡œ ê°„ì£¼.
       - ë§¤ë„ê°€ê²©: êµì°¨ê°€ê²©(Cross Price)ê³¼ ì‹œê°€(Open) ì¤‘ ì‘ì€ ê°’. (ê°­í•˜ë½ ì‹œ ì‹œê°€ ë§¤ë„)
    ================================================================================
    """
    params = (
        ('target_pct', 0.05),  # 5%
        ('ma_fast', 3),  # 3ì¼
        ('ma_slow', 5),  # 5ì¼
        ('boll_period', 20),  # ë³¼ë¦°ì €ë°´ë“œ ê¸°ê°„
        ('boll_dev', 2.0),  # ë³¼ë¦°ì €ë°´ë“œ ìŠ¹ìˆ˜
        ('bandwidth_min', 0.12),  # ë°´ë“œí­ ìµœì†Œê°’
        ('bandwidth_max', 100.0),  # ë°´ë“œí­ ìµœëŒ€ê°’
        ('debug', False),  # ë””ë²„ê·¸ ëª¨ë“œ
    )

    def __init__(self):
        self.ma3 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_fast)
        self.ma5 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_slow)

        # ë³¼ë¦°ì €ë°´ë“œ ì§€í‘œ
        typical_price = (self.data.high + self.data.low + self.data.close) / 3.0
        self.bband = bt.indicators.BollingerBands(typical_price, period=self.p.boll_period, devfactor=self.p.boll_dev)

        # ìˆ˜ë™ í¬ì§€ì…˜ ê´€ë¦¬ìš© ë³€ìˆ˜ (Backtrader Broker ë¯¸ì‚¬ìš©)
        self.my_position = None  # None or dict {'price': ..., 'date': ..., 'size': ...}
        self.trades_history = []  # ê²°ê³¼ ì €ì¥ì†Œ

        self.buy_points = []  # ì°¨íŠ¸ìš©
        self.sell_points = []  # ì°¨íŠ¸ìš©

        self.peak_price = 0  # ë³´ìœ  ì¤‘ ìµœê³ ê°€

    def log(self, txt, dt=None):
        """ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜"""
        if self.p.debug:
            dt = dt or self.data.datetime.date(0)
            print(f'[{dt.isoformat()}] {txt}')

    def next(self):
        # ----------------------------------------------------------------------
        # ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if len(self.data) < max(self.p.ma_slow + 2, self.p.boll_period + 2):
            return

        current_date = self.data.datetime.date(0)

        # ----------------------------------------------------------------------
        # [1] ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ë„(ì²­ì‚°) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position:
            # ìµœê³ ê°€ ê°±ì‹  (í˜„ì¬ ë´‰ì˜ ê³ ê°€ ê¸°ì¤€)
            if self.data.high[0] > self.peak_price:
                self.peak_price = self.data.high[0]

            # ë°ë“œí¬ë¡œìŠ¤ ê°€ê²© ê³„ì‚° (ì˜¤ëŠ˜ ê¸°ì¤€)
            # MA3(0) < MA5(0)ê°€ ë˜ëŠ” C(0) ì°¾ê¸°
            # (C0 + C-1 + C-2)/3 < (C0 + C-1 + C-2 + C-3 + C-4)/5
            # => C0 < 1.5*(C-3 + C-4) - (C-1 + C-2)
            c_1 = self.data.close[-1]
            c_2 = self.data.close[-2]
            c_3 = self.data.close[-3]
            c_4 = self.data.close[-4]

            cross_price_raw = 1.5 * (c_3 + c_4) - (c_1 + c_2)
            cross_price = round(cross_price_raw)  # ì •ìˆ˜í™”

            sell_signal = False
            sell_price = 0
            sell_reason = ""

            # ì¡°ê±´ 1: ì´ë¯¸ ì „ì¼ ì¢…ê°€ ê¸°ì¤€ìœ¼ë¡œ ì—­ë°°ì—´ ìƒíƒœì˜€ë˜ ê²½ìš° (ì•ˆì „ì¥ì¹˜)
            if self.ma3[-1] < self.ma5[-1]:
                sell_signal = True
                sell_price = self.data.open[0]  # ì‹œê°€ ë§¤ë„
                sell_reason = (f"ğŸ“‰ [ë§¤ë„ ì‚¬ìœ ] ì „ì¼ ì´ë¯¸ ë°ë“œí¬ë¡œìŠ¤ ìƒíƒœ\n"
                               f"   - ì „ì¼ MA3({self.ma3[-1]:.0f}) < MA5({self.ma5[-1]:.0f})\n"
                               f"   - ê¸ˆì¼ ì‹œê°€({sell_price:,.0f}ì›)ì— ì¦‰ì‹œ ì²­ì‚°")

            # ì¡°ê±´ 2: ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ (ì €ê°€ê°€ êµì°¨ ê°€ê²© ì´í•˜)
            elif self.data.low[0] <= cross_price:
                sell_signal = True
                # ê°­í•˜ë½(ì‹œê°€ < êµì°¨ê°€)ì´ë©´ ì‹œê°€ ë§¤ë„, ì•„ë‹ˆë©´ êµì°¨ê°€ ë§¤ë„
                if self.data.open[0] < cross_price:
                    sell_price = self.data.open[0]
                    sell_reason = (f"ğŸ“‰ [ë§¤ë„ ì‚¬ìœ ] ê°­í•˜ë½ìœ¼ë¡œ ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ í™•ì •\n"
                                   f"   - êµì°¨ ì„ê³„ê°€: {cross_price:,.0f}ì›\n"
                                   f"   - ì‹œê°€({sell_price:,.0f}ì›)ê°€ ì´ë¯¸ ì„ê³„ê°€ë¥¼ í•˜íšŒí•˜ì—¬ ì‹œê°€ ì²­ì‚°")
                else:
                    sell_price = cross_price
                    sell_reason = (f"ğŸ“‰ [ë§¤ë„ ì‚¬ìœ ] ì¥ì¤‘ 3ì¼/5ì¼ì„  ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ\n"
                                   f"   - êµì°¨ ì„ê³„ê°€: {cross_price:,.0f}ì›\n"
                                   f"   - ì¥ì¤‘ ì €ê°€({self.data.low[0]:,.0f}ì›)ê°€ ì„ê³„ê°€ í„°ì¹˜")

            if sell_signal:
                # ê±°ë˜ ê¸°ë¡ ë° í¬ì§€ì…˜ ì •ë¦¬
                entry_price = self.my_position['price']
                buy_size = self.my_position['size']
                buy_reason = self.my_position['reason']
                open_date = self.my_position['date']

                # ìˆ˜ìµê¸ˆ/ë¥  ê³„ì‚°
                pnl = (sell_price - entry_price) * buy_size
                profit_pct = ((sell_price - entry_price) / entry_price) * 100

                # ë³´ìœ  ì¤‘ ìµœëŒ€ ìˆ˜ìµë¥  (PeakëŠ” ì´ë²ˆ ë´‰ ê³ ê°€ê¹Œì§€ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ìœ íš¨)
                max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100

                self.trades_history.append({
                    'open_date': open_date,
                    'date': current_date,
                    'profit_pct': profit_pct,
                    'max_profit_pct': max_profit_pct,
                    'pnl': pnl,
                    'is_win': pnl > 0,
                    'entry_price': entry_price,
                    'exit_price': sell_price,
                    'status': 'Closed',
                    'buy_reason': buy_reason,
                    'sell_reason': sell_reason
                })

                self.sell_points.append((current_date, sell_price))
                self.my_position = None
                self.peak_price = 0
                return  # ë§¤ë„í•œ ë‚ ì€ ë‹¤ì‹œ ë§¤ìˆ˜í•˜ì§€ ì•ŠìŒ (ë‹¨íƒ€ ë°©ì§€)

        # ----------------------------------------------------------------------
        # [2] ë¯¸ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ìˆ˜(ì§„ì…) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position is None:
            # ê¸°ì¤€: ì „ì¼ ì¢…ê°€
            prev_close = self.data.close[-1]
            target_price = prev_close * (1 + self.p.target_pct)
            target_price = math.ceil(target_price)  # 1ì› ë‹¨ìœ„ ì˜¬ë¦¼

            # A. ë³€ë™ì„± ëŒíŒŒ í™•ì¸ (ì˜¤ëŠ˜ ê³ ê°€ê°€ íƒ€ê²Ÿ ì´ìƒì¸ê°€?)
            if self.data.high[0] < target_price:
                return

            # B. ìœ ë™ì„± í™•ì¸ (ì˜¤ëŠ˜ ê±°ë˜ëŒ€ê¸ˆ)
            trade_amount = self.data.close[0] * self.data.volume[0]
            if trade_amount < 5000000000:
                return

            # C. ì •ë°°ì—´ í™•ì¸ (ì˜¤ëŠ˜ ì¢…ê°€ ê¸°ì¤€)
            # ì¥ì¤‘ ëŒíŒŒ ì‹œì ì—ëŠ” ì•„ì§ ì¢…ê°€ê°€ í™•ì •ë˜ì§€ ì•Šì•˜ì§€ë§Œ,
            # "ì„±ê³µí•œ ì¼€ì´ìŠ¤"ë¥¼ ì°¾ëŠ” ë¶„ì„ì´ë¯€ë¡œ ì¼ë´‰ ì™„ì„± ê¸°ì¤€ìœ¼ë¡œ ì •ë°°ì—´ ìœ ì§€ë¥¼ ì¡°ê±´ìœ¼ë¡œ í•¨
            if self.ma3[0] <= self.ma5[0]:
                return

            # (ì¶”ê°€) ì „ì¼ì—ë„ ì •ë°°ì—´ì´ì—ˆì–´ì•¼ í•˜ëŠ”ê°€? -> ì „ëµ ì„¤ëª…ìƒ "ì§€ì† ì •ë°°ì—´"
            if self.ma3[-1] <= self.ma5[-1]:
                return

            # D. ë°´ë“œí­ í™•ì¸ (ì „ì¼ ê¸°ì¤€)
            top = self.bband.lines.top[-1]
            bot = self.bband.lines.bot[-1]
            mid = self.bband.lines.mid[-1]

            if mid == 0: return
            bandwidth = (top - bot) / mid

            if not (self.p.bandwidth_min <= bandwidth < self.p.bandwidth_max):
                return

            # ë§¤ìˆ˜ ì²´ê²° ê°€ê²© ê²°ì •
            # ì‹œê°€ê°€ ì´ë¯¸ íƒ€ê²Ÿë³´ë‹¤ ë†’ìœ¼ë©´(ê°­ìƒìŠ¹) ì‹œê°€ ë§¤ìˆ˜
            # ì•„ë‹ˆë¼ë©´ íƒ€ê²Ÿ ê°€ê²©ì— ë§¤ìˆ˜
            buy_price = 0
            if self.data.open[0] > target_price:
                buy_price = self.data.open[0]
            else:
                buy_price = target_price

            # ë§¤ìˆ˜ ê¸°ë¡ ìƒì„±
            cash = 10000000  # 1ì¢…ëª©ë‹¹ 1ì²œë§Œì› ê°€ì •
            size = math.floor(cash / buy_price)

            buy_reason = (f"ğŸš€ [ë§¤ìˆ˜ ì‚¬ìœ ] ë³¼ë¦°ì €ë°´ë“œ ê¸‰ë“±ì£¼ íŒ¨í„´ í¬ì°©\n"
                          f"   1. ë³€ë™ì„± ëŒíŒŒ: ì „ì¼({self.data.datetime.date(-1)}) ì¢…ê°€({prev_close:,.0f}ì›) ëŒ€ë¹„ +5%({target_price:,.0f}ì›) ëŒíŒŒ\n"
                          f"   2. ë°´ë“œí­ ì¡°ê±´: ì „ì¼ ë°´ë“œí­ {bandwidth * 100:.2f}% (ì¡°ê±´: {self.p.bandwidth_min * 100}% ì´ìƒ)\n"
                          f"   3. ìœ ë™ì„± í™•ì¸: ê¸ˆì¼ ê±°ë˜ëŒ€ê¸ˆ {trade_amount / 100000000:.1f}ì–µ\n"
                          f"   4. ì´í‰ì„  ì¶”ì„¸: ì •ë°°ì—´ ìœ ì§€ (MA3: {self.ma3[0]:.0f} > MA5: {self.ma5[0]:.0f})")

            self.my_position = {
                'price': buy_price,
                'date': current_date,
                'size': size,
                'reason': buy_reason
            }
            self.peak_price = buy_price  # ì´ˆê¸°í™”
            self.buy_points.append((current_date, buy_price))

    def stop(self):
        # ë§ˆì§€ë§‰ ë‚  ê°•ì œ ì²­ì‚° (ë³´ìœ  ì¤‘ì¸ ê²½ìš°)
        if self.my_position:
            current_date = self.data.datetime.date(0)
            current_price = self.data.close[0]

            entry_price = self.my_position['price']
            buy_size = self.my_position['size']

            if current_price > self.peak_price:
                self.peak_price = current_price

            pnl = (current_price - entry_price) * buy_size
            profit_pct = ((current_price - entry_price) / entry_price) * 100
            max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100

            self.trades_history.append({
                'open_date': self.my_position['date'],
                'date': current_date,
                'profit_pct': profit_pct,
                'max_profit_pct': max_profit_pct,
                'pnl': pnl,
                'is_win': pnl > 0,
                'entry_price': entry_price,
                'exit_price': current_price,
                'status': 'Holding',
                'buy_reason': self.my_position['reason'],
                'sell_reason': "ë°±í…ŒìŠ¤íŠ¸ ì¢…ë£Œë¡œ ì¸í•œ í‰ê°€ ì²˜ë¦¬"
            })


# ==========================================
# ì‹¤í–‰ í•¨ìˆ˜ (ë‹¨ì¼ êµ¬ê°„)
# ==========================================
def run_single_backtest(file_path, target_pct, bandwidth_min, bandwidth_max):
    try:
        df = pd.read_excel(file_path)
        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date'}
        df = df.rename(columns=rename_map)

        cols_to_numeric = ['Close', 'Open', 'High', 'Low', 'Volume']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()

        df = df.dropna(subset=[c for c in cols_to_numeric if c in df.columns])

        if 'Date' in df.columns:
            if df['Date'].dtype == 'object':
                df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            return None

        if len(df) < 30:
            return None

        cerebro = bt.Cerebro(runonce=False)
        # BrokerëŠ” ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ê¸°ë³¸ ì„¤ì • ìœ ì§€
        cerebro.broker.setcash(100000000)

        # [ìˆ˜ì •] ë°´ë“œí­ ë²”ìœ„ íŒŒë¼ë¯¸í„° ì „ë‹¬
        cerebro.addstrategy(CustomDailyStrategy, target_pct=target_pct,
                            bandwidth_min=bandwidth_min, bandwidth_max=bandwidth_max)

        cerebro.adddata(bt.feeds.PandasData(dataname=df))

        strats = cerebro.run()

        trades_hist = strats[0].trades_history
        if not trades_hist:
            return {'trades': 0, 'wins': 0, 'win_rate': 0, 'profit_rate': 0, 'total_profit': 0, 'history': []}

        total_trades = len(trades_hist)
        wins = sum(1 for t in trades_hist if t['is_win'])
        win_rate = (wins / total_trades * 100) if total_trades > 0 else 0

        total_profit = sum(t['pnl'] for t in trades_hist)
        total_profit_rate = sum(t['profit_pct'] for t in trades_hist)

        return {
            'trades': total_trades,
            'wins': wins,
            'win_rate': win_rate,
            'profit_rate': total_profit_rate,
            'total_profit': total_profit,
            'history': trades_hist
        }

    except Exception as e:
        return None


def main():
    print(CustomDailyStrategy.__doc__)
    print("=== ğŸ¯ [ì¼ë´‰ ì „ëµ] ê°œë³„ ê²Œì„ë³„ ìƒì„¸ ì„±ê³¼ ë¦¬í¬íŠ¸ ===")
    print("ğŸ“Œ ì„¤ì •: ë³¼ë¦°ì €ë°´ë“œ(20, 2), ë°´ë“œí­ 12% ì´ìƒ, í™•ì¸ ë§¤ë§¤(ë‹¹ì¼ ì²´ê²°)")

    data_dir = "stock_data_51"
    if not os.path.exists(data_dir):
        print(f"ğŸš¨ '{data_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return

    files = [os.path.join(data_dir, f) for f in os.listdir(data_dir) if f.endswith(".xlsx")]
    print(f"ğŸ“‚ ë¶„ì„ ëŒ€ìƒ: {len(files)}ê°œ ì¢…ëª©\n")

    target_pct = 0.05
    # [ìˆ˜ì •] ë°´ë“œí­: 12% ~ ë¬´ì œí•œ (100.0)
    bw_min = 0.12
    bw_max = 100.0

    print(f"\nğŸ“Š [ì „ì²´ ê±°ë˜ ë‚´ì—­ ìƒì„¸]")
    print("=" * 110)
    print(f"{'ì¢…ëª©ëª…':<12} | {'ë§¤ìˆ˜ì¼':<10} | {'ë§¤ë„ì¼':<10} | {'ë§¤ìˆ˜ê°€':>9} | {'ë§¤ë„ê°€':>9} | {'ìˆ˜ìµë¥ ':>7} | {'ìµœëŒ€ìˆ˜ìµë¥ ':>9}")
    print("-" * 110)

    total_stats = {'trades': 0, 'profit': 0, 'wins': 0}
    all_history = []  # [ì¶”ê°€] ìƒì„¸ ë¶„ì„ì„ ìœ„í•´ ì „ì²´ ê¸°ë¡ ìˆ˜ì§‘

    for file_path in files:
        stock_name = os.path.basename(file_path).split('_')[-1].replace('.xlsx', '')

        res = run_single_backtest(file_path, target_pct, bw_min, bw_max)

        if res and res['trades'] > 0:
            total_stats['trades'] += res['trades']
            total_stats['profit'] += res['total_profit']
            total_stats['wins'] += res['wins']

            # ê°œë³„ ê²Œì„ë³„ ì¶œë ¥
            for t in res['history']:
                # ì¢…ëª©ëª… ì¶”ê°€ íƒœê¹… (ë‚˜ì¤‘ì— ê²€ìƒ‰ì„ ìœ„í•´)
                t['stock_name'] = stock_name
                all_history.append(t)

                if isinstance(t['date'], str):
                    close_date_str = t['date']
                else:
                    close_date_str = t['date'].strftime('%Y-%m-%d')

                if isinstance(t.get('open_date'), str):
                    open_date_str = t.get('open_date', '-')
                elif t.get('open_date'):
                    open_date_str = t['open_date'].strftime('%Y-%m-%d')
                else:
                    open_date_str = "-"

                profit_pct = t['profit_pct']
                max_profit_pct = t.get('max_profit_pct', 0.0)
                entry_price = t['entry_price']
                exit_price = t['exit_price']

                # ìˆ˜ìµ/ì†ì‹¤ ìƒ‰ìƒ í‘œì‹œ (í„°ë¯¸ë„ ì§€ì› ì‹œ)
                mark = "ğŸ”´" if profit_pct > 0 else "ğŸ”µ"

                print(
                    f"{stock_name:<12} | {open_date_str:<10} | {close_date_str:<10} | {entry_price:9,.0f} | {exit_price:9,.0f} | {profit_pct:6.2f}% | {max_profit_pct:8.2f}% {mark}")

    print("=" * 110)

    avg_win_rate = (total_stats['wins'] / total_stats['trades'] * 100) if total_stats['trades'] > 0 else 0
    print(f"\nğŸ“ˆ [ìµœì¢… ìš”ì•½]")
    print(f"ì´ ë§¤ë§¤ íšŸìˆ˜: {total_stats['trades']}íšŒ")
    print(f"ì „ì²´ ìŠ¹ë¥    : {avg_win_rate:.2f}%")
    print(f"ì´ ìˆ˜ìµê¸ˆ   : {total_stats['profit']:,.0f}ì›")

    # [ì¶”ê°€] íŠ¹ì • ì¢…ëª©(ë‹¬ë°”ê¸€ë¡œë²Œ) íŠ¹ì • ë‚ ì§œ(11ì›” 5ì¼) ìƒì„¸ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ” [íŠ¹ë³„ ë¶„ì„ ìš”ì²­] 'ë‹¬ë°”ê¸€ë¡œë²Œ' 11ì›” 5ì¼ ë§¤ìˆ˜ ê±´ ìƒì„¸ ë¶„ì„")
    print("=" * 80)

    target_found = False
    for t in all_history:
        # ì¢…ëª©ëª…ì´ ì¼ì¹˜í•˜ê³ , ë§¤ìˆ˜ì¼ì˜ ì›”-ì¼ì´ 11-05ì¸ ê²½ìš° ì°¾ê¸°
        if t['stock_name'] == 'ë‹¬ë°”ê¸€ë¡œë²Œ' and t['open_date'].strftime('%m-%d') == '11-05':
            print(f"ğŸ“Œ ì¢…ëª©ëª…: {t['stock_name']}")
            print(f"ğŸ“… ë§¤ìˆ˜ì¼: {t['open_date']}  |  ğŸ“… ë§¤ë„ì¼: {t['date']}")
            print(f"ğŸ’µ ë§¤ìˆ˜ê°€: {t['entry_price']:,.0f}ì›  |  ğŸ’µ ë§¤ë„ê°€: {t['exit_price']:,.0f}ì›")
            print(f"ğŸ“Š ìˆ˜ìµë¥ : {t['profit_pct']:.2f}%  (ë³´ìœ ì¤‘ ìµœëŒ€ìˆ˜ìµë¥ : {t['max_profit_pct']:.2f}%)")
            print("-" * 80)
            print(t.get('buy_reason', 'ë§¤ìˆ˜ ì´ìœ  ì •ë³´ ì—†ìŒ'))
            print("-" * 80)
            print(t.get('sell_reason', 'ë§¤ë„ ì´ìœ  ì •ë³´ ì—†ìŒ'))
            print("=" * 80)
            target_found = True
            break

    if not target_found:
        print("âš ï¸ 11ì›” 5ì¼ ì²´ê²° ë‚´ì—­ ì—†ìŒ. ì¸ê·¼ ë‚ ì§œ ê²€ìƒ‰ ì¤‘...")
        for t in all_history:
            if t['stock_name'] == 'ë‹¬ë°”ê¸€ë¡œë²Œ' and t['open_date'].strftime('%m') == '11':
                print(f"ğŸ“Œ ìœ ì‚¬ ë‚´ì—­ ë°œê²¬: {t['open_date']} ë§¤ìˆ˜ / {t['date']} ë§¤ë„")
                print("-" * 80)
                print(t.get('buy_reason', 'ë§¤ìˆ˜ ì´ìœ  ì •ë³´ ì—†ìŒ'))
                print("-" * 80)
                print(t.get('sell_reason', 'ë§¤ë„ ì´ìœ  ì •ë³´ ì—†ìŒ'))
                print("=" * 80)


if __name__ == "__main__":
    main()
