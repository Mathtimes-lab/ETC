import sys
import os
import time
import pandas as pd
from datetime import datetime, timedelta
from PyQt5.QtWidgets import QApplication
from PyQt5.QAxContainer import QAxWidget
from PyQt5.QtCore import QEventLoop

class KiwoomDownloader(QAxWidget):
    def __init__(self):
        super().__init__()
        self._create_kiwoom_instance()
        self._set_signal_slots()
        self._login()

        self.remained_data = False
        self.ohlcv_data = []
        self.screen_no = "0101"

    def _create_kiwoom_instance(self):
        self.setControl("KHOPENAPI.KHOpenAPICtrl.1")

    def _set_signal_slots(self):
        self.OnEventConnect.connect(self._on_event_connect)
        self.OnReceiveTrData.connect(self._on_receive_tr_data)

    def _login(self):
        self.login_event_loop = QEventLoop()
        self.dynamicCall("CommConnect()")
        self.login_event_loop.exec_()

    def _on_event_connect(self, err_code):
        if err_code == 0:
            print("âœ… í‚¤ì›€ API ë¡œê·¸ì¸ ì„±ê³µ")
        else:
            print("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨")
        self.login_event_loop.exit()

    def get_stock_name(self, code):
        return self.dynamicCall("GetMasterCodeName(QString)", [code]).strip()

    def get_kospi_code_list(self):
        return self.dynamicCall("GetCodeListByMarket(QString)", ["0"]).split(';')[:-1]

    def get_kosdaq_code_list(self):
        return self.dynamicCall("GetCodeListByMarket(QString)", ["10"]).split(';')[:-1]

    def get_stock_state(self, code):
        return self.dynamicCall("GetMasterStockState(QString)", [code])

    def get_listed_shares(self, code):
        shares = self.dynamicCall("GetMasterListedStockCnt(QString)", [code])
        return int(shares) if shares else 0

    def get_master_last_price(self, code):
        price = self.dynamicCall("GetMasterLastPrice(QString)", [code])
        return int(price) if price else 0

    def check_filter(self, code, name):
        exclude_keywords = ["ìŠ¤íŒ©", "ETN", "ETF", "ë¦¬ì¸ ", "ì „í™˜ì‚¬ì±„", "ì‹ ì£¼ì¸ìˆ˜ê¶Œ"]
        if any(keyword in name for keyword in exclude_keywords):
            return False
        state = self.get_stock_state(code)
        if "ê´€ë¦¬ì¢…ëª©" in state or "ê±°ë˜ì •ì§€" in state or "ì •ë¦¬ë§¤ë§¤" in state:
            return False
        return True

    def request_daily_chart(self, code, date):
        self.ohlcv_data = []
        self.remained_data = False
        
        # ìµœê·¼ 6ê°œì›”ì¹˜ ë°ì´í„°ëŠ” ì•½ 120~130ì¼ë¶„ì´ë¯€ë¡œ 1íšŒ ì¡°íšŒ(600ê°œ)ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.
        self.dynamicCall("SetInputValue(QString, QString)", "ì¢…ëª©ì½”ë“œ", code)
        self.dynamicCall("SetInputValue(QString, QString)", "ê¸°ì¤€ì¼ì", date)
        self.dynamicCall("SetInputValue(QString, QString)", "ìˆ˜ì •ì£¼ê°€êµ¬ë¶„", "1")
        self._comm_rq_data("opt10081", "ì£¼ì‹ì¼ë´‰ì°¨íŠ¸ì¡°íšŒ", 0, self.screen_no)
        
        if not self.ohlcv_data:
            return pd.DataFrame()

        df = pd.DataFrame(self.ohlcv_data, columns=['Date', 'Open', 'High', 'Low', 'Close', 'Volume'])
        
        # ë‚ ì§œ í˜•ì‹ ë³€í™˜ ë° ì •ë ¬
        df['Date'] = pd.to_datetime(df['Date'])
        df = df.sort_values(by='Date').reset_index(drop=True)
        
        # [ìˆ˜ì •] ìµœê·¼ 6ê°œì›”ì¹˜ ë°ì´í„°ë§Œ ë‚¨ê¸°ê¸°
        six_months_ago = datetime.now() - timedelta(days=180)
        df = df[df['Date'] >= six_months_ago]
        
        return df

    def _comm_rq_data(self, trcode, rqname, next_val, screen_no):
        self.tr_event_loop = QEventLoop()
        self.dynamicCall("CommRqData(QString, QString, int, QString)", rqname, trcode, next_val, screen_no)
        self.tr_event_loop.exec_()

    def _on_receive_tr_data(self, screen_no, rqname, trcode, record_name, next_val, unused1, unused2, unused3, unused4):
        count = self.dynamicCall("GetRepeatCnt(QString, QString)", trcode, rqname)
        
        for i in range(count):
            date = self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "ì¼ì").strip()
            open_ = abs(int(self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "ì‹œê°€").strip()))
            high = abs(int(self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "ê³ ê°€").strip()))
            low = abs(int(self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "ì €ê°€").strip()))
            close = abs(int(self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "í˜„ì¬ê°€").strip()))
            volume = abs(int(self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "ê±°ë˜ëŸ‰").strip()))

            self.ohlcv_data.append([date, open_, high, low, close, volume])

        self.tr_event_loop.exit()

def main():
    app = QApplication(sys.argv)
    
    print("ğŸš€ í‚¤ì›€ì¦ê¶Œ API ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘...")
    kiwoom = KiwoomDownloader()

    # [ìˆ˜ì •] í´ë”ëª… ë³€ê²½: stock_data_500
    save_dir = "stock_data_500"
    if not os.path.exists(save_dir):
        os.makedirs(save_dir)

    print("â³ ì½”ìŠ¤í”¼, ì½”ìŠ¤ë‹¥ ì¢…ëª© ì •ë³´ ë° ì‹œê°€ì´ì•¡ ë¡œë”© ì¤‘ (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)...")
    
    # ì½”ìŠ¤í”¼ ìƒìœ„ 300ê°œ ì¶”ì¶œ
    kospi_codes = kiwoom.get_kospi_code_list()
    kospi_valid = []
    for code in kospi_codes:
        name = kiwoom.get_stock_name(code)
        if kiwoom.check_filter(code, name):
            mc = kiwoom.get_listed_shares(code) * kiwoom.get_master_last_price(code)
            kospi_valid.append({'code': code, 'name': name, 'market_cap': mc})
    
    top_300_kospi = sorted(kospi_valid, key=lambda x: x['market_cap'], reverse=True)[:300]
    
    # ì½”ìŠ¤ë‹¥ ìƒìœ„ 200ê°œ ì¶”ì¶œ
    kosdaq_codes = kiwoom.get_kosdaq_code_list()
    kosdaq_valid = []
    for code in kosdaq_codes:
        name = kiwoom.get_stock_name(code)
        if kiwoom.check_filter(code, name):
            mc = kiwoom.get_listed_shares(code) * kiwoom.get_master_last_price(code)
            kosdaq_valid.append({'code': code, 'name': name, 'market_cap': mc})
            
    top_200_kosdaq = sorted(kosdaq_valid, key=lambda x: x['market_cap'], reverse=True)[:200]

    # ì¶”ì¶œëœ ì¢…ëª© í•©ì¹˜ê¸° (ë”•ì…”ë„ˆë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ë°©ì§€ ë° ë¹ ë¥¸ ê²€ìƒ‰)
    download_targets = {item['code']: item['name'] for item in top_300_kospi + top_200_kosdaq}
    
    # [ì¶”ê°€] SKì¦ê¶Œ í¬í•¨ì‹œí‚¤ê¸°
    sk_code = None
    for code in kospi_codes + kosdaq_codes:
        if kiwoom.get_stock_name(code) == "SKì¦ê¶Œ":
            sk_code = code
            break
            
    if sk_code and sk_code not in download_targets:
        download_targets[sk_code] = "SKì¦ê¶Œ"
        print("â• íŠ¹ë³„ ì¶”ê°€: SKì¦ê¶Œ (ì‹œì´ ìˆœìœ„ ë°–ì´ì–´ë„ ì¶”ê°€ë¨)")

    final_targets = [(code, name) for code, name in download_targets.items()]

    print(f"âœ… ì½”ìŠ¤í”¼ ìƒìœ„ 300ê°œ + ì½”ìŠ¤ë‹¥ ìƒìœ„ 200ê°œ + SKì¦ê¶Œ = ì´ {len(final_targets)}ê°œ ì¤€ë¹„ ì™„ë£Œ")
    print("ğŸš€ ë‹¤ìš´ë¡œë“œ ì‹œì‘ (ìµœê·¼ 6ê°œì›” ë°ì´í„°)...")

    today_str = datetime.now().strftime("%Y%m%d")
    total = len(final_targets)

    for idx, (code, name) in enumerate(final_targets):
        print(f"[{idx+1}/{total}] {name} ({code}) ìš”ì²­ ì¤‘...", end=" ", flush=True)
        
        try:
            df = kiwoom.request_daily_chart(code, today_str)
            
            if not df.empty:
                safe_name = name.replace("/", "_").replace("*", "").replace(":", "")
                file_path = os.path.join(save_dir, f"{code}_{safe_name}.xlsx")
                df.to_excel(file_path, index=False)
                print(f"ì™„ë£Œ ({len(df)}ê±´)")
            else:
                print("ë°ì´í„° ì—†ìŒ")
            
            # TR ì œí•œ ë°©ì§€ (0.5ì´ˆ ëŒ€ê¸°)
            time.sleep(0.5)
            
        except Exception as e:
            print(f"ì‹¤íŒ¨ ({e})")

    print(f"\nğŸ‰ '{save_dir}' í´ë”ì— ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    sys.exit()

if __name__ == "__main__":
    main()
