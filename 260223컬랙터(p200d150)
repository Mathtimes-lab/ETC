import sys
import os
import time
import pandas as pd
from datetime import datetime, timedelta
from PyQt5.QtWidgets import QApplication
from PyQt5.QAxContainer import QAxWidget
from PyQt5.QtCore import QEventLoop


class KiwoomDownloader(QAxWidget):
    def __init__(self):
        super().__init__()
        self._create_kiwoom_instance()
        self._set_signal_slots()
        self._login()

        self.remained_data = False
        self.ohlcv_data = []
        self.screen_no = "0101"

    def _create_kiwoom_instance(self):
        self.setControl("KHOPENAPI.KHOpenAPICtrl.1")

    def _set_signal_slots(self):
        self.OnEventConnect.connect(self._on_event_connect)
        self.OnReceiveTrData.connect(self._on_receive_tr_data)

    def _login(self):
        self.login_event_loop = QEventLoop()
        self.dynamicCall("CommConnect()")
        self.login_event_loop.exec_()

    def _on_event_connect(self, err_code):
        if err_code == 0:
            print("âœ… í‚¤ì›€ API ë¡œê·¸ì¸ ì„±ê³µ")
        else:
            print(f"âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ (ì—ëŸ¬ì½”ë“œ: {err_code})")
        self.login_event_loop.exit()

    def get_stock_name(self, code):
        return self.dynamicCall("GetMasterCodeName(QString)", [code]).strip()

    def get_kospi_code_list(self):
        return self.dynamicCall("GetCodeListByMarket(QString)", ["0"]).split(';')[:-1]

    def get_kosdaq_code_list(self):
        return self.dynamicCall("GetCodeListByMarket(QString)", ["10"]).split(';')[:-1]

    def get_stock_state(self, code):
        """ì¢…ëª© ìƒíƒœ(KOSPI200 ë“±)ë¥¼ ë°˜í™˜í•˜ëŠ” ë¡œì»¬ í•¨ìˆ˜"""
        return self.dynamicCall("GetMasterStockState(QString)", [code])

    def get_index_constituents_local(self, market_type):
        """
        [í•µì‹¬ ìˆ˜ì •] TR í†µì‹  ëŒ€ì‹  ë¡œì»¬ PCì˜ ë§ˆìŠ¤í„° ì •ë³´ë¥¼ í™œìš©í•´ ì§€ìˆ˜ êµ¬ì„±ì¢…ëª©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        ì¥ ìš´ì˜ ì‹œê°„, ì£¼ë§ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ 24ì‹œê°„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.
        """
        target_codes = []
        if market_type == "KOSPI200":
            codes = self.get_kospi_code_list()
            for code in codes:
                state = self.get_stock_state(code).upper()
                if "KOSPI200" in state or "ì½”ìŠ¤í”¼200" in state:
                    target_codes.append(code)
                    
        elif market_type == "KOSDAQ150":
            codes = self.get_kosdaq_code_list()
            for code in codes:
                state = self.get_stock_state(code).upper()
                if "KOSDAQ150" in state or "ì½”ìŠ¤ë‹¥150" in state:
                    target_codes.append(code)
                    
        return target_codes

    def get_listed_shares(self, code):
        shares = self.dynamicCall("GetMasterListedStockCnt(QString)", [code])
        return int(shares) if shares else 0

    def get_master_last_price(self, code):
        price = self.dynamicCall("GetMasterLastPrice(QString)", [code])
        return int(price) if price else 0

    def check_filter(self, code, name):
        exclude_keywords = ["ìŠ¤íŒ©", "ETN", "ETF", "ë¦¬ì¸ ", "ì „í™˜ì‚¬ì±„", "ì‹ ì£¼ì¸ìˆ˜ê¶Œ"]
        if any(keyword in name for keyword in exclude_keywords):
            return False
        state = self.get_stock_state(code)
        if "ê´€ë¦¬ì¢…ëª©" in state or "ê±°ë˜ì •ì§€" in state or "ì •ë¦¬ë§¤ë§¤" in state:
            return False
        return True

    def request_daily_chart(self, code, date):
        self.ohlcv_data = []
        self.remained_data = True
        next_val = 0

        target_date_str = "20250101"
        target_date = datetime.strptime(target_date_str, "%Y%m%d")

        while self.remained_data:
            self.dynamicCall("SetInputValue(QString, QString)", "ì¢…ëª©ì½”ë“œ", code)
            self.dynamicCall("SetInputValue(QString, QString)", "ê¸°ì¤€ì¼ì", date)
            self.dynamicCall("SetInputValue(QString, QString)", "ìˆ˜ì •ì£¼ê°€êµ¬ë¶„", "1")
            self._comm_rq_data("opt10081", "ì£¼ì‹ì¼ë´‰ì°¨íŠ¸ì¡°íšŒ", next_val, self.screen_no)

            if self.ohlcv_data:
                last_date_str = self.ohlcv_data[-1][0]
                if last_date_str:
                    last_date_dt = datetime.strptime(last_date_str, "%Y%m%d")
                    if last_date_dt <= target_date:
                        break

            if self.remained_data:
                next_val = 2
                time.sleep(0.5)

        if not self.ohlcv_data:
            return pd.DataFrame()

        df = pd.DataFrame(self.ohlcv_data, columns=['Date', 'Open', 'High', 'Low', 'Close', 'Volume'])
        df['Date'] = pd.to_datetime(df['Date'])
        df = df.sort_values(by='Date').reset_index(drop=True)
        df = df[df['Date'] >= '2025-01-01']

        return df

    def _comm_rq_data(self, trcode, rqname, next_val, screen_no):
        self.tr_event_loop = QEventLoop()
        ret = self.dynamicCall("CommRqData(QString, QString, int, QString)", rqname, trcode, next_val, screen_no)
        if ret != 0:
            print(f"\nâŒ TR ìš”ì²­ ì‹¤íŒ¨ ({rqname}) - ì—ëŸ¬ì½”ë“œ: {ret}")
            self.remained_data = False
            return
        self.tr_event_loop.exec_()

    def _get_comm_data_int(self, trcode, rqname, index, item_name):
        """ë¹ˆ ë¬¸ìì—´ì´ ë°˜í™˜ë  ê²½ìš°ì˜ ValueErrorë¥¼ ë°©ì§€í•˜ëŠ” ì•ˆì „í•œ ì •ìˆ˜ ë³€í™˜ í—¬í¼ í•¨ìˆ˜"""
        val = self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, index, item_name).strip()
        try:
            return abs(int(val)) if val else 0
        except ValueError:
            return 0

    def _on_receive_tr_data(self, screen_no, rqname, trcode, record_name, next_val, unused1, unused2, unused3, unused4):
        # ì—°ì†ì¡°íšŒ(ë‹¤ìŒ í˜ì´ì§€) ë°ì´í„° ìœ ë¬´ í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
        self.remained_data = (next_val == '2')
        count = self.dynamicCall("GetRepeatCnt(QString, QString)", trcode, rqname)

        for i in range(count):
            date = self.dynamicCall("GetCommData(QString, QString, int, QString)", trcode, rqname, i, "ì¼ì").strip()
            open_ = self._get_comm_data_int(trcode, rqname, i, "ì‹œê°€")
            high = self._get_comm_data_int(trcode, rqname, i, "ê³ ê°€")
            low = self._get_comm_data_int(trcode, rqname, i, "ì €ê°€")
            close = self._get_comm_data_int(trcode, rqname, i, "í˜„ì¬ê°€")
            volume = self._get_comm_data_int(trcode, rqname, i, "ê±°ë˜ëŸ‰")

            self.ohlcv_data.append([date, open_, high, low, close, volume])

        self.tr_event_loop.exit()


def main():
    app = QApplication(sys.argv)

    print("ğŸš€ í‚¤ì›€ì¦ê¶Œ API ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘...")
    kiwoom = KiwoomDownloader()

    save_dir = "stock_data_p200d150"
    if not os.path.exists(save_dir):
        os.makedirs(save_dir)

    print("â³ KOSPI ë° KOSDAQ ì¢…ëª© ì •ë³´ ë¡œë”© ì¤‘ (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)...")

    # 1. KOSPI 200 (ë¡œì»¬ ë°ì´í„° ê¸°ë°˜)
    print("ğŸ“Š KOSPI 200 êµ¬ì„±ì¢…ëª© ì¶”ì¶œ ì¤‘ (ì£¼ë§/ì•¼ê°„ ì ‘ì† ë¬´ê´€)...")
    kospi200_raw = kiwoom.get_index_constituents_local("KOSPI200")
    
    # ë§Œì¼ì˜ ê²½ìš° íƒœê·¸ ì˜¤ë¥˜ë¡œ 0ê±´ì´ ë°˜í™˜ë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ 100% ì•ˆì „ ì¥ì¹˜ (ë™ì¼í•˜ê²Œ ë¡œì»¬ ì •ë³´ ì‚¬ìš©)
    if len(kospi200_raw) < 100:
        print("âš ï¸ HTS íƒœê·¸ ê°ì§€ ì‹¤íŒ¨. ëŒ€ì•ˆìœ¼ë¡œ ì‹œê°€ì´ì•¡ ìƒìœ„ 200ì¢…ëª©ìœ¼ë¡œ ì¦‰ì‹œ ëŒ€ì²´í•©ë‹ˆë‹¤.")
        temp_list = []
        for code in kiwoom.get_kospi_code_list():
            if kiwoom.check_filter(code, kiwoom.get_stock_name(code)):
                mc = kiwoom.get_listed_shares(code) * kiwoom.get_master_last_price(code)
                temp_list.append({'code': code, 'mc': mc})
        kospi200_raw = [x['code'] for x in sorted(temp_list, key=lambda x: x['mc'], reverse=True)[:200]]

    kospi_valid = []
    for code in kospi200_raw:
        code = ''.join(filter(str.isdigit, code))[-6:]
        if not code: continue
        name = kiwoom.get_stock_name(code)
        if kiwoom.check_filter(code, name):
            kospi_valid.append({'code': code, 'name': name, 'market': 'KOSPI200'})
            
    top_200_kospi = kospi_valid[:200]

    # 2. KOSDAQ 150 (ë¡œì»¬ ë°ì´í„° ê¸°ë°˜)
    print("ğŸ“Š KOSDAQ 150 êµ¬ì„±ì¢…ëª© ì¶”ì¶œ ì¤‘ (ì£¼ë§/ì•¼ê°„ ì ‘ì† ë¬´ê´€)...")
    kosdaq150_raw = kiwoom.get_index_constituents_local("KOSDAQ150")
    
    # ì½”ìŠ¤ë‹¥ì€ ì¢…ì¢… íƒœê·¸ê°€ ëˆ„ë½ë˜ëŠ” ê²½ìš°ê°€ ìˆì–´ ì™„ë²½í•œ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ ì•ˆì „ ì¥ì¹˜ ë§ˆë ¨
    if len(kosdaq150_raw) < 50:
        print("âš ï¸ HTS KOSDAQ 150 íƒœê·¸ ê°ì§€ ì‹¤íŒ¨. ëŒ€ì•ˆìœ¼ë¡œ ì‹œê°€ì´ì•¡ ìƒìœ„ 150ì¢…ëª©ìœ¼ë¡œ ì¦‰ì‹œ ëŒ€ì²´í•©ë‹ˆë‹¤.")
        temp_list = []
        for code in kiwoom.get_kosdaq_code_list():
            if kiwoom.check_filter(code, kiwoom.get_stock_name(code)):
                mc = kiwoom.get_listed_shares(code) * kiwoom.get_master_last_price(code)
                temp_list.append({'code': code, 'mc': mc})
        kosdaq150_raw = [x['code'] for x in sorted(temp_list, key=lambda x: x['mc'], reverse=True)[:150]]

    kosdaq_valid = []
    for code in kosdaq150_raw:
        code = ''.join(filter(str.isdigit, code))[-6:]
        if not code: continue
        name = kiwoom.get_stock_name(code)
        if kiwoom.check_filter(code, name):
            kosdaq_valid.append({'code': code, 'name': name, 'market': 'KOSDAQ150'})

    top_150_kosdaq = kosdaq_valid[:150]

    # ëŒ€ìƒ ì¢…ëª©ì„ ì½”ìŠ¤í”¼ 200 + ì½”ìŠ¤ë‹¥ 150 (ì´ 350ê°œ)ë¡œ ì„¤ì •
    final_targets = [(item['code'], item['name'], item['market']) for item in (top_200_kospi + top_150_kosdaq)]

    print(f"âœ… HTS ê¸°ì¤€ ì¢…ëª© (ì´ {len(final_targets)}ì¢…ëª©) ì¤€ë¹„ ì™„ë£Œ")
    
    if len(final_targets) == 0:
        print("âŒ íƒ€ê²Ÿ ì¢…ëª©ì„ í•˜ë‚˜ë„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
        sys.exit()

    print("ğŸš€ ë‹¤ìš´ë¡œë“œ ì‹œì‘ (2025ë…„ 1ì›” 1ì¼ ì´í›„ ë°ì´í„°ë§Œ)...")

    today_str = datetime.now().strftime("%Y%m%d")
    total = len(final_targets)

    for idx, (code, name, market) in enumerate(final_targets):
        print(f"[{idx + 1}/{total}] [{market}] {name} ({code}) ìš”ì²­ ì¤‘...", end=" ", flush=True)

        try:
            df = kiwoom.request_daily_chart(code, today_str)

            if not df.empty:
                safe_name = name.replace("/", "_").replace("*", "").replace(":", "")
                file_path = os.path.join(save_dir, f"{code}_{safe_name}.xlsx")
                df.to_excel(file_path, index=False)
                print(f"ì™„ë£Œ ({len(df)}ê±´)")
            else:
                print("ë°ì´í„° ì—†ìŒ")

            time.sleep(0.5) # TR ì´ˆë‹¹ ìš”ì²­ íšŸìˆ˜ ì œí•œ ë°©ì–´

        except Exception as e:
            print(f"ì‹¤íŒ¨ ({e})")

    print(f"\nğŸ‰ '{save_dir}' í´ë”ì— ì´ {total}ê°œ ì¢…ëª© ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    sys.exit()


if __name__ == "__main__":
    main()
