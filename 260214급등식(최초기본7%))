# ==========================================
# 0. ê·¸ë˜í”½ ì—”ì§„ ì„¤ì • (íŒŒì¼ ì €ì¥ ëª¨ë“œ)
# ==========================================
import matplotlib

# í™”ë©´ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì—ì„œ ì´ë¯¸ì§€ ìƒì„± (ì¶©ëŒ ë°©ì§€)
matplotlib.use('Agg')

import backtrader as bt
import pandas as pd
import os
import math
from datetime import time
from collections import defaultdict


# ==========================================
# [ì „ëµ] ì¼ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ (+8% ì§€ì  ì •ë°€ íƒ€ê²©)
# ==========================================
class CustomDailyStrategy(bt.Strategy):
    """
    [ğŸ“¢ ì˜ì›…ë¬¸ [0150] ì¡°ê±´ê²€ìƒ‰ì‹ ì„¤ì • ê°€ì´ë“œ]
    ----------------------------------------------------------------------
    â€» ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ê³  [ì¡°ê±´ì¶”ê°€]ë¥¼ ëˆ„ë¥´ì„¸ìš”.
    â€» ëŒ€ìƒë³€ê²½: ê´€ë¦¬ì¢…ëª©, ê±°ë˜ì •ì§€, ì •ë¦¬ë§¤ë§¤, ETN, ìŠ¤íŒ©, ETF ì œì™¸ ì²´í¬

    A. [ê±°ë˜ëŒ€ê¸ˆ] [ì¼] 5000 ì´ìƒ (ë‹¨ìœ„:ë°±ë§Œ)
       (ì„¤ëª…: ë‹¹ì¼ ê±°ë˜ëŒ€ê¸ˆ 50ì–µ ì› ì´ìƒ)

    B. [ì£¼ê°€ë“±ë½ë¥ ] [ì¼] 1ë´‰ì „ ì¢…ê°€ ëŒ€ë¹„ 0ë´‰ì „ ê³ ê°€ ë“±ë½ë¥  7% ì´ìƒ
       (ì„¤ëª…: ì „ì¼ë³´ë‹¤ ê³ ê°€ê°€ 7% ì´ìƒ ìƒìŠ¹í•œ ì¢…ëª© - ì¥ëŒ€ì–‘ë´‰ ê°€ëŠ¥ì„±)

    C. [ì£¼ê°€ì´ë™í‰ê· ë¹„êµ] [ì¼] 0ë´‰ì „ 3ì´í‰ > 5ì´í‰ (ì¢…ê°€ê¸°ì¤€)
       (ì„¤ëª…: 3ì¼ì„ ì´ 5ì¼ì„ ë³´ë‹¤ ìœ„ì— ìˆëŠ” ì •ë°°ì—´ ìƒíƒœ)

    D. [ê°€ê²©-ì´ë™í‰ê· ë¹„êµ] [ì¼] 0ë´‰ì „ (ì¢…ê°€+ê³ ê°€+ì €ê°€)/3 >= 10ì´í‰
       (ì„¤ëª…: ë³¼ë¦°ì € ë°´ë“œ ì¤‘ì‹¬ì„ (10ì¼ ì´í‰)ë³´ë‹¤ ê°€ê²©ì´ ë†’ìŒ - Typical Price ê¸°ì¤€)

    ----------------------------------------------------------------------
    [ë§¤ë§¤ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •]
    - ì§„ì…: ì¥ì¤‘ +8% ê°€ê²© ë„ë‹¬ ì‹œ ì²´ê²° ê°€ì • (ì‹œê°€ ê°­ìƒìŠ¹ ì‹œ ì‹œê°€ ì²´ê²°)
    - ë§¤ë„: 3ì¼ ì´ë™í‰ê· ì„ ì´ 5ì¼ ì´ë™í‰ê· ì„ ì„ í•˜í–¥ ëŒíŒŒ(ë°ë“œí¬ë¡œìŠ¤) ì‹œ
    ----------------------------------------------------------------------
    """
    params = (
        ('ma_fast', 3),  # 3ì¼
        ('ma_slow', 5),  # 5ì¼
        ('boll_period', 10),  # ë³¼ë¦°ì €ë°´ë“œ ê¸°ê°„ (ì˜ì›…ë¬¸ ì…ë ¥ê°’)
        ('boll_dev', 2.0),  # ë³¼ë¦°ì €ë°´ë“œ ìŠ¹ìˆ˜ (ì˜ì›…ë¬¸ ì…ë ¥ê°’)
        ('debug', False),
    )

    def __init__(self):
        # ì´ë™í‰ê· ì„ 
        self.ma3 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_fast)
        self.ma5 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_slow)

        # ë³¼ë¦°ì € ë°´ë“œ (Typical Price ê¸°ì¤€)
        typical_price = (self.data.high + self.data.low + self.data.close) / 3.0
        self.bband = bt.indicators.BollingerBands(typical_price, period=self.p.boll_period, devfactor=self.p.boll_dev)

        self.order = None
        self.buy_size = 0
        self.trades_history = []

        # [í•µì‹¬] ì •ë°€ ì§„ì… ê°€ê²© ì €ì¥ ë³€ìˆ˜
        self.manual_entry_price = 0

    def notify_order(self, order):
        if order.status in [order.Completed]:
            if order.isbuy():
                self.buy_size = order.executed.size
            self.bar_executed = len(self)
        self.order = None

    def notify_trade(self, trade):
        if not trade.isclosed: return

        entry_price = self.manual_entry_price
        exit_price = trade.price

        if entry_price != 0:
            # ì‹¤ì œ ìˆ˜ìµê¸ˆ ì¬ê³„ì‚°
            real_pnl = (exit_price - entry_price) * abs(self.buy_size)
            # íˆ¬ìê¸ˆ ëŒ€ë¹„ ìˆ˜ìµë¥ 
            profit_pct = ((exit_price - entry_price) / entry_price) * 100
        else:
            profit_pct = 0.0
            real_pnl = 0

        # ë‚ ì§œ ì €ì¥ (ì—°ë„ë³„/ì›”ë³„ ë¶„ì„ìš©)
        close_date = bt.num2date(trade.dtclose)

        self.trades_history.append({
            'date': close_date,
            'profit_pct': profit_pct,
            'pnl': real_pnl,
            'is_win': real_pnl > 0
        })

    def next(self):
        if self.order: return
        if self.data.close[0] == 0: return

        # --------------------------------
        # [ë§¤ë„ ì¡°ê±´] 3ì¼ < 5ì¼ ë°ë“œí¬ë¡œìŠ¤
        # --------------------------------
        if self.position:
            if self.ma3[0] < self.ma5[0]:
                self.order = self.sell(size=self.position.size)
            return

        # --------------------------------
        # [ë§¤ìˆ˜ ì¡°ê±´] +8% ëŒíŒŒ ë§¤ë§¤
        # --------------------------------
        if not self.position:
            prev_close = self.data.close[-1]
            if prev_close == 0: return

            # [ì²´ê²° í™•ì¸ìš©] ëª©í‘œ ì§„ì…ê°€: ì „ì¼ ì¢…ê°€ + 8%
            target_price = prev_close * 1.08

            # ê³ ê°€ê°€ 8%ì— ë„ë‹¬í•˜ì§€ ëª»í–ˆë‹¤ë©´ ì²´ê²° ë¶ˆê°€
            if self.data.high[0] < target_price:
                return

            # ì§„ì… ê°€ê²© í™•ì •
            entry_price = max(self.data.open[0], target_price)

            # [ì¡°ê±´ A] ê±°ë˜ëŒ€ê¸ˆ: ì¼ ê±°ë˜ëŒ€ê¸ˆ 50ì–µ ì› ì´ìƒ
            trade_amount = self.data.close[0] * self.data.volume[0]
            if trade_amount < 5000000000:
                return

            # [ì¡°ê±´ B] ê³ ê°€ ë“±ë½ë¥ : ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ê³ ê°€ 7% ì´ìƒ
            high_change_pct = (self.data.high[0] - prev_close) / prev_close * 100
            if high_change_pct < 7.0:
                return

            # [ì¡°ê±´ C] ì •ë°°ì—´: 3ì¼ì„  > 5ì¼ì„ 
            if self.ma3[0] <= self.ma5[0]:
                return

            # [ì¡°ê±´ D] ë³¼ë¦°ì €ë°´ë“œ: ìƒë‹¨ì„ ë³´ë‹¤ ë†’ì€ ìœ„ì¹˜ (Typical Price ê¸°ì¤€)
            if self.data.close[0] <= self.bband.lines.top[0]:
                return

            # --- [ì§„ì… ì‹¤í–‰] ---
            cash = self.broker.getcash()
            bet_amount = 10000000  # 1,000ë§Œì› ê³ ì • ë² íŒ…

            if cash >= bet_amount:
                size = math.floor(bet_amount / entry_price)
                if size > 0:
                    self.order = self.buy(size=size)
                    self.manual_entry_price = entry_price


# ==========================================
# ì‹¤í–‰ í•¨ìˆ˜
# ==========================================
def run_single_backtest(file_path):
    try:
        df = pd.read_excel(file_path)
        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date'}
        df = df.rename(columns=rename_map)

        # ë°ì´í„° ì „ì²˜ë¦¬
        for col in ['Close', 'Open', 'High', 'Low', 'Volume']:
            if col in df.columns:
                df[col] = df[col].astype(float).abs()

        if 'Date' in df.columns:
            if df['Date'].dtype == 'object':
                df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            return None

        if len(df) < 60: return None

        # [ìˆ˜ì •] Cerebro ì´ˆê¸°í™” ì‹œ ì¸ì ì œê±° -> ë¸Œë¡œì»¤ ì„¤ì •ìœ¼ë¡œ ë³€ê²½
        cerebro = bt.Cerebro()
        cerebro.broker.set_coc(True)  # Cheat-On-Close í™œì„±í™” (ë‹¹ì¼ ì§„ì…)

        cerebro.addstrategy(CustomDailyStrategy)
        cerebro.adddata(bt.feeds.PandasData(dataname=df))

        cerebro.broker.setcash(100000000)
        cerebro.broker.setcommission(commission=0.00015)

        strats = cerebro.run()

        trades_hist = strats[0].trades_history
        if not trades_hist:
            return {'trades': 0, 'wins': 0, 'win_rate': 0, 'profit_rate': 0, 'total_profit': 0, 'history': []}

        total_trades = len(trades_hist)
        wins = sum(1 for t in trades_hist if t['is_win'])
        win_rate = (wins / total_trades * 100) if total_trades > 0 else 0

        total_profit = sum(t['pnl'] for t in trades_hist)
        total_profit_rate = sum(t['profit_pct'] for t in trades_hist)

        return {
            'trades': total_trades,
            'wins': wins,
            'win_rate': win_rate,
            'profit_rate': total_profit_rate,
            'total_profit': total_profit,
            'history': trades_hist
        }

    except Exception as e:
        # print(f"ì˜¤ë¥˜: {e}")
        return None


def generate_best_stock_chart(file_path, stock_name):
    try:
        print(f"\nğŸ¨ ìµœê³  ìˆ˜ìµ ì¢…ëª© [{stock_name}] ìƒì„¸ ë¶„ì„ ì¤‘...")

        df = pd.read_excel(file_path)
        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date'}
        df = df.rename(columns=rename_map)

        for col in ['Close', 'Open', 'High', 'Low', 'Volume']:
            if col in df.columns:
                df[col] = df[col].astype(float).abs()

        if df['Date'].dtype == 'object':
            df['Date'] = pd.to_datetime(df['Date'])
        df = df.sort_values('Date').set_index('Date')

        # [ìˆ˜ì •] ì°¨íŠ¸ ìƒì„± ì‹œì—ë„ set_coc ì ìš©
        cerebro = bt.Cerebro()
        cerebro.broker.set_coc(True)

        cerebro.addstrategy(CustomDailyStrategy)
        cerebro.adddata(bt.feeds.PandasData(dataname=df))
        cerebro.broker.setcash(100000000)
        cerebro.broker.setcommission(commission=0.00015)

        strats = cerebro.run()
        strat = strats[0]

        print(f"\nğŸ“œ [{stock_name}] ê°œë³„ ê²Œì„ë³„ ì„±ê³¼ ë¦¬í¬íŠ¸ (ì§„ì…ê°€: +8% ê°€ì •)")
        print(f"{'ë‚ ì§œ (ì²­ì‚°ì¼)':<15} | {'êµ¬ë¶„':<4} | {'ìˆ˜ìµê¸ˆ':>12} | {'ìˆ˜ìµë¥ ':>8}")
        print("-" * 50)

        trades_hist = strat.trades_history
        total_pnl = 0

        for t in trades_hist:
            date_str = t['date'].strftime('%Y-%m-%d')
            pnl = t['pnl']
            pct = t['profit_pct']
            mark = "ğŸ”ºìµì ˆ" if pnl > 0 else "ğŸ”¹ì†ì ˆ"

            print(f"{date_str:<15} | {mark:<4} | {pnl:>11,.0f}ì› | {pct:>7.2f}%")
            total_pnl += pnl

        print("-" * 50)
        print(f"ğŸ’° ì´ ëˆ„ì  ìˆ˜ìµ: {total_pnl:,.0f}ì›")

        plot_filename = f'best_chart_{stock_name}.png'
        print(f"\nğŸ“¸ ì°¨íŠ¸ ì´ë¯¸ì§€ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤... ({plot_filename})")
        figs = cerebro.plot(style='candlestick', barup='red', bardown='blue')
        for i, fig in enumerate(figs):
            for j, f in enumerate(fig):
                f.savefig(plot_filename)

        print(f"âœ… ì°¨íŠ¸ ì €ì¥ ì™„ë£Œ! '{plot_filename}'")

    except Exception as e:
        print(f"âŒ ì°¨íŠ¸ ìƒì„± ë° ë¶„ì„ ì‹¤íŒ¨: {e}")


def print_stats_table(stats_dict, title):
    print(f"\nğŸ“Š [{title} ì„±ê³¼ ë¶„ì„]")
    print(f"{'êµ¬ë¶„':<10} | {'ê²Œì„ìˆ˜':>5} | {'ìŠ¹ë¥ ':>7} | {'ëˆ„ì ìˆ˜ìµë¥ ':>10} | {'ì´ ìˆ˜ìµê¸ˆ':>15}")
    print("-" * 65)

    sorted_keys = sorted(stats_dict.keys())
    for key in sorted_keys:
        d = stats_dict[key]
        trades = d['trades']
        wins = d['wins']
        profit_sum = d['profit_sum']
        profit_pct_sum = d['profit_pct_sum']

        win_rate = (wins / trades * 100) if trades > 0 else 0

        mark = "ğŸ”´" if profit_sum > 0 else "ğŸ”µ"
        print(f"{key:<10} | {trades:5d}íšŒ | {win_rate:6.1f}% | {profit_pct_sum:9.2f}% | {profit_sum:14,.0f}ì› {mark}")
    print("-" * 65)


def main():
    print("=== ğŸ¯ [ì¼ë´‰ ì „ëµ] +8% ì§€ì  ì •ë°€ íƒ€ê²© ë§¤ë§¤ (10ë…„ì¹˜) ===")
    print("\n[ğŸ“¢ ì˜ì›…ë¬¸ ê²€ìƒ‰ì‹ ì¡°ê±´]")
    print("-" * 70)
    print("A. [ê±°ë˜ëŒ€ê¸ˆ] 5000 ì´ìƒ (50ì–µâ†‘)")
    print("B. [ì£¼ê°€ë“±ë½ë¥ ] ì „ì¼ì¢…ê°€ ëŒ€ë¹„ ê¸ˆì¼ê³ ê°€ 7% ì´ìƒ (8% ëŒíŒŒ ì‹œ ìë™ ë§Œì¡±)")
    print("C. [ì£¼ê°€ì´ë™í‰ê· ë¹„êµ] 3ì´í‰ > 5ì´í‰")
    print("D. [ê°€ê²©-ì´ë™í‰ê· ë¹„êµ] (ê³ +ì €+ì¢…)/3 >= 10ì´í‰ (Typical Price ê¸°ì¤€)")
    print("-" * 70 + "\n")

    data_dir = "stock_data_51"
    if not os.path.exists(data_dir):
        print(f"ğŸš¨ '{data_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return

    files = [os.path.join(data_dir, f) for f in os.listdir(data_dir) if f.endswith(".xlsx")]
    print(f"ğŸ“‚ ë¶„ì„ ëŒ€ìƒ: {len(files)}ê°œ ì¢…ëª©\n")

    print("-" * 85)
    print(f"{'ì¢…ëª©ëª…':<15} | {'ê²Œì„ìˆ˜':>5} | {'ìŠ¹ë¥ ':>6} | {'ìˆ˜ìµë¥ ':>8} | {'ì´ ìˆ˜ìµê¸ˆ':>12}")
    print("-" * 85)

    total_stats = {'trades': 0, 'profit': 0, 'wins': 0}
    best_stock = {'profit': -99999999999, 'name': '', 'file': ''}
    results = []

    all_trades_combined = []

    for file_path in files:
        stock_name = os.path.basename(file_path).split('_')[-1].replace('.xlsx', '')

        res = run_single_backtest(file_path)

        if res and res['trades'] > 0:
            results.append(res)

            total_stats['trades'] += res['trades']
            total_stats['profit'] += res['total_profit']
            total_stats['wins'] += res['wins']

            all_trades_combined.extend(res['history'])

            mark = "ğŸ”´" if res['total_profit'] > 0 else "ğŸ”µ"
            print(
                f"{stock_name:<15} | {res['trades']:5d}íšŒ | {res['win_rate']:5.1f}% | {res['profit_rate']:7.1f}% | {res['total_profit']:12,.0f}ì› {mark}")

            if res['total_profit'] > best_stock['profit']:
                best_stock = {'profit': res['total_profit'], 'name': stock_name, 'file': file_path}

    print("-" * 85)

    if all_trades_combined:
        yearly_stats = defaultdict(lambda: {'trades': 0, 'wins': 0, 'profit_sum': 0, 'profit_pct_sum': 0})
        for t in all_trades_combined:
            year = t['date'].strftime("%Y")
            yearly_stats[year]['trades'] += 1
            if t['is_win']: yearly_stats[year]['wins'] += 1
            yearly_stats[year]['profit_sum'] += t['pnl']
            yearly_stats[year]['profit_pct_sum'] += t['profit_pct']

        print_stats_table(yearly_stats, "ì—°ë„ë³„(Yearly)")

        avg_win_rate = (total_stats['wins'] / total_stats['trades'] * 100) if total_stats['trades'] > 0 else 0
        print(
            f"\nğŸ“Š [ì „ì²´ ìš”ì•½] ì´ {total_stats['trades']}íšŒ ë§¤ë§¤ | ìŠ¹ë¥  {avg_win_rate:.2f}% | ì´ ìˆ˜ìµ {total_stats['profit']:,.0f}ì›")

        if best_stock['name']:
            print(f"\nğŸ† ìµœê³  ìˆ˜ìµ ì¢…ëª©: [{best_stock['name']}] (+{best_stock['profit']:,.0f}ì›)")
            generate_best_stock_chart(best_stock['file'], best_stock['name'])
    else:
        print("\nâŒ ì¡°ê±´ì— ë§ëŠ” ë§¤ë§¤ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")


if __name__ == "__main__":
    main()
