# ==========================================
# ğŸ“Š [ìƒì„¸ ê±°ë˜ ë‚´ì—­ ë¦¬í¬íŠ¸] ë°´ë“œí­ 12% ì´ìƒ + RSI + ATR(%) + ADX + ì›”ë³„/ë…„ë„ë³„ ë¶„ì„ (ìˆ˜ì •íŒ)
# =================================================================================================================
# ì¢…ëª©ëª…          | ë§¤ìˆ˜ì¼       | ë§¤ë„ì¼       |     ë§¤ìˆ˜ê°€ |     ë§¤ë„ê°€ |  ìˆ˜ìµë¥  | ìµœëŒ€ìˆ˜ìµë¥  |   RSI |  ATR(%) |   ADX
# -----------------------------------------------------------------------------------------------------------------
# ...
# =================================================================================================================
import matplotlib

# í™”ë©´ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì—ì„œ ì´ë¯¸ì§€ ìƒì„± (ì¶©ëŒ ë°©ì§€)
matplotlib.use('Agg')

import backtrader as bt
import pandas as pd
import os
import math
from datetime import time, timedelta
from collections import defaultdict
import matplotlib.pyplot as plt


# -----------------------------------------------------------------------------
# CustomPandasData í´ë˜ìŠ¤:
# ë°±í…ŒìŠ¤í„°(Backtrader)ì— ë°ì´í„°ë¥¼ ê³µê¸‰í•˜ê¸° ìœ„í•´ Pandas ë°ì´í„°í”„ë ˆì„ êµ¬ì¡°ë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤.
# ê¸°ì¡´ ì‹œê°€, ê³ ê°€, ì €ê°€, ì¢…ê°€, ê±°ë˜ëŸ‰ ì™¸ì— 'rsi' ì§€í‘œë¥¼ ì¶”ê°€ë¡œ ì¸ì‹í•  ìˆ˜ ìˆê²Œ ì„¤ì •í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------
# [ìˆ˜ì •] ë°ì´í„° íŒŒì¼ì˜ ì»¬ëŸ¼ëª…(ëŒ€ë¬¸ì)ê³¼ Backtrader ë‚´ë¶€ ë¼ì¸ì„ ë§¤í•‘
class CustomPandasData(bt.feeds.PandasData):
    lines = ('rsi',)
    params = (
        ('datetime', None),  # ì¸ë±ìŠ¤ë¥¼ ë‚ ì§œë¡œ ì‚¬ìš©
        ('open', 'Open'),  # íŒŒì¼ì˜ 'Open' ì»¬ëŸ¼
        ('high', 'High'),  # íŒŒì¼ì˜ 'High' ì»¬ëŸ¼
        ('low', 'Low'),  # íŒŒì¼ì˜ 'Low' ì»¬ëŸ¼
        ('close', 'Close'),  # íŒŒì¼ì˜ 'Close' ì»¬ëŸ¼
        ('volume', 'Volume'),  # íŒŒì¼ì˜ 'Volume' ì»¬ëŸ¼
        ('openinterest', None),  # OpenInterest ì—†ìŒ
        ('rsi', 'rsi'),  # ê³„ì‚°ëœ 'rsi' ì»¬ëŸ¼ ì‚¬ìš©
    )


# -----------------------------------------------------------------------------
# calculate_rsi í•¨ìˆ˜:
# Pandas Seriesë¥¼ ë°›ì•„ 14ì¼ ê¸°ì¤€ RSI(ìƒëŒ€ê°•ë„ì§€ìˆ˜)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
# ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„ì— ë“¤ì–´ê°€ê¸° ì „, ë°ì´í„° ì „ì²˜ë¦¬ ë‹¨ê³„ì—ì„œ ë¨¼ì € ê³„ì‚°ì„ ìˆ˜í–‰í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------
# [ì¶”ê°€] RSI ê³„ì‚° í•¨ìˆ˜ (ë°ì´í„° ì „ì²˜ë¦¬ìš©)
def calculate_rsi(series, period=14):
    delta = series.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    return 100 - (100 / (1 + rs))


# ==========================================
# [ì „ëµ] ì¼ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + ë°´ë“œí­ êµ¬ê°„ í•„í„° + ì •ë°€ ë§¤ë„
# ==========================================
class CustomDailyStrategy(bt.Strategy):
    """
    [ìƒì„¸ ì „ëµ ì„¤ëª…]
    ================================================================================
    1. ë§¤ìˆ˜ ì§„ì… ì¡°ê±´ (ëª¨ë‘ ë§Œì¡± ì‹œ)
       A. [ë³€ë™ì„± ëŒíŒŒ] ì˜¤ëŠ˜ ê³ ê°€ > Max(ì „ì¼ì¢…ê°€+5%, ì •ë°°ì—´ì „í™˜ê°€)
          - ì¶”ê°€: ìµœê·¼ 2ë´‰ ì´ë‚´ì— ëª©í‘œ ìƒìŠ¹ë¥ (target_pct) ì´ìƒì˜ ê³ ê°€ í˜•ì„± ì´ë ¥ì´ ì—†ì„ ê²ƒ
       B. [ìœ ë™ì„±] ì „ì¼ ê±°ë˜ëŒ€ê¸ˆ 50ì–µ ì› ì´ìƒ
       C. [ì¶”ì„¸] ë‹¹ì¼ ê¸°ì¤€ 3ì¼ì„  > 5ì¼ì„  ì •ë°°ì—´
       D. [ìˆ˜ë ´] ì „ì¼ ê¸°ì¤€ ë°´ë“œí­ 12% ì´ìƒ
       E. [ì¶”ê°€] ë§¤ìˆ˜ê°€ ëŒ€ë¹„ ATR(%) 1% ì´ˆê³¼ 4% ë¯¸ë§Œ
       F. [ì¶”ê°€] ADX 60 ì´ìƒ 80 ì´í•˜
    ================================================================================
    """
    params = (
        ('target_pct', 0.05),  # 5%
        ('ma_fast', 3),  # 3ì¼
        ('ma_slow', 5),  # 5ì¼
        ('boll_period', 20),  # ë³¼ë¦°ì €ë°´ë“œ ê¸°ê°„
        ('boll_dev', 2.0),  # ë³¼ë¦°ì €ë°´ë“œ ìŠ¹ìˆ˜
        ('bandwidth_min', 0.12),  # ë°´ë“œí­ ìµœì†Œê°’
        ('bandwidth_max', 100.0),  # ë°´ë“œí­ ìµœëŒ€ê°’
        ('debug', False),  # ë””ë²„ê·¸ ëª¨ë“œ
    )

    def __init__(self):
        # ë‹¨ê¸°(3ì¼) ë° ì¤‘ê¸°(5ì¼) ì´ë™í‰ê· ì„  ì§€í‘œ ì„¤ì •
        self.ma3 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_fast)
        self.ma5 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_slow)

        # ë³¼ë¦°ì €ë°´ë“œ ì§€í‘œ ì„¤ì • (ê³ ê°€, ì €ê°€, ì¢…ê°€ì˜ í‰ê· ì¸ Typical Price ê¸°ì¤€)
        typical_price = (self.data.high + self.data.low + self.data.close) / 3.0
        self.bband = bt.indicators.BollingerBands(typical_price, period=self.p.boll_period, devfactor=self.p.boll_dev)

        # [ì¶”ê°€] ATR ë° ADX ì§€í‘œ (ì¶”ì„¸ì˜ ê°•ë„ì™€ ë³€ë™ì„±ì„ ì¸¡ì •í•˜ê¸° ìœ„í•´ 14ì¼ ê¸°ì¤€ ì„¤ì •)
        self.atr = bt.indicators.ATR(self.data, period=14)
        self.adx = bt.indicators.ADX(self.data, period=14)

        # ìˆ˜ë™ í¬ì§€ì…˜ ê´€ë¦¬ìš© ë³€ìˆ˜ (Backtrader ë‚´ì¥ ë¸Œë¡œì»¤ë¥¼ ì“°ì§€ ì•Šê³  ì •ë°€í•œ ìì²´ ê¸°ë¡ì„ ìœ„í•´ ì‚¬ìš©)
        self.my_position = None
        self.trades_history = []
        self.peak_price = 0  # ì§„ì… ì´í›„ ìµœê³ ê°€ ì¶”ì  (ìµœëŒ€ ìˆ˜ìµë¥  ê³„ì‚°ìš©)

    def next(self):
        # ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬: ì´ë™í‰ê· ì„ ê³¼ ë³¼ë¦°ì €ë°´ë“œë¥¼ ê³„ì‚°í•  ìˆ˜ ìˆëŠ” ì¶©ë¶„í•œ ë°ì´í„°ê°€ ëª¨ì¼ ë•Œê¹Œì§€ ëŒ€ê¸°
        if len(self.data) < max(self.p.ma_slow + 2, self.p.boll_period + 2, 30):
            return

        current_date = self.data.datetime.date(0)

        # ----------------------------------------------------------------------
        # [1] ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ë„(ì²­ì‚°) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position:
            # ìµœê³ ê°€ ê°±ì‹ : ì§„ì… ì´í›„ ê°€ì¥ ë†’ì•˜ë˜ ê°€ê²©ì„ ê¸°ë¡ (ìµœëŒ€ ìˆ˜ìµë¥  ê³„ì‚° ëª©ì )
            if self.data.high[0] > self.peak_price:
                self.peak_price = self.data.high[0]

            # ë°ë“œí¬ë¡œìŠ¤ ë°©ì–´ ê°€ê²© ê³„ì‚° (ì˜¤ëŠ˜ ê¸°ì¤€): ë‹¨ê¸° ì´í‰ì„ ì´ ì¤‘ê¸° ì´í‰ì„ ì„ í•˜í–¥ ì´íƒˆí•˜ê²Œ ë§Œë“œëŠ” ì˜ˆì¸¡ ê°€ê²©
            c_1 = self.data.close[-1]
            c_2 = self.data.close[-2]
            c_3 = self.data.close[-3]
            c_4 = self.data.close[-4]

            cross_price_raw = 1.5 * (c_3 + c_4) - (c_1 + c_2)
            cross_price = round(cross_price_raw)

            sell_signal = False
            sell_price = 0
            sell_reason = ""

            # ë§¤ë„ ì¡°ê±´ 1: ì „ì¼ì— ì´ë¯¸ ë‹¨ê¸°ì„ ì´ ì¤‘ê¸°ì„  ì•„ë˜ë¡œ ë‚´ë ¤ê°„(ë°ë“œí¬ë¡œìŠ¤) ìƒíƒœë¼ë©´, ì˜¤ëŠ˜ ì‹œê°€ì— ì¦‰ì‹œ ì‹œì¥ê°€ ë§¤ë„
            if self.ma3[-1] < self.ma5[-1]:
                sell_signal = True
                sell_price = self.data.open[0]
                sell_reason = "ì „ì¼ ì´ë¯¸ ë°ë“œí¬ë¡œìŠ¤ ìƒíƒœ"
            # ë§¤ë„ ì¡°ê±´ 2: ì¥ì¤‘ ìµœì €ê°€ê°€ ë°ë“œí¬ë¡œìŠ¤ ë°©ì–´ ê°€ê²©ì„ ì´íƒˆí•œ ê²½ìš°
            elif self.data.low[0] <= cross_price:
                sell_signal = True
                # ë§Œì•½ ì˜¤ëŠ˜ ì‹œê°€ë¶€í„° ê°­í•˜ë½í•˜ì—¬ ë°ë“œí¬ë¡œìŠ¤ ê°€ê²© ì•„ë˜ì—ì„œ ì¶œë°œí–ˆë‹¤ë©´ ì‹œê°€ì— ë§¤ë„
                if self.data.open[0] < cross_price:
                    sell_price = self.data.open[0]
                    sell_reason = "ê°­í•˜ë½ ë°ë“œí¬ë¡œìŠ¤"
                # ì •ìƒì ìœ¼ë¡œ ì‹œì‘ í›„ ì¥ì¤‘ì— í•˜ë½í•˜ì—¬ í„°ì¹˜í–ˆë‹¤ë©´ í•´ë‹¹ ê°€ê²©(cross_price)ì— ë§¤ë„
                else:
                    sell_price = cross_price
                    sell_reason = "ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ í„°ì¹˜"

            if sell_signal:
                # ë§¤ë„ ì‹ í˜¸ ë°œìƒ ì‹œ ìˆ˜ìµê¸ˆ, ìˆ˜ìµë¥  ë“±ì„ ê³„ì‚°í•˜ì—¬ ê±°ë˜ ê¸°ë¡(trades_history)ì— ë‚¨ê¹€
                entry_price = self.my_position['price']
                buy_size = self.my_position['size']
                buy_reason = self.my_position['reason']
                entry_rsi = self.my_position.get('rsi', 0)
                entry_atr = self.my_position.get('atr', 0)
                entry_adx = self.my_position.get('adx', 0)
                entry_bandwidth = self.my_position.get('bandwidth', 0)
                open_date = self.my_position['date']

                pnl = (sell_price - entry_price) * buy_size
                profit_pct = ((sell_price - entry_price) / entry_price) * 100
                max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100

                self.trades_history.append({
                    'open_date': open_date,
                    'date': current_date,
                    'profit_pct': profit_pct,
                    'max_profit_pct': max_profit_pct,
                    'pnl': pnl,
                    'is_win': pnl > 0,
                    'entry_price': entry_price,
                    'exit_price': sell_price,
                    'entry_rsi': entry_rsi,
                    'entry_atr': entry_atr,
                    'entry_adx': entry_adx,
                    'entry_bandwidth': entry_bandwidth,
                    'size': buy_size,
                    'status': 'Closed',
                    'buy_reason': buy_reason,
                    'sell_reason': sell_reason
                })
                self.my_position = None
                self.peak_price = 0
                return

        # ----------------------------------------------------------------------
        # [2] ë¯¸ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ìˆ˜(ì§„ì…) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position is None:
            # [ì¡°ê±´ A] ë³€ë™ì„± ëŒíŒŒ: ë‹¹ì¼ ê³ ê°€ê°€ ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ëª©í‘œ ìˆ˜ìµë¥ (5%) ì´ìƒ ìƒìŠ¹í•´ì•¼ í•¨
            prev_close = self.data.close[-1]
            target_price = prev_close * (1 + self.p.target_pct)
            target_price = math.ceil(target_price)

            if self.data.high[0] < target_price:
                return

            # [ì¡°ê±´ A-1] ê¸‰ë“± ë°©ì§€: ìµœê·¼ 2ë´‰ ì´ë‚´ì— ì´ë¯¸ 5% ì´ìƒ ê¸‰ë“±í•œ ê³ ê°€ë¥¼ í˜•ì„±í•œ ì ì´ ì—†ì–´ì•¼ í•¨
            if (self.data.high[-1] / self.data.close[-2] - 1) > self.p.target_pct:
                return

            if (self.data.high[-2] / self.data.close[-3] - 1) > self.p.target_pct:
                return

            # [ì¡°ê±´ B] ìœ ë™ì„±: ì „ì¼ ê±°ë˜ëŒ€ê¸ˆì´ 50ì–µ ì› ì´ìƒì´ì–´ì•¼ í•¨ (ì•ˆì •ì ì¸ ê±°ë˜ëŸ‰ ë° í™˜ê¸ˆì„± í™•ë³´)
            trade_amount = self.data.close[-1] * self.data.volume[-1]
            if trade_amount < 50000000000:  # 500ì–µ
                return

            # [ì¡°ê±´ C] ì¶”ì„¸: ë‹¹ì¼ ê¸°ì¤€ 3ì¼ ì´ë™í‰ê· ì„ ì´ 5ì¼ ì´ë™í‰ê· ì„  ìœ„ì— ìˆì–´ì•¼ í•¨ (ì •ë°°ì—´)
            if self.ma3[-1] <= self.ma5[-1]: return

            # C-2. RSIì¡°ê±´ (50~80ì¸ ê²ƒë§Œ ì§„ì…) -> [ìˆ˜ì •] ì „ì¼ ê¸°ì¤€
            if self.data.rsi[-1] >= 80:
                return
            if self.data.rsi[-1] <= 50:
                return

            # [ì¡°ê±´ D] ìˆ˜ë ´ í•„í„°: ì „ì¼ ê¸°ì¤€ ë³¼ë¦°ì €ë°´ë“œì˜ ë°´ë“œí­ì´ ì„¤ì •ëœ ìµœì†Œì¹˜(12%) ì´ìƒì´ì–´ì•¼ í•¨
            top = self.bband.lines.top[-1]
            bot = self.bband.lines.bot[-1]
            mid = self.bband.lines.mid[-1]

            if mid == 0: return
            bandwidth = (top - bot) / mid

            if not (self.p.bandwidth_min <= bandwidth < self.p.bandwidth_max):
                return

            # ì •ë°°ì—´ ì „í™˜ê°€ ê³„ì‚°: ì¶”ì„¸ê°€ êº¾ì´ì§€ ì•Šê³  ìƒìŠ¹ìœ¼ë¡œ í„´ì–´ë¼ìš´ë“œ í•˜ëŠ” ê²ƒì„ í™•ì¸í•˜ê¸° ìœ„í•œ ë°©ì–´ ê°€ê²©
            c_1 = self.data.close[-1]
            c_2 = self.data.close[-2]
            c_3 = self.data.close[-3]
            c_4 = self.data.close[-4]

            golden_cross_price_raw = 1.5 * (c_3 + c_4) - (c_1 + c_2)
            golden_cross_price = math.ceil(golden_cross_price_raw)

            # ìµœì¢… ë§¤ìˆ˜ ìš”êµ¬ ê°€ê²©: ëª©í‘œê°€(ì „ì¼ì¢…ê°€+5%)ì™€ ì •ë°°ì—´ ì „í™˜ê°€ ì¤‘ ë” ë†’ì€ ê°€ê²©ì„ ê¸°ì¤€ìœ¼ë¡œ ì‚¼ìŒ
            buy_req_price = max(target_price, golden_cross_price)

            # ì‹¤ì œ ë§¤ìˆ˜ê°€ ê²°ì •: ì¥ ì‹œì‘(ì‹œê°€)ë¶€í„° ìš”êµ¬ê°€ê²©ì„ ë„˜ì—ˆë‹¤ë©´ ì‹œê°€ì— ì§„ì…, ì¥ì¤‘ ëŒíŒŒë¼ë©´ ìš”êµ¬ê°€ê²©ì— ì§„ì…
            buy_price = 0
            if self.data.open[0] > buy_req_price:
                buy_price = self.data.open[0]
            else:
                buy_price = buy_req_price

            # ì˜¤ëŠ˜ ê³ ê°€ê°€ ìµœì¢… ë§¤ìˆ˜ ìš”êµ¬ ê°€ê²©ì— ë¯¸ì¹˜ì§€ ëª»í–ˆë‹¤ë©´ ë§¤ìˆ˜ ì¡°ê±´ ë¯¸ë‹¬ë¡œ íŒ¨ìŠ¤
            if self.data.high[0] < buy_req_price:
                return

            # [ì¡°ê±´ E] ë³€ë™ì„± í•„í„°: ë§¤ìˆ˜ ì‹œì ì˜ ATR(%)ì´ ë§¤ìˆ˜ê°€ ëŒ€ë¹„ 1% ì´ˆê³¼ 4% ë¯¸ë§Œì´ì–´ì•¼ í•¨
            atr_pct = (self.atr[-1] / buy_price * 100) if buy_price > 0 else 0
            #if not (1 < atr_pct < 4):
            #    return

            # [ì¡°ê±´ F] ì¶”ì„¸ ê°•ë„: ADX ê°’ì´ 60 ì´ìƒ 80 ì´í•˜ë¡œ ê°•í•œ ì¶”ì„¸ êµ¬ê°„ì´ì–´ì•¼ í•¨
            #if not (60 <= self.adx[-1] <= 80):
            #    return

            # ìê¸ˆ ê´€ë¦¬: ì´ˆê¸° ì‹œë“œ 1,000ë§Œ ì› ê¸°ì¤€ìœ¼ë¡œ ë§¤ìˆ˜ ê°€ëŠ¥í•œ ìˆ˜ëŸ‰(ì •ìˆ˜)ì„ ê³„ì‚°
            cash = 10000000
            size = math.floor(cash / buy_price)

            # ë§¤ìˆ˜ í¬ì§€ì…˜ ê¸°ë¡: ë‚´ì¥ ë¸Œë¡œì»¤ ëŒ€ì‹  ë”•ì…”ë„ˆë¦¬ë¥¼ í™œìš©í•˜ì—¬ RSI, ATR, ADX ë“± ë¶„ì„ì— í•„ìš”í•œ ëª¨ë“  ê°’ì„ ìˆ˜ë™ ê¸°ë¡
            buy_reason = "ì¡°ê±´ ë§Œì¡± ì§„ì…"
            self.my_position = {
                'price': buy_price,
                'date': current_date,
                'size': size,
                'reason': buy_reason,
                'rsi': self.data.rsi[-1],
                'atr': self.atr[-1],
                'adx': self.adx[-1],
                'bandwidth': bandwidth
            }
            self.peak_price = buy_price

    def stop(self):
        # ë°±í…ŒìŠ¤íŠ¸ê°€ ì™„ì „íˆ ì¢…ë£Œë˜ëŠ” ë§ˆì§€ë§‰ ë‚ (ë§ˆì§€ë§‰ ìº”ë“¤)ì— ì²­ì‚°ë˜ì§€ ì•Šì€ í¬ì§€ì…˜ì´ ë‚¨ì•„ìˆë‹¤ë©´ ê°•ì œë¡œ ì¢…ê°€ì— ì²­ì‚° ì²˜ë¦¬
        if self.my_position:
            current_date = self.data.datetime.date(0)
            current_price = self.data.close[0]
            entry_price = self.my_position['price']
            buy_size = self.my_position['size']

            if current_price > self.peak_price:
                self.peak_price = current_price

            pnl = (current_price - entry_price) * buy_size
            profit_pct = ((current_price - entry_price) / entry_price) * 100
            max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100
            entry_rsi = self.my_position.get('rsi', 0)
            entry_atr = self.my_position.get('atr', 0)
            entry_adx = self.my_position.get('adx', 0)
            entry_bandwidth = self.my_position.get('bandwidth', 0)

            self.trades_history.append({
                'open_date': self.my_position['date'],
                'date': current_date,
                'profit_pct': profit_pct,
                'max_profit_pct': max_profit_pct,
                'pnl': pnl,
                'is_win': pnl > 0,
                'entry_price': entry_price,
                'exit_price': current_price,
                'entry_rsi': entry_rsi,
                'entry_atr': entry_atr,
                'entry_adx': entry_adx,
                'entry_bandwidth': entry_bandwidth,
                'size': buy_size,
                'status': 'Holding',
                'buy_reason': 'ì¢…ë£Œ ì²­ì‚°',
                'sell_reason': 'ì¢…ë£Œ ì²­ì‚°'
            })


# ==========================================
# ì‹¤í–‰ í•¨ìˆ˜ (ë‹¨ì¼ êµ¬ê°„)
# íŠ¹ì • ì¢…ëª©(ì—‘ì…€ íŒŒì¼)ì„ í•˜ë‚˜ ì½ì–´ì™€ì„œ ë‚ ì§œ/ìˆ«ì ì „ì²˜ë¦¬ë¥¼ ì§„í–‰í•œ í›„,
# Backtrader ì—”ì§„ì— ì£¼ì…í•˜ì—¬ í•´ë‹¹ ë‹¨ì¼ ì¢…ëª©ì— ëŒ€í•œ ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
# ==========================================
def run_single_backtest(file_path, target_pct, bandwidth_min, bandwidth_max, is_first_run=False):
    try:
        df = pd.read_excel(file_path)
        df.columns = [c.strip() for c in df.columns]

        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date'}
        df = df.rename(columns=rename_map)

        if 'Date' in df.columns:
            if pd.api.types.is_numeric_dtype(df['Date']):
                df['Date'] = df['Date'].astype(str)
            df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            if not isinstance(df.index, pd.DatetimeIndex):
                return None

        df = df[df.index >= '2024-01-01']

        cols_to_numeric = ['Close', 'Open', 'High', 'Low', 'Volume']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()
            else:
                return None

        df = df.dropna(subset=[c for c in cols_to_numeric if c in df.columns])

        if len(df) >= 14:
            df['rsi'] = calculate_rsi(df['Close'], period=14)
            df['rsi'] = df['rsi'].fillna(50)
        else:
            df['rsi'] = 50

        if len(df) < 30:
            return None

        cerebro = bt.Cerebro(runonce=False)
        cerebro.broker.setcash(100000000)

        cerebro.addstrategy(CustomDailyStrategy,
                            target_pct=target_pct,
                            bandwidth_min=bandwidth_min,
                            bandwidth_max=bandwidth_max,
                            debug=is_first_run)

        cerebro.adddata(CustomPandasData(dataname=df))

        strats = cerebro.run()
        trades_hist = strats[0].trades_history

        return {
            'trades': len(trades_hist),
            'wins': sum(1 for t in trades_hist if t['is_win']),
            'total_profit': sum(t['pnl'] for t in trades_hist),
            'history': trades_hist
        }

    except Exception as e:
        if is_first_run: print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        return None


def main():
    # ì „ì²´ ë©”ì¸ ì‹¤í–‰ íë¦„:
    # 1. ì„¤ì •ëœ í´ë”ì—ì„œ ì—‘ì…€ íŒŒì¼(ì£¼ì‹ ë°ì´í„°) ëª©ë¡ì„ ìŠ¤ìº”í•©ë‹ˆë‹¤.
    # 2. ê° ì¢…ëª©ë³„ë¡œ run_single_backtestë¥¼ í˜¸ì¶œí•˜ì—¬ ê°œë³„ ë§¤ë§¤ ë‚´ì—­ì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
    # 3. ìˆ˜ì§‘ëœ ëª¨ë“  ê±°ë˜ë¥¼ í•©ì‚°í•˜ì—¬ ì´ ìˆ˜ìµ, ìŠ¹ë¥ ì„ ê³„ì‚°í•˜ê³  êµ¬ê°„ë³„(RSI, ATR, ADX, ì›”ë³„, ì—°ë„ë³„) í†µê³„ ë¦¬í¬íŠ¸ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
    print(CustomDailyStrategy.__doc__)
    print("=== ğŸ¯ [ì¼ë´‰ ì „ëµ] ê°œë³„ ê²Œì„ë³„ ìƒì„¸ ì„±ê³¼ ë¦¬í¬íŠ¸ ===")
    print("ğŸ“Œ ì„¤ì •: ë³¼ë¦°ì €ë°´ë“œ(20, 2), ë°´ë“œí­ 12% ì´ìƒ, í™•ì¸ ë§¤ë§¤(ë‹¹ì¼ ì²´ê²°)")
    print("ğŸ“Œ ê¸°ê°„: 2025-01-01 ~ í˜„ì¬")

    data_dir = ("stock_data_kospi200")
    if not os.path.exists(data_dir):
        print(f"ğŸš¨ '{data_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return

    files = [os.path.join(data_dir, f) for f in os.listdir(data_dir) if f.endswith(".xlsx")]
    print(f"ğŸ“‚ ë¶„ì„ ëŒ€ìƒ: {len(files)}ê°œ ì¢…ëª©\n")

    target_pct = 0.05
    bw_min = 0.12
    bw_max = 100.0

    print(f"\nğŸ“Š [ì „ì²´ ê±°ë˜ ë‚´ì—­ ìƒì„¸]")
    print("=" * 152)
    print(
        f"{'ì¢…ëª©ëª…':<12} | {'ë§¤ìˆ˜ì¼':<10} | {'ë§¤ë„ì¼':<10} | {'ë§¤ìˆ˜ê°€':>9} | {'ë§¤ë„ê°€':>9} | {'ìˆ˜ìµë¥ ':>7} | {'ìµœëŒ€ìˆ˜ìµë¥ ':>9} | {'RSI':>6} | {'ATR(%)':>8} | {'ADX':>6} | {'ë°´ë“œí­(%)':>7}")
    print("-" * 152)

    total_stats = {'trades': 0, 'profit': 0, 'wins': 0, 'slippage': 0}
    all_history = []

    rsi_stats = {
        '50 ì´í•˜': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '50ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '60ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '70ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '80ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '90ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
    }

    # [ìˆ˜ì •] ATR ë¶„ì„ìš© ë”•ì…”ë„ˆë¦¬ë¥¼ ë°±ë¶„ìœ¨ êµ¬ê°„ìœ¼ë¡œ ë³€ê²½
    atr_stats = {
        '2% ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '2%~4%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '4%~6%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '6%~8%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '8% ì´ìƒ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
    }

    adx_stats = {
        '20 ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '20~40': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '40~60': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '60~80': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '80 ì´ìƒ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
    }

    # [ì¶”ê°€] ë°´ë“œí­ ë¶„ì„ìš© ë”•ì…”ë„ˆë¦¬
    bw_stats = {
        '6% ë¯¸ë§Œ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '6~8%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '8~10%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '10~12%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '12~14%': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '14% ì´ìƒ': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
    }

    monthly_stats = defaultdict(lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0})
    yearly_stats = defaultdict(lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0})

    for idx, file_path in enumerate(files):
        stock_name = os.path.basename(file_path).split('_')[-1].replace('.xlsx', '')
        is_first = (idx == 0)
        res = run_single_backtest(file_path, target_pct, bw_min, bw_max, is_first_run=is_first)

        if res and res['trades'] > 0:
            total_stats['trades'] += res['trades']
            total_stats['profit'] += res['total_profit']
            total_stats['wins'] += res['wins']

            for t in res['history']:
                t['stock_name'] = stock_name
                all_history.append(t)

                close_date_str = t['date'] if isinstance(t['date'], str) else t['date'].strftime('%Y-%m-%d')
                open_date_str = t['open_date'] if isinstance(t['open_date'], str) else t['open_date'].strftime(
                    '%Y-%m-%d')

                profit_pct = t['profit_pct']
                max_profit_pct = t.get('max_profit_pct', 0.0)
                entry_price = t['entry_price']
                exit_price = t['exit_price']
                rsi_val = t.get('entry_rsi', 0)
                # [ìˆ˜ì •] ATR ê°’ì„ ë§¤ìˆ˜ê°€ ëŒ€ë¹„ ë°±ë¶„ìœ¨(%)ë¡œ ê³„ì‚°
                atr_raw = t.get('entry_atr', 0)
                atr_val = (atr_raw / entry_price * 100) if entry_price > 0 else 0
                adx_val = t.get('entry_adx', 0)

                # [ì¶”ê°€] ì „ì¼ê¸°ì¤€ ë°´ë“œí­ ê°’ ë°±ë¶„ìœ¨ ê³„ì‚°
                bw_raw = t.get('entry_bandwidth', 0)
                bw_pct = bw_raw * 100

                buy_size = t.get('size', 0)
                slippage_cost = entry_price * buy_size * 0.01

                total_stats['slippage'] += slippage_cost

                # RSI ì§‘ê³„
                bucket = ""
                if rsi_val <= 50:
                    bucket = '50 ì´í•˜'
                elif rsi_val < 60:
                    bucket = '50ëŒ€'
                elif rsi_val < 70:
                    bucket = '60ëŒ€'
                elif rsi_val < 80:
                    bucket = '70ëŒ€'
                elif rsi_val < 90:
                    bucket = '80ëŒ€'
                else:
                    bucket = '90ëŒ€'
                if bucket:
                    rsi_stats[bucket]['games'] += 1
                    rsi_stats[bucket]['profit'] += t['pnl']
                    rsi_stats[bucket]['slippage'] += slippage_cost
                    if t['is_win']: rsi_stats[bucket]['wins'] += 1

                # [ìˆ˜ì •] ATR ì§‘ê³„ (ë°±ë¶„ìœ¨ êµ¬ê°„ ê¸°ì¤€)
                a_bucket = ""
                if atr_val < 2:
                    a_bucket = '2% ë¯¸ë§Œ'
                elif atr_val < 4:
                    a_bucket = '2%~4%'
                elif atr_val < 6:
                    a_bucket = '4%~6%'
                elif atr_val < 8:
                    a_bucket = '6%~8%'
                else:
                    a_bucket = '8% ì´ìƒ'
                atr_stats[a_bucket]['games'] += 1
                atr_stats[a_bucket]['profit'] += t['pnl']
                atr_stats[a_bucket]['slippage'] += slippage_cost
                if t['is_win']: atr_stats[a_bucket]['wins'] += 1

                # [ì¶”ê°€] ADX ì§‘ê³„
                dx_bucket = ""
                if adx_val < 20:
                    dx_bucket = '20 ë¯¸ë§Œ'
                elif adx_val < 40:
                    dx_bucket = '20~40'
                elif adx_val < 60:
                    dx_bucket = '40~60'
                elif adx_val < 80:
                    dx_bucket = '60~80'
                else:
                    dx_bucket = '80 ì´ìƒ'
                adx_stats[dx_bucket]['games'] += 1
                adx_stats[dx_bucket]['profit'] += t['pnl']
                adx_stats[dx_bucket]['slippage'] += slippage_cost
                if t['is_win']: adx_stats[dx_bucket]['wins'] += 1

                # [ì¶”ê°€] ë°´ë“œí­ ì§‘ê³„
                b_bucket = ""
                if bw_pct < 6:
                    b_bucket = '6% ë¯¸ë§Œ'
                elif bw_pct < 8:
                    b_bucket = '6~8%'
                elif bw_pct < 10:
                    b_bucket = '8~10%'
                elif bw_pct < 12:
                    b_bucket = '10~12%'
                elif bw_pct < 14:
                    b_bucket = '12~14%'
                else:
                    b_bucket = '14% ì´ìƒ'
                bw_stats[b_bucket]['games'] += 1
                bw_stats[b_bucket]['profit'] += t['pnl']
                bw_stats[b_bucket]['slippage'] += slippage_cost
                if t['is_win']: bw_stats[b_bucket]['wins'] += 1

                # ì›”ë³„/ë…„ë„ë³„ ì§‘ê³„
                dt_obj = t['open_date'] if not isinstance(t['open_date'], str) else pd.to_datetime(t['open_date'])
                ym = dt_obj.strftime('%Y-%m')
                y = dt_obj.strftime('%Y')

                monthly_stats[ym]['games'] += 1
                monthly_stats[ym]['profit'] += t['pnl']
                monthly_stats[ym]['slippage'] += slippage_cost
                if t['is_win']: monthly_stats[ym]['wins'] += 1

                yearly_stats[y]['games'] += 1
                yearly_stats[y]['profit'] += t['pnl']
                yearly_stats[y]['slippage'] += slippage_cost
                if t['is_win']: yearly_stats[y]['wins'] += 1

                mark = "ğŸ”´" if profit_pct > 0 else "ğŸ”µ"
                print(
                    f"{stock_name:<12} | {open_date_str:<10} | {close_date_str:<10} | {entry_price:9,.0f} | {exit_price:9,.0f} | "
                    f"{profit_pct:6.2f}% | {max_profit_pct:8.2f}% | {rsi_val:6.1f} | {atr_val:7.2f}% | {adx_val:6.1f} | {bw_pct:7.2f}% {mark}")

    print("=" * 152)

    avg_win_rate = (total_stats['wins'] / total_stats['trades'] * 100) if total_stats['trades'] > 0 else 0
    total_virtual_profit = total_stats['profit'] - total_stats['slippage']
    total_loss_ratio = (total_stats['slippage'] / abs(total_stats['profit']) * 100) if total_stats['profit'] != 0 else 0

    print(
        f"\nğŸ“ˆ [ì „ì²´ ìš”ì•½] ì´ ë§¤ë§¤ íšŸìˆ˜: {total_stats['trades']}íšŒ, í‰ê·  ìŠ¹ë¥ : {avg_win_rate:.2f}%, "
        f"ì´ ìˆ˜ìµê¸ˆ: {total_stats['profit']:,.0f}ì› | "
        f"ê°€ìƒìˆ˜ìµê¸ˆ(1%ìŠ¬ë¦¬í”¼ì§€): {total_virtual_profit:,.0f}ì› | "
        f"ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨: {total_loss_ratio:.2f}%"
    )

    # RSI ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [RSI êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 115)
    print(f"{'RSI êµ¬ê°„':<15} | {'ê²Œì„ìˆ˜':>10} | {'ìŠ¹ë¥ ':>10} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 115)
    for bucket in ['50 ì´í•˜', '50ëŒ€', '60ëŒ€', '70ëŒ€', '80ëŒ€', '90ëŒ€']:
        s = rsi_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{bucket:<15} | {s['games']:10d}íšŒ | {win_rate:9.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")

    # [ìˆ˜ì •] ATR ë¶„ì„ ì¶œë ¥ (ë°±ë¶„ìœ¨ êµ¬ê°„ ê¸°ì¤€)
    print("\n\nğŸ“Š [ATR(%) êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 115)
    print(f"{'ATR(%) êµ¬ê°„':<15} | {'ê²Œì„ìˆ˜':>10} | {'ìŠ¹ë¥ ':>10} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 115)
    for bucket in ['2% ë¯¸ë§Œ', '2%~4%', '4%~6%', '6%~8%', '8% ì´ìƒ']:
        s = atr_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{bucket:<15} | {s['games']:10d}íšŒ | {win_rate:9.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")

    # [ì¶”ê°€] ADX ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ADX êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 115)
    print(f"{'ADX êµ¬ê°„':<15} | {'ê²Œì„ìˆ˜':>10} | {'ìŠ¹ë¥ ':>10} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 115)
    for bucket in ['20 ë¯¸ë§Œ', '20~40', '40~60', '60~80', '80 ì´ìƒ']:
        s = adx_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{bucket:<15} | {s['games']:10d}íšŒ | {win_rate:9.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")

    # [ì¶”ê°€] ë°´ë“œí­ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ì „ì¼ê¸°ì¤€ ë°´ë“œí­(%) êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 115)
    print(f"{'ë°´ë“œí­ êµ¬ê°„':<15} | {'ê²Œì„ìˆ˜':>10} | {'ìŠ¹ë¥ ':>10} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 115)
    for bucket in ['6% ë¯¸ë§Œ', '6~8%', '8~10%', '10~12%', '12~14%', '14% ì´ìƒ']:
        s = bw_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{bucket:<15} | {s['games']:10d}íšŒ | {win_rate:9.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")

    # ì›”ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ì›”ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 100)
    print(f"{'ì›” (Month)':<10} | {'ê²Œì„ìˆ˜':>6} | {'ìŠ¹ë¥ ':>8} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 100)
    for ym in sorted(monthly_stats.keys()):
        s = monthly_stats[ym]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{ym:<10} | {s['games']:6d}íšŒ | {win_rate:7.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")

    # ë…„ë„ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ë…„ë„ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 100)
    print(f"{'ë…„ë„ (Year)':<10} | {'ê²Œì„ìˆ˜':>6} | {'ìŠ¹ë¥ ':>8} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 100)
    for y in sorted(yearly_stats.keys()):
        s = yearly_stats[y]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{y:<10} | {s['games']:6d}íšŒ | {win_rate:7.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")
    print("=" * 100)


if __name__ == "__main__":
    main()
