# ==========================================
# ğŸ“Š [ìƒì„¸ ê±°ë˜ ë‚´ì—­ ë¦¬í¬íŠ¸] ì¼ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + 60ì´í‰(VWAPëŒ€ì²´) + ë°´ë“œí­/RSI/ATR êµ¬ê°„ ë¶„ì„
# =======================================================================================================================
# ì¢…ëª©ëª…          | ë§¤ìˆ˜ì¼       | ë§¤ìˆ˜ì‹œê°„ | ë§¤ë„ì‹œê°„ | ë³´ìœ (ì¼) |     ë§¤ìˆ˜ê°€ |     ë§¤ë„ê°€ | ëŒíŒŒìƒìŠ¹ë¥  |  ìˆ˜ìµë¥  | ìµœëŒ€ìˆ˜ìµë¥  |   RSI |  ATR(%) |   ADX | ë°´ë“œí­(%)
# -----------------------------------------------------------------------------------------------------------------------
# ...
# =======================================================================================================================
import matplotlib

# í™”ë©´ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì—ì„œ ì´ë¯¸ì§€ ìƒì„± (ì¶©ëŒ ë°©ì§€)
matplotlib.use('Agg')

import backtrader as bt
import pandas as pd
import numpy as np  # ìº”ë“¤ ì°¨íŠ¸ ì—°ì‚°ì„ ìœ„í•´ ì¶”ê°€
import os
import math
import unicodedata
from datetime import time, timedelta
from collections import defaultdict
import matplotlib.pyplot as plt

# ==========================================
# [ì¶”ê°€] ê¸€ë¡œë²Œ ì§€ìˆ˜ í•„í„°ìš© ì „ì—­ ë°ì´í„°í”„ë ˆì„ ì´ˆê¸°í™”
# ==========================================
GLOBAL_KOSPI_DF = pd.DataFrame()
GLOBAL_KOSDAQ_DF = pd.DataFrame()


# ==========================================
# ğŸ’¡ [ì‚¬ìš©ì ì„¤ì •] ì „ì²´ í™˜ê²½ ë° ë§¤ë§¤/ì§€í‘œ ì¡°ê±´ ìˆ˜ì¹˜ ì„¤ì •
# ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì—¬ ë‹¤ì–‘í•œ ì¡°ê±´ìœ¼ë¡œ ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ==========================================

# [1] ë°ì´í„° ë° í™˜ê²½ ì„¤ì •
DATA_FOLDER = "stock_data_500ten"  # ğŸ“‚ ëŒ€ìƒ ë°ì´í„° í´ë”ëª…
MARKET_DATA_FOLDER = "common_market_data"  # ğŸ“‚ ê³µí†µ ì§€ìˆ˜ ë°ì´í„° í´ë”ëª… (ìƒˆë¡œ ì¶”ê°€)
CHART_FOLDER = "saved_charts_min"  # ğŸ“‚ ìˆ˜ìµë¥  ì°¨íŠ¸ ì €ì¥ í´ë”ëª…
ANALYSIS_CHART_FOLDER = "saved_analysis_charts"  # ğŸ“‚ ì„±ê³¼ ë¶„ì„ ì°¨íŠ¸(ë§‰ëŒ€/ì„  ê·¸ë˜í”„) ì €ì¥ í´ë”ëª…
START_DATE = "2015-01-01"  # ğŸ“… ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘ì¼ (YYYY-MM-DD)
END_DATE = "2099-12-31"  # ğŸ“… ë°±í…ŒìŠ¤íŠ¸ ì¢…ë£Œì¼ (íŠ¹ì •í•˜ì§€ ì•Šì„ ê²½ìš° ë¯¸ë˜ ë‚ ì§œ ìœ ì§€)
INITIAL_CASH = 100000000  # ğŸ’° ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘ ì´ ì˜ˆìˆ˜ê¸ˆ (ê¸°ë³¸ 1ì–µ)
BET_CASH = 10000000  # ğŸ’µ 1íšŒ ì§„ì… ì‹œ ë§¤ìˆ˜(íƒ€ê²Ÿ) ê¸ˆì•¡ (ê¸°ë³¸ 1000ë§Œ ì›)
SLIPPAGE_PCT = 0.005  # ğŸ’¸ ë¶„ì„ ë¦¬í¬íŠ¸ìš© ìŠ¬ë¦¬í”¼ì§€ í˜ë„í‹° (0.005 = 0.5%)

# [2] ë§¤ìˆ˜(ì§„ì…) ì¡°ê±´ ì„¤ì •
TARGET_PCT = 0.05  # ğŸš€ ëŒíŒŒ ìƒìŠ¹ë¥ : ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ê³ ê°€ ìµœì†Œ ìƒìŠ¹ë¥ 
GAP_MIN = -0.35  # ğŸ“‰ ìµœì†Œ ê°­ìƒìŠ¹ë¥  (-0.05 = -5%)
GAP_MAX = 0.35  # ğŸ“ˆ ìµœëŒ€ ê°­ìƒìŠ¹ë¥  (0.05 = 5%)
VOL_SURGE = 0  # ğŸ’¥ ê±°ë˜ëŸ‰ í­ì¦: í‰ê·  ëŒ€ë¹„ ë‹¹ì¼ ê±°ë˜ëŸ‰ ë°°ìˆ˜ (3.0 = 300% ì´ìƒ)
VOL_PERIOD = 20  # ğŸ“Š í‰ê·  ê±°ë˜ëŸ‰ì„ ì‚°ì¶œí•  ê¸°ê°„(ì¼)
MA_TREND_FAST = 10  # ğŸ“ˆ ì •ë°°ì—´ íŒë³„ìš© ë‹¨ê¸° ì´í‰ì„ 
MA_TREND_SLOW = 20  # ğŸ“‰ ì •ë°°ì—´ íŒë³„ìš© ì¤‘ê¸° ì´í‰ì„ 
MA_VWAP_PROXY = 60  # ğŸ›¡ï¸ ì„¸ë ¥ì„ (ë‹¨ê°€) ë°©ì–´ìš© ì¥ê¸° ì´í‰ì„  (ì´ ì„  ìœ„ì— ìˆì„ ë•Œë§Œ ë§¤ìˆ˜)
USE_VWAP_PROXY_FILTER = 1  # ğŸ›¡ï¸ ì„¸ë ¥ì„ (60ì¼ì„ ) ìƒíšŒ ì¡°ê±´ ì‚¬ìš© ì—¬ë¶€ (1: ì ìš©, 0: ë¯¸ì ìš©)
PREV_MA_ALIGN = 1  # ğŸ“ˆ 1ë´‰ì „ ê¸°ì¤€ ë‹¨ê¸°-ì¤‘ê¸° ë§¤ë„ì„ (3ì„ , 5ì„ ) ì •ë°°ì—´ ì—¬ë¶€ (1: ì ìš©, 0: ë¯¸ì ìš©)
PREV_TRADE_VAL_MIN = 5000000000  # ğŸ’° 1ë´‰ì „ ê¸°ì¤€ ìµœì†Œ ê±°ë˜ëŒ€ê¸ˆ í•˜í•œì„  (ê¸°ë³¸ 50ì–µ)

# [3] ë³´ì¡°ì§€í‘œ í•„í„° ë²”ìœ„ ì„¤ì •
BOLL_PERIOD = 20  # ã€°ï¸ ë³¼ë¦°ì €ë°´ë“œ ê¸°ê°„
BOLL_DEV = 2.0  # ã€°ï¸ ë³¼ë¦°ì €ë°´ë“œ í‘œì¤€í¸ì°¨ ìŠ¹ìˆ˜
BOLL_BW_MIN = 0.00  # ã€°ï¸ ë°´ë“œí­ í•˜í•œì„  (í•´ë‹¹ ìˆ˜ì¹˜ ë¯¸ë§Œì´ë©´ ì§„ì… ê¸ˆì§€)
BOLL_BW_MAX = 999.0  # ã€°ï¸ ë°´ë“œí­ ìƒí•œì„  (í•´ë‹¹ ìˆ˜ì¹˜ ì´ˆê³¼ë©´ ì§„ì… ê¸ˆì§€, 999ëŠ” ì‚¬ì‹¤ìƒ ë¬´ì œí•œ)

RSI_PERIOD = 14  # ğŸ“ˆ RSI ê³„ì‚° ê¸°ê°„
RSI_MIN = 0  # ğŸ“ˆ RSI í•˜í•œì„  (ì´í•˜ì¼ ê²½ìš° ì§„ì… ê¸ˆì§€)
RSI_MAX = 100  # ğŸ“ˆ RSI ìƒí•œì„  (ì´ìƒì¼ ê²½ìš° ì§„ì… ê¸ˆì§€)

# [4] ë§¤ë„(ì²­ì‚°) ì¡°ê±´ ì„¤ì •
MA_SELL_FAST = 3  # ğŸƒâ€â™‚ï¸ ì²­ì‚° ë°ë“œí¬ë¡œìŠ¤ íŒë³„ìš© ë‹¨ê¸° ì´í‰ì„ 
MA_SELL_SLOW = 5  # ğŸš¶â€â™‚ï¸ ì²­ì‚° ë°ë“œí¬ë¡œìŠ¤ íŒë³„ìš© ì¤‘ê¸° ì´í‰ì„ 

# [5] ê¸€ë¡œë²Œ ì§€ìˆ˜ í•„í„° ì¡°ê±´ ì„¤ì • (ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ì´ê²©ë„ ë° ê°­ìƒìŠ¹ë¥ )
KP_MA20_MIN = -100.0  # ğŸ“‰ ì½”ìŠ¤í”¼ ë‹¹ì¼ ì‹œê°€ì˜ 20ì¼ì„  ê¸°ì¤€ ì´ê²©ë„ ìµœì†Œ(%)
KP_MA20_MAX = 100.0   # ğŸ“ˆ ì½”ìŠ¤í”¼ ë‹¹ì¼ ì‹œê°€ì˜ 20ì¼ì„  ê¸°ì¤€ ì´ê²©ë„ ìµœëŒ€(%)
KP_GAP_MIN = -100.0   # ğŸ“‰ ì½”ìŠ¤í”¼ ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ì‹œê°€ ë“±ë½ë¥  ìµœì†Œ(%)
KP_GAP_MAX = 100.0    # ğŸ“ˆ ì½”ìŠ¤í”¼ ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ì‹œê°€ ë“±ë½ë¥  ìµœëŒ€(%)
KD_MA20_MIN = -100.0  # ğŸ“‰ ì½”ìŠ¤ë‹¥ ë‹¹ì¼ ì‹œê°€ì˜ 20ì¼ì„  ê¸°ì¤€ ì´ê²©ë„ ìµœì†Œ(%)
KD_MA20_MAX = 100.0   # ğŸ“ˆ ì½”ìŠ¤ë‹¥ ë‹¹ì¼ ì‹œê°€ì˜ 20ì¼ì„  ê¸°ì¤€ ì´ê²©ë„ ìµœëŒ€(%)
KD_GAP_MIN = -100.0   # ğŸ“‰ ì½”ìŠ¤ë‹¥ ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ì‹œê°€ ë“±ë½ë¥  ìµœì†Œ(%)
KD_GAP_MAX = 100.0    # ğŸ“ˆ ì½”ìŠ¤ë‹¥ ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ì‹œê°€ ë“±ë½ë¥  ìµœëŒ€(%)


# ==========================================

# -----------------------------------------------------------------------------
# [ì¶”ê°€] ê³µí†µ ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
# -----------------------------------------------------------------------------
def load_global_indices():
    global GLOBAL_KOSPI_DF, GLOBAL_KOSDAQ_DF
    if not os.path.exists(MARKET_DATA_FOLDER):
        print(f"âš ï¸ '{MARKET_DATA_FOLDER}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ì§€ìˆ˜ ë°ì´í„°ë¥¼ ë¹ˆ ìƒíƒœë¡œ ì§„í–‰í•©ë‹ˆë‹¤.")
        return

    for f in os.listdir(MARKET_DATA_FOLDER):
        if not f.endswith(('.xlsx', '.csv')): continue
        file_path = os.path.join(MARKET_DATA_FOLDER, f)
        
        try:
            if f.endswith('.csv'):
                try:
                    df = pd.read_csv(file_path, encoding='utf-8-sig')
                except:
                    df = pd.read_csv(file_path, encoding='cp949')
            else:
                df = pd.read_excel(file_path)
                
            df.columns = [str(c).strip() for c in df.columns]
            
            rename_map = {'ì¼ì': 'Date', 'ì²´ê²°ì‹œê°„': 'Date'}
            df = df.rename(columns=rename_map)
            
            if 'Date' in df.columns:
                df['Date'] = pd.to_datetime(df['Date'].astype(str).str.replace(r'[^0-9-:]', '', regex=True), errors='coerce')
                df = df.dropna(subset=['Date'])
                df = df.sort_values('Date').set_index('Date')
            elif isinstance(df.index, pd.DatetimeIndex):
                pass
            else:
                continue

            name_upper = f.upper()
            if 'KOSPI' in name_upper or 'ì½”ìŠ¤í”¼' in name_upper:
                GLOBAL_KOSPI_DF = df
                print(f"âœ… ì½”ìŠ¤í”¼ ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {f}")
            elif 'KOSDAQ' in name_upper or 'ì½”ìŠ¤ë‹¥' in name_upper:
                GLOBAL_KOSDAQ_DF = df
                print(f"âœ… ì½”ìŠ¤ë‹¥ ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {f}")
                
        except Exception as e:
            print(f"âš ï¸ ì§€ìˆ˜ íŒŒì¼({f}) ë¡œë“œ ì—ëŸ¬: {e}")


# -----------------------------------------------------------------------------
# [ì¶”ê°€] ë¶„ì„ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ (ë§‰ëŒ€ + ì„  ê·¸ë˜í”„)
# -----------------------------------------------------------------------------
def save_analysis_chart(title, stats_dict, buckets, folder_path):
    if not os.path.exists(folder_path):
        os.makedirs(folder_path)

    x_labels = []
    gross_profits = []
    gross_losses = []
    avg_returns = []

    for b in buckets:
        s = stats_dict.get(b, {'gross_profit': 0, 'gross_loss': 0, 'games': 0, 'sum_profit_pct': 0})
        x_labels.append(b)
        gross_profits.append(s['gross_profit'])
        gross_losses.append(s['gross_loss'])  # ì†ì‹¤ì„ ì–‘ìˆ˜ë¡œ í‘œì‹œí•˜ì—¬ ë§‰ëŒ€ ë¹„êµ
        if s['games'] > 0:
            avg_returns.append(s['sum_profit_pct'] / s['games'])
        else:
            avg_returns.append(0)

    if os.name == 'nt':
        plt.rcParams['font.family'] = 'Malgun Gothic'
    else:
        plt.rcParams['font.family'] = 'AppleGothic'
    plt.rcParams['axes.unicode_minus'] = False

    fig, ax1 = plt.subplots(figsize=(14, 6))

    x = np.arange(len(x_labels))
    width = 0.4

    # ìˆ˜ìµ(ë¹¨ê°•)ê³¼ ì†ì‹¤(íŒŒë‘) ë§‰ëŒ€ê·¸ë˜í”„
    ax1.bar(x - width / 2, gross_profits, width, label='ì´ìˆ˜ìµ', color='#ff9999', edgecolor='red')
    ax1.bar(x + width / 2, gross_losses, width, label='ì´ì†ì‹¤', color='#99ccff', edgecolor='blue')

    ax1.set_ylabel('ê¸ˆì•¡ (ì›)', color='black')
    ax1.set_xticks(x)
    ax1.set_xticklabels(x_labels, rotation=45, ha='right')
    ax1.legend(loc='upper left')
    ax1.grid(True, axis='y', linestyle='--', alpha=0.5)

    # í‰ê·  ìˆ˜ìµë¥  ì„ ê·¸ë˜í”„
    ax2 = ax1.twinx()
    ax2.plot(x, avg_returns, color='green', marker='o', linestyle='-', linewidth=2, label='í‰ê· ìˆ˜ìµë¥ (%)')
    ax2.set_ylabel('í‰ê·  ìˆ˜ìµë¥  (%)', color='green')
    ax2.tick_params(axis='y', labelcolor='green')
    ax2.legend(loc='upper right')

    plt.title(title)
    plt.tight_layout()

    safe_title = "".join([c for c in title if c.isalpha() or c.isdigit() or c in ' %()_-']).rstrip()
    plt.savefig(os.path.join(folder_path, f"{safe_title}.png"))
    plt.close()


# -----------------------------------------------------------------------------
# [ì¶”ê°€] í•œê¸€/ì˜ë¬¸ ì½˜ì†” ì¶œë ¥ ì •ë ¬ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ë„ˆë¹„ ê³„ì‚° í•¨ìˆ˜
# í•œê¸€ ë“± ë™ì•„ì‹œì•„ ë¬¸ìëŠ” 1.7ì¹¸, ì˜ë¬¸/ìˆ«ìëŠ” 1ì¹¸ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì‹œê°ì  í­ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
# -----------------------------------------------------------------------------
def calc_width(s):
    return int(round(sum(1.7 if unicodedata.east_asian_width(c) in 'WF' else 1 for c in str(s))))


def lpad(s, w):
    s = str(s)
    return s + ' ' * max(0, w - calc_width(s))


def rpad(s, w):
    s = str(s)
    return ' ' * max(0, w - calc_width(s)) + s


# -----------------------------------------------------------------------------
# CustomPandasData í´ë˜ìŠ¤
# -----------------------------------------------------------------------------
class CustomPandasData(bt.feeds.PandasData):
    lines = ('rsi',)
    params = (
        ('datetime', None),
        ('open', 'Open'),
        ('high', 'High'),
        ('low', 'Low'),
        ('close', 'Close'),
        ('volume', 'Volume'),
        ('openinterest', None),
        ('rsi', 'rsi'),
    )


# -----------------------------------------------------------------------------
# RSI ê³„ì‚° í•¨ìˆ˜ (ë°ì´í„° ì „ì²˜ë¦¬ìš©)
# -----------------------------------------------------------------------------
def calculate_rsi(series, period=14):
    delta = series.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    return 100 - (100 / (1 + rs))


# -----------------------------------------------------------------------------
# [ìˆ˜ì •] ìˆ˜ìµë¥  Top 5 / Bottom 5 ì°¨íŠ¸ ì €ì¥ í•¨ìˆ˜ (ë´‰ ì°¨íŠ¸, ì´í‰ì„ , êµ¬ê°„ ë³€ê²½, ë‚ ì§œëª…)
# -----------------------------------------------------------------------------
def save_chart(t, folder, prefix, rank):
    try:
        df = pd.read_excel(t['file_path'])
        df.columns = [c.strip() for c in df.columns]
        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date', 'ì²´ê²°ì‹œê°„': 'Date'}
        df = df.rename(columns=rename_map)

        if 'Date' in df.columns:
            if pd.api.types.is_numeric_dtype(df['Date']):
                df['Date'] = df['Date'].astype(str)
            df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            return

        # ìº”ë“¤ì„ ê·¸ë¦¬ê¸° ìœ„í•´ Open, High, Lowë„ ìˆ«ìí˜• ë³€í™˜ì— í¬í•¨
        cols_to_numeric = ['Close', 'Open', 'High', 'Low']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()

        # 3ë¶„, 5ë¶„ ì´ë™í‰ê· ì„  ê³„ì‚° (ë°ì´í„°ë¥¼ ìë¥´ê¸° ì „ì— ë¯¸ë¦¬ ì „ì²´ì—ì„œ ê³„ì‚°)
        df['MA3'] = df['Close'].rolling(window=3).mean()
        df['MA5'] = df['Close'].rolling(window=5).mean()

        open_dt = pd.to_datetime(f"{t['open_date']} {t['open_time']}")
        close_dt = pd.to_datetime(f"{t['date']} {t['close_time']}")

        # ì‹œê°„ ê¸°ì¤€ì´ ì•„ë‹Œ ë´‰ ê°¯ìˆ˜(Index) ê¸°ì¤€ìœ¼ë¡œ ìë¥´ê¸°
        try:
            buy_loc = df.index.get_indexer([open_dt], method='nearest')[0]
            sell_loc = df.index.get_indexer([close_dt], method='nearest')[0]
        except Exception:
            return

        # ë§¤ìˆ˜ 30ë´‰ ì „ë¶€í„° ë§¤ë„ 10ë´‰ í›„ê¹Œì§€
        start_idx = max(0, buy_loc - 30)
        end_idx = min(len(df) - 1, sell_loc + 10)

        plot_df = df.iloc[start_idx: end_idx + 1]

        if plot_df.empty:
            return

        plt.figure(figsize=(10, 5))

        # í•œê¸€ í°íŠ¸ ì„¤ì •
        if os.name == 'nt':
            plt.rcParams['font.family'] = 'Malgun Gothic'
        else:
            plt.rcParams['font.family'] = 'AppleGothic'
        plt.rcParams['axes.unicode_minus'] = False

        # ìº”ë“¤(ë´‰) ì°¨íŠ¸ ìˆ˜ë™ ê·¸ë¦¬ê¸°
        x = np.arange(len(plot_df))
        colors = np.where(plot_df['Close'] >= plot_df['Open'], 'red', 'blue')

        # ê¼¬ë¦¬(High-Low)
        plt.vlines(x, plot_df['Low'], plot_df['High'], color=colors, linewidth=1)
        # ëª¸í†µ(Open-Close)
        plt.bar(x, np.abs(plot_df['Close'] - plot_df['Open']), bottom=np.minimum(plot_df['Open'], plot_df['Close']),
                color=colors, width=0.6)

        # 3ë¶„/5ë¶„ ì´ë™í‰ê· ì„  ê·¸ë¦¬ê¸°
        plt.plot(x, plot_df['MA3'], color='orange', linewidth=1.5, label='3ì„ ')
        plt.plot(x, plot_df['MA5'], color='green', linewidth=1.5, label='5ì„ ')

        # ì§„ì…/ì²­ì‚° íƒ€ì  ë§ˆí‚¹ (ìƒëŒ€ì  ìœ„ì¹˜ x ì¢Œí‘œ)
        buy_x = buy_loc - start_idx
        sell_x = sell_loc - start_idx
        plt.scatter(buy_x, t['entry_price'], color='magenta', marker='^', s=150, label='Buy', zorder=5)
        plt.scatter(sell_x, t['exit_price'], color='cyan', marker='v', s=150, label='Sell', zorder=5)

        # Xì¶•ì„ ì¼ë´‰ì— ë§ê²Œ YYYY-MM-DD í¬ë§·ìœ¼ë¡œ ë³€ê²½
        tick_step = max(1, len(plot_df) // 10)
        plt.xticks(x[::tick_step], plot_df.index.strftime('%Y-%m-%d')[::tick_step], rotation=45)

        plt.title(f"[{prefix} {rank}] {t['stock_name']} (ìˆ˜ìµë¥ : {t['profit_pct']:.2f}%)")
        plt.grid(True, linestyle='--', alpha=0.6)
        plt.legend()
        plt.tight_layout()

        # íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ë³€í™˜ ë° ë§¤ìˆ˜ ë‚ ì§œ ì¶”ê°€
        safe_name = "".join([c for c in t['stock_name'] if c.isalpha() or c.isdigit() or c == ' ']).rstrip()
        safe_date = str(t['open_date']).replace('-', '')
        filename = f"{prefix}_{rank}_{safe_date}_{safe_name}.png"

        plt.savefig(os.path.join(folder, filename))
        plt.close()
    except Exception as e:
        plt.close()


# ==========================================
# [ì „ëµ] ì¼ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + ì´í‰ì„  í•„í„° + ë‹¨ê¸° ë§¤ë„
# ==========================================
# ğŸ’¡ [í•µì‹¬] ìƒë‹¨ì˜ [ì‚¬ìš©ì ì„¤ì •] ë¸”ë¡ ê°’ë“¤ì´ ì•„ë˜ íŒŒë¼ë¯¸í„°ë¡œ ìë™ ì£¼ì…ë©ë‹ˆë‹¤.
STRATEGY_PARAMS = (
    ('target_pct', TARGET_PCT),
    ('gap_min', GAP_MIN),
    ('gap_max', GAP_MAX),
    ('vol_surge', VOL_SURGE),
    ('vol_period', VOL_PERIOD),
    ('ma_trend_fast', MA_TREND_FAST),
    ('ma_trend_slow', MA_TREND_SLOW),
    ('ma_vwap_proxy', MA_VWAP_PROXY),
    ('use_vwap_proxy_filter', USE_VWAP_PROXY_FILTER),
    ('ma_fast', MA_SELL_FAST),
    ('ma_slow', MA_SELL_SLOW),
    ('slippage_pct', SLIPPAGE_PCT),
    ('boll_period', BOLL_PERIOD),
    ('boll_dev', BOLL_DEV),
    ('boll_bw_min', BOLL_BW_MIN),
    ('boll_bw_max', BOLL_BW_MAX),
    ('rsi_min', RSI_MIN),
    ('rsi_max', RSI_MAX),
    ('bet_cash', BET_CASH),
    ('prev_ma_align', PREV_MA_ALIGN),
    ('prev_trade_val_min', PREV_TRADE_VAL_MIN),
    ('kp_ma20_min', KP_MA20_MIN),
    ('kp_ma20_max', KP_MA20_MAX),
    ('kp_gap_min', KP_GAP_MIN),
    ('kp_gap_max', KP_GAP_MAX),
    ('kd_ma20_min', KD_MA20_MIN),
    ('kd_ma20_max', KD_MA20_MAX),
    ('kd_gap_min', KD_GAP_MIN),
    ('kd_gap_max', KD_GAP_MAX),
    ('debug', False),
)


class CustomDailyStrategy(bt.Strategy):
    """
    [ìƒì„¸ ì „ëµ ì„¤ëª… ë° ì˜ì›…ë¬¸ HTS(0156) ì¡°ê±´ê²€ìƒ‰ ì„¤ì • ê°€ì´ë“œ]
    ================================================================================
    ì´ ì „ëµì€ ì¼ë´‰ ë‹¨ê¸°ë§¤ë§¤ì— ë§ì¶°ì ¸ ìˆìœ¼ë©°, ì˜ì›…ë¬¸ HTSì—ì„œ 100% ë™ì¼í•˜ê²Œ êµ¬í˜„ ê°€ëŠ¥í•©ë‹ˆë‹¤.

    ğŸ“Œ [HTS ì¡°ê±´ê²€ìƒ‰ ì„¤ì • ì„¸íŒ… (0156 í™”ë©´) - ëª¨ë“  ì£¼ê¸°ëŠ” 'ì¼'ë¡œ í†µì¼]

    [A] ë³€ë™ì„± ëŒíŒŒ (ìº”ë“¤ í•˜ë‚˜ì—ì„œ 1.5% ê¸‰ë“± ì–‘ë´‰)
        -> [ë©”ë‰´] ì‹œì„¸ë¶„ì„ > ê°€ê²©ì¡°ê±´ > ì£¼ê°€ë“±ë½ë¥ 
        -> [ì„¤ì •] 1ì¼ì£¼ê¸°, 0ë´‰ì „(í˜„ì¬) ì‹œê°€ ëŒ€ë¹„ 0ë´‰ì „ ì¢…ê°€ ë“±ë½ë¥  1.5% ì´ìƒ

    [B] ìˆ˜ê¸‰ í­ë°œ (ê±°ë˜ëŸ‰ 300% í­ì¦)
        -> [ë©”ë‰´] ì‹œì„¸ë¶„ì„ > ê±°ë˜ëŸ‰/ê±°ë˜ëŒ€ê¸ˆ > ê±°ë˜ëŸ‰ë¹„ìœ¨(në´‰)
        -> [ì„¤ì •] 1ì¼ì£¼ê¸°, 1ë´‰ì „ 20ë´‰ í‰ê· ê±°ë˜ëŸ‰ ëŒ€ë¹„ 0ë´‰ì „ ê±°ë˜ëŸ‰ 300% ì´ìƒ

    [C] ì¶”ì„¸ í•„í„° (10ì„  > 20ì„  ì •ë°°ì—´)
        -> [ë©”ë‰´] ê¸°ìˆ ì ë¶„ì„ > ì£¼ê°€ì´ë™í‰ê·  > ì£¼ê°€ì´ë™í‰ê· ë°°ì—´(3ê°œ)
        -> [ì„¤ì •] 1ì¼ì£¼ê¸°, ì¢…ê°€ 1 > ì¢…ê°€ 10 > ì¢…ê°€ 20 (ë‹¨ìˆœ)

    [D] ì„¸ë ¥/ê°œë¯¸ í‰ê· ë‹¨ê°€ ìƒíšŒ í•„í„° (VWAP ì™„ë²½ ëŒ€ì²´ -> 60ì´í‰ ìƒíšŒ)
        -> [ë©”ë‰´] ê¸°ìˆ ì ë¶„ì„ > ì£¼ê°€ì´ë™í‰ê·  > ì£¼ê°€ì´ë™í‰ê· ë¹„êµ
        -> [ì„¤ì •] 1ì¼ì£¼ê¸°, [ë‹¨ìˆœ]ì¢…ê°€ 60 < [ë‹¨ìˆœ]ì¢…ê°€ 1 (í˜„ì¬ ì£¼ê°€ê°€ 60ì´í‰ì„  ìœ„ì— ìœ„ì¹˜)

    2. ë§¤ë„ ì²­ì‚° ì¡°ê±´ (íŒŒì´ì¬ ë§¤ë§¤ ë¡œì§)
       A. 3ì¼ì„  < 5ì¼ì„  ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ê°€ ì‹œì¥ê°€ ì²­ì‚°
    ================================================================================
    """
    params = STRATEGY_PARAMS

    def __init__(self):
        # íŒŒë¼ë¯¸í„° ê°’ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì´ë™í‰ê· ì„  ìƒì„±
        self.ma_fast_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_fast)
        self.ma_slow_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_slow)

        self.ma_trend_fast_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_trend_fast)
        self.ma_trend_slow_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_trend_slow)

        self.ma_vwap_proxy_line = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_vwap_proxy)

        self.vol_sma = bt.indicators.SimpleMovingAverage(self.data.volume, period=self.p.vol_period)

        # [ì¶”ê°€] 20ì¼ ê±°ë˜ëŒ€ê¸ˆ í‰ê·  ê³„ì‚°ì„ ìœ„í•œ ë°ì´í„°
        self.trade_amt_line = self.data.close * self.data.volume
        self.trade_amt_sma = bt.indicators.SimpleMovingAverage(self.trade_amt_line, period=20)

        # ë³´ì¡°ì§€í‘œ ì„¤ì • (ë¶„ì„ìš©ìœ¼ë¡œë§Œ ìˆ˜ì§‘)
        typical_price = (self.data.high + self.data.low + self.data.close) / 3.0
        self.bband = bt.indicators.BollingerBands(typical_price, period=self.p.boll_period, devfactor=self.p.boll_dev)
        self.atr = bt.indicators.ATR(self.data, period=14)
        self.adx = bt.indicators.ADX(self.data, period=14)

        # ìˆ˜ë™ í¬ì§€ì…˜ ê´€ë¦¬ìš©
        self.my_position = None
        self.trades_history = []
        self.peak_price = 0

    def next(self):
        # [ë™ì  ê³„ì‚°] íŒŒë¼ë¯¸í„°ë¡œ ì„¤ì •ëœ ì´í‰ì„ ë“¤ ì¤‘ ê°€ì¥ ê¸´ ê¸°ê°„ì˜ ë°ì´í„°ê°€ ìŒ“ì¼ ë•Œê¹Œì§€ ëŒ€ê¸°
        if len(self.data) < max(self.p.ma_vwap_proxy + 1, self.p.boll_period + 2, self.p.vol_period + 1,
                                self.p.ma_trend_slow + 1, self.p.ma_slow + 2, 21):
            return

        current_date = self.data.datetime.date(0)
        current_time = self.data.datetime.time(0)

        # ----------------------------------------------------------------------
        # [1] ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ë„(ì²­ì‚°) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position:
            if self.data.high[0] > self.peak_price:
                self.peak_price = self.data.high[0]

            # [ë³µì›/ë™ì ê³„ì‚°] ë°ë“œí¬ë¡œìŠ¤ ë°©ì–´ ê°€ê²© ê³„ì‚° (ë‹¨ê¸° ì´í‰ì„ ì´ ì¤‘ê¸° ì´í‰ì„ ì„ í•˜í–¥ ì´íƒˆí•˜ê²Œ ë§Œë“œëŠ” ì˜ˆì¸¡ ê°€ê²©)
            # íŒŒë¼ë¯¸í„° ê°’(F, S)ì´ ì–´ë–»ê²Œ ë³€í•˜ë“  ë²”ìš©ì ìœ¼ë¡œ ê³„ì‚°í•´ë‚´ëŠ” ìˆ˜í•™ ê³µì‹ ì ìš©
            F = self.p.ma_fast
            S = self.p.ma_slow
            sum_F = sum(self.data.close[-i] for i in range(1, F))
            sum_S = sum(self.data.close[-i] for i in range(1, S))
            cross_price_raw = (F * sum_S - S * sum_F) / (S - F) if S != F else 0
            cross_price = round(cross_price_raw)

            sell_signal = False
            sell_price = 0
            sell_reason = ""

            # ë§¤ë„ ì¡°ê±´ 1: ì§ì „ ìº”ë“¤ì— ì´ë¯¸ ë‹¨ê¸°ì„ ì´ ì¤‘ê¸°ì„  ì•„ë˜ë¡œ ë‚´ë ¤ê°„(ë°ë“œí¬ë¡œìŠ¤) ìƒíƒœë¼ë©´, í˜„ì¬ ì‹œê°€ì— ì¦‰ì‹œ ì‹œì¥ê°€ ë§¤ë„
            if self.ma_fast_line[-1] < self.ma_slow_line[-1]:
                sell_signal = True
                sell_price = self.data.open[0]
                sell_reason = "ì§ì „ ì´ë¯¸ ë°ë“œí¬ë¡œìŠ¤ ìƒíƒœ"
            # ë§¤ë„ ì¡°ê±´ 2: ì¥ì¤‘ ìµœì €ê°€ê°€ ë°ë“œí¬ë¡œìŠ¤ ë°©ì–´ ê°€ê²©ì„ ì´íƒˆí•œ ê²½ìš°
            elif self.data.low[0] <= cross_price:
                sell_signal = True
                # ë§Œì•½ ì‹œê°€ë¶€í„° ê°­í•˜ë½í•˜ì—¬ ë°ë“œí¬ë¡œìŠ¤ ê°€ê²© ì•„ë˜ì—ì„œ ì¶œë°œí–ˆë‹¤ë©´ ì‹œê°€ì— ë§¤ë„
                if self.data.open[0] < cross_price:
                    sell_price = self.data.open[0]
                    sell_reason = "ê°­í•˜ë½ ë°ë“œí¬ë¡œìŠ¤"
                # ì •ìƒì ìœ¼ë¡œ ì‹œì‘ í›„ í•˜ë½í•˜ì—¬ í„°ì¹˜í–ˆë‹¤ë©´ í•´ë‹¹ ê°€ê²©(cross_price)ì— ë§¤ë„
                else:
                    sell_price = cross_price
                    sell_reason = "ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ í„°ì¹˜"

            if sell_signal:
                entry_price = self.my_position['price']
                buy_size = self.my_position['size']
                buy_reason = self.my_position['reason']
                entry_rsi = self.my_position.get('rsi', 0)
                entry_atr = self.my_position.get('atr', 0)
                entry_adx = self.my_position.get('adx', 0)
                entry_bandwidth = self.my_position.get('bandwidth', 0)
                entry_surge = self.my_position.get('surge_pct', 0)
                entry_gap_pct = self.my_position.get('gap_pct', 0)
                entry_trade_amount = self.my_position.get('trade_amount', 0)
                entry_prev_trade_amount = self.my_position.get('prev_trade_amount', 0)
                entry_avg_trade_amount_20 = self.my_position.get('avg_trade_amount_20', 0)
                entry_vol_surge = self.my_position.get('vol_surge_pct', 0)
                entry_bar = self.my_position.get('entry_bar', len(self))
                open_date = self.my_position['date']
                open_time = self.my_position['time']

                # ì¼ë´‰ì´ë¯€ë¡œ hold_daysëŠ” ë³´ìœ  ìº”ë“¤(ì¼) ê°¯ìˆ˜ê°€ ë©ë‹ˆë‹¤.
                hold_days = len(self) - entry_bar
                pnl = (sell_price - entry_price) * buy_size
                profit_pct = ((sell_price - entry_price) / entry_price) * 100
                max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100

                self.trades_history.append({
                    'open_date': open_date,
                    'open_time': open_time,
                    'date': current_date,
                    'close_time': current_time,
                    'hold_days': hold_days,
                    'profit_pct': profit_pct,
                    'max_profit_pct': max_profit_pct,
                    'pnl': pnl,
                    'is_win': pnl > 0,
                    'entry_price': entry_price,
                    'exit_price': sell_price,
                    'entry_rsi': entry_rsi,
                    'entry_atr': entry_atr,
                    'entry_adx': entry_adx,
                    'entry_bandwidth': entry_bandwidth,
                    'entry_surge': entry_surge,
                    'entry_gap_pct': entry_gap_pct,
                    'entry_trade_amount': entry_trade_amount,
                    'entry_prev_trade_amount': entry_prev_trade_amount,
                    'entry_avg_trade_amount_20': entry_avg_trade_amount_20,
                    'entry_vol_surge': entry_vol_surge,
                    'size': buy_size,
                    'status': 'Closed',
                    'buy_reason': buy_reason,
                    'sell_reason': sell_reason
                })
                self.my_position = None
                self.peak_price = 0
                return

        # ----------------------------------------------------------------------
        # [2] ë¯¸ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ìˆ˜(ì§„ì…) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position is None:
            if self.data.close[-1] == 0: return

            # [ì¡°ê±´ A-1] ë¶„ë´‰ ìº” ë‹¨ì¼ ê¸‰ë“± ë° í™•ì‹¤í•œ ì–‘ë´‰(Close > Open)
            surge_pct = (self.data.high[0] / self.data.close[-1]) - 1
            if surge_pct < self.p.target_pct: return
            if self.data.close[0] <= self.data.open[0]: return

            # [ì¡°ê±´ A-2] ë‹¹ì¼ ì‹œê°€ ê°­ìƒìŠ¹ ë²”ìœ„ í•„í„°
            gap_pct = (self.data.open[0] / self.data.close[-1]) - 1
            if gap_pct < self.p.gap_min or gap_pct > self.p.gap_max: return

            # [ì¡°ê±´ B] ê±°ë˜ëŸ‰ í­ì¦: ì§ì „ Në´‰ í‰ê·  ê±°ë˜ëŸ‰ ëŒ€ë¹„ Më°° ì´ìƒ
            if self.data.volume[0] < self.vol_sma[-1] * self.p.vol_surge: return
            actual_vol_surge = (self.data.volume[0] / self.vol_sma[-1] * 100) if self.vol_sma[-1] > 0 else 0

            # [ì¡°ê±´ C] ì¶”ì„¸ í•„í„°: ë‹¨ê¸°ì„ ì´ ì¤‘ê¸°ì„  ìœ„ì— ìˆëŠ” ì •ë°°ì—´ ìƒíƒœ (1ë´‰ ì „ ê¸°ì¤€ êµì •)
            if self.ma_trend_fast_line[-1] <= self.ma_trend_slow_line[-1]: return

            # [ì¡°ê±´ D] HTS êµ¬í˜„ìš© VWAP ëŒ€ì²´: ê¸´ ì¶”ì„¸ ì´í‰ì„  ìœ„ì— ìœ„ì¹˜í•˜ì—¬ í•˜ë½ì¥ íœ©ì˜ ë°©ì§€ (ì„ íƒ ì ìš© ë° 1ë´‰ ì „ ê¸°ì¤€ êµì •)
            if self.p.use_vwap_proxy_filter == 1:
                if self.data.close[0] <= self.ma_vwap_proxy_line[-1]: return

            # [ì¡°ê±´ E] 1ë´‰ì „ 3ì¼ì„ ê³¼ 5ì¼ì„ ì˜ ì •ë°°ì—´ ì—¬ë¶€ (ì„ íƒ ì ìš©)
            if self.p.prev_ma_align == 1:
                if self.ma_fast_line[-1] <= self.ma_slow_line[-1]: return

            # [ì¡°ê±´ F] 1ë´‰ì „ ê±°ë˜ëŒ€ê¸ˆ í•˜í•œì„  í•„í„°
            prev_trade_amount = self.data.close[-1] * self.data.volume[-1]
            if prev_trade_amount < self.p.prev_trade_val_min: return

            # [ì¡°ê±´ G] ê¸€ë¡œë²Œ ì§€ìˆ˜ í•„í„° (KOSPI/KOSDAQ ë‹¹ì¼ ì‹œê°€ ê¸°ì¤€ ì´ê²©ë„ ë° ê°­ìƒìŠ¹ë¥ )
            dt_key = pd.to_datetime(current_date)
            
            # KOSPI í•„í„° ê²€ì‚¬
            if not GLOBAL_KOSPI_DF.empty and dt_key in GLOBAL_KOSPI_DF.index:
                kp_row = GLOBAL_KOSPI_DF.loc[dt_key]
                if isinstance(kp_row, pd.DataFrame): kp_row = kp_row.iloc[0]
                kp_ma_v = kp_row['Open_to_MA20_pct']
                kp_gap_v = kp_row['Open_Gap_pct']
                
                if not (self.p.kp_ma20_min <= kp_ma_v <= self.p.kp_ma20_max): return
                if not (self.p.kp_gap_min <= kp_gap_v <= self.p.kp_gap_max): return
                
            # KOSDAQ í•„í„° ê²€ì‚¬
            if not GLOBAL_KOSDAQ_DF.empty and dt_key in GLOBAL_KOSDAQ_DF.index:
                kd_row = GLOBAL_KOSDAQ_DF.loc[dt_key]
                if isinstance(kd_row, pd.DataFrame): kd_row = kd_row.iloc[0]
                kd_ma_v = kd_row['Open_to_MA20_pct']
                kd_gap_v = kd_row['Open_Gap_pct']
                
                if not (self.p.kd_ma20_min <= kd_ma_v <= self.p.kd_ma20_max): return
                if not (self.p.kd_gap_min <= kd_gap_v <= self.p.kd_gap_max): return

            # --- [ì¶”í›„ ì ìš©ìš© ë³´ì¡°ì§€í‘œ ì¡°ê±´ ì£¼ì„ ì²˜ë¦¬] ---
            # ë°´ë“œí­ í•„í„°
            top = self.bband.lines.top[-1]
            bot = self.bband.lines.bot[-1]
            mid = self.bband.lines.mid[-1]
            if mid == 0: return
            bandwidth = (top - bot) / mid
            if bandwidth < self.p.boll_bw_min or bandwidth > self.p.boll_bw_max: return

            # RSI, ADX, ATR í•„í„°
            if self.data.rsi[-1] >= self.p.rsi_max or self.data.rsi[-1] <= self.p.rsi_min: return
            # if not (60 <= self.adx[-1] <= 80): return
            # atr_pct = (self.atr[-1] / self.data.close[0] * 100) if self.data.close[0] > 0 else 0
            # if not (0.2 < atr_pct < 1.0): return
            # -----------------------------------------------

            # ë§¤ìˆ˜ê°€ê²© ê³„ì‚° ë¡œì§ (ê²½ë¡œ ì˜ì¡´ì„± ì˜¤ë¥˜ í•´ê²° ë° MAX ê°€ê²© ì ìš©)
            base_buy_price = self.data.close[-1] * (1 + self.p.target_pct)
            open_price = self.data.open[0]

            if self.p.use_vwap_proxy_filter == 1:
                buy_price = max(base_buy_price, open_price, self.ma_vwap_proxy_line[-1])
            else:
                buy_price = max(base_buy_price, open_price)

            # ê°€ì§œ ì²´ê²° ë°©ì§€: ê³„ì‚°ëœ ì§„ì§œ ë§¤ìˆ˜ê°€ê°€ ë‹¹ì¼ ê³ ê°€ë³´ë‹¤ ë†’ë‹¤ë©´ ì¥ì¤‘ ì²´ê²° ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ íŒ¨ìŠ¤
            if buy_price > self.data.high[0]: return

            trade_amount = self.data.close[0] * self.data.volume[0]

            cash = self.p.bet_cash
            size = math.floor(cash / buy_price)

            buy_reason = f"ì¼ë´‰ ìˆ˜ê¸‰/{self.p.ma_vwap_proxy}ì„  ëŒíŒŒ"
            self.my_position = {
                'price': buy_price,
                'date': current_date,
                'time': current_time,
                'size': size,
                'reason': buy_reason,
                'rsi': self.data.rsi[-1],
                'atr': self.atr[-1],
                'adx': self.adx[-1],
                'bandwidth': bandwidth,
                'surge_pct': surge_pct,
                'gap_pct': gap_pct,
                'trade_amount': trade_amount,
                'prev_trade_amount': prev_trade_amount,
                'avg_trade_amount_20': self.trade_amt_sma[-1],
                'vol_surge_pct': actual_vol_surge,
                'entry_bar': len(self)
            }
            self.peak_price = buy_price

    def stop(self):
        # ë§ˆì§€ë§‰ ìº”ë“¤ ê°•ì œ ì²­ì‚° ë¡œì§
        if self.my_position:
            current_date = self.data.datetime.date(0)
            current_time = self.data.datetime.time(0)
            current_price = self.data.close[0]
            entry_price = self.my_position['price']
            buy_size = self.my_position['size']

            if current_price > self.peak_price:
                self.peak_price = current_price

            pnl = (current_price - entry_price) * buy_size
            profit_pct = ((current_price - entry_price) / entry_price) * 100
            max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100
            entry_rsi = self.my_position.get('rsi', 0)
            entry_atr = self.my_position.get('atr', 0)
            entry_adx = self.my_position.get('adx', 0)
            entry_bandwidth = self.my_position.get('bandwidth', 0)
            entry_surge = self.my_position.get('surge_pct', 0)
            entry_gap_pct = self.my_position.get('gap_pct', 0)
            entry_trade_amount = self.my_position.get('trade_amount', 0)
            entry_prev_trade_amount = self.my_position.get('prev_trade_amount', 0)
            entry_avg_trade_amount_20 = self.my_position.get('avg_trade_amount_20', 0)
            entry_vol_surge = self.my_position.get('vol_surge_pct', 0)
            entry_bar = self.my_position.get('entry_bar', len(self))
            hold_days = len(self) - entry_bar

            self.trades_history.append({
                'open_date': self.my_position['date'],
                'open_time': self.my_position['time'],
                'date': current_date,
                'close_time': current_time,
                'hold_days': hold_days,
                'profit_pct': profit_pct,
                'max_profit_pct': max_profit_pct,
                'pnl': pnl,
                'is_win': pnl > 0,
                'entry_price': entry_price,
                'exit_price': current_price,
                'entry_rsi': entry_rsi,
                'entry_atr': entry_atr,
                'entry_adx': entry_adx,
                'entry_bandwidth': entry_bandwidth,
                'entry_surge': entry_surge,
                'entry_gap_pct': entry_gap_pct,
                'entry_trade_amount': entry_trade_amount,
                'entry_prev_trade_amount': entry_prev_trade_amount,
                'entry_avg_trade_amount_20': entry_avg_trade_amount_20,
                'entry_vol_surge': entry_vol_surge,
                'size': buy_size,
                'status': 'Holding',
                'buy_reason': 'ì¢…ë£Œ ì²­ì‚°',
                'sell_reason': 'ì¢…ë£Œ ì²­ì‚°'
            })


# ==========================================
# ì‹¤í–‰ í•¨ìˆ˜ (ë‹¨ì¼ êµ¬ê°„)
# ==========================================
def run_single_backtest(file_path, is_first_run=False):
    try:
        df = pd.read_excel(file_path)
        df.columns = [c.strip() for c in df.columns]

        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date', 'ì²´ê²°ì‹œê°„': 'Date'}
        df = df.rename(columns=rename_map)

        if 'Date' in df.columns:
            if pd.api.types.is_numeric_dtype(df['Date']):
                df['Date'] = df['Date'].astype(str)
            df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            if not isinstance(df.index, pd.DatetimeIndex):
                return None

        # ê¸°ê°„ í•„í„° ì ìš©
        df = df[(df.index >= START_DATE) & (df.index <= END_DATE)]

        cols_to_numeric = ['Close', 'Open', 'High', 'Low', 'Volume']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()
            else:
                return None

        df = df.dropna(subset=[c for c in cols_to_numeric if c in df.columns])

        if len(df) >= RSI_PERIOD:
            df['rsi'] = calculate_rsi(df['Close'], period=RSI_PERIOD)
            df['rsi'] = df['rsi'].fillna(50)
        else:
            df['rsi'] = 50

        # [ë™ì  ê³„ì‚°] ì „ì—­ íŒŒë¼ë¯¸í„° ì„¤ì •ê°’ì— ë§ì¶° í•„ìš”í•œ ìµœì†Œ ë°ì´í„° ìˆ˜ëŸ‰ ê³„ì‚°
        p = dict(STRATEGY_PARAMS)
        req_len = max(p['ma_vwap_proxy'] + 1, p['boll_period'] + 2, p['vol_period'] + 1, p['ma_trend_slow'] + 1,
                      p['ma_slow'] + 2, 21)

        if len(df) < req_len:
            return None

        cerebro = bt.Cerebro(runonce=False)
        cerebro.broker.setcash(INITIAL_CASH)

        # íŒŒë¼ë¯¸í„°ëŠ” Strategy í´ë˜ìŠ¤ ë‚´ë¶€ì— ì •ì˜ëœ ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ìœ„ì„
        cerebro.addstrategy(CustomDailyStrategy, debug=is_first_run)

        cerebro.adddata(CustomPandasData(dataname=df))

        strats = cerebro.run()
        trades_hist = strats[0].trades_history

        return {
            'trades': len(trades_hist),
            'wins': sum(1 for t in trades_hist if t['is_win']),
            'total_profit': sum(t['pnl'] for t in trades_hist),
            'history': trades_hist
        }

    except Exception as e:
        if is_first_run: print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        return None


def main():
    print(CustomDailyStrategy.__doc__)
    p = dict(STRATEGY_PARAMS)

    # ì¶œë ¥ í…ìŠ¤íŠ¸ë“¤ë„ íŒŒë¼ë¯¸í„° ê°’ì„ ê·¸ëŒ€ë¡œ ì½ì–´ì™€ì„œ í‘œì‹œí•˜ë„ë¡ ì—°ë™
    print("=== ğŸ¯ [ì¼ë´‰ ë‹¨ê¸°ë§¤ë§¤ ì „ëµ] ê°œë³„ ê²Œì„ë³„ ìƒì„¸ ì„±ê³¼ ë¦¬í¬íŠ¸ ===")
    print(
        f"ğŸ“Œ ì„¤ì •: {p['target_pct'] * 100:.1f}% ê¸‰ë“±ì–‘ë´‰, ê±°ë˜ëŸ‰ {int(p['vol_surge'] * 100)}% í­ì¦, {p['ma_trend_fast']}>{p['ma_trend_slow']}ì„  ì •ë°°ì—´, {p['ma_vwap_proxy']}ì„  ì´í‰ ìƒíšŒ")
    print(f"ğŸ“Œ ì²­ì‚°: {p['ma_fast']}ì„ /{p['ma_slow']}ì„  ë°ë“œí¬ë¡œìŠ¤ ì´íƒˆ ì‹œ ì¦‰ì‹œ ë§¤ë„")
    print(f"ğŸ“Œ ê¸°ê°„: {START_DATE} ~ {END_DATE if END_DATE != '2099-12-31' else 'í˜„ì¬'}")

    data_dir = DATA_FOLDER
    if not os.path.exists(data_dir):
        print(f"ğŸš¨ '{data_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤! ë°ì´í„°ë¥¼ í´ë” ì•ˆì— ë„£ì–´ì£¼ì„¸ìš”.")
        return

    # ==========================================
    # [ìˆ˜ì •] ê³µí†µ ì§€ìˆ˜ ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬ (ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©)
    # ==========================================
    load_global_indices()

    kospi_idx_df = GLOBAL_KOSPI_DF
    kosdaq_idx_df = GLOBAL_KOSDAQ_DF

    # ì§€ìˆ˜ ë° ê¸°íƒ€ ë¶„ì„ì„ ìœ„í•œ ë²„í‚·(êµ¬ê°„) ë¶„ë¥˜ í•¨ìˆ˜
    def get_pct_bucket(val):
        if pd.isna(val): return '0.0~0.5%'
        if val <= -4.0:
            return '-4.0% ì´í•˜'
        elif val <= -3.5:
            return '-4.0~-3.5%'
        elif val <= -3.0:
            return '-3.5~-3.0%'
        elif val <= -2.5:
            return '-3.0~-2.5%'
        elif val <= -2.0:
            return '-2.5~-2.0%'
        elif val <= -1.5:
            return '-2.0~-1.5%'
        elif val <= -1.0:
            return '-1.5~-1.0%'
        elif val <= -0.5:
            return '-1.0~-0.5%'
        elif val <= 0.0:
            return '-0.5~0.0%'
        elif val <= 0.5:
            return '0.0~0.5%'
        elif val <= 1.0:
            return '0.5~1.0%'
        elif val <= 1.5:
            return '1.0~1.5%'
        elif val <= 2.0:
            return '1.5~2.0%'
        elif val <= 2.5:
            return '2.0~2.5%'
        elif val <= 3.0:
            return '2.5~3.0%'
        elif val <= 3.5:
            return '3.0~3.5%'
        elif val <= 4.0:
            return '3.5~4.0%'
        else:
            return '4.0% ì´ìƒ'

    def get_adr_bucket(val):
        if pd.isna(val): return '100~110%'
        if val < 70:
            return '70% ë¯¸ë§Œ'
        elif val < 80:
            return '70~80%'
        elif val < 90:
            return '80~90%'
        elif val < 100:
            return '90~100%'
        elif val < 110:
            return '100~110%'
        elif val < 120:
            return '110~120%'
        elif val < 130:
            return '120~130%'
        elif val < 140:
            return '130~140%'
        elif val < 150:
            return '140~150%'
        elif val < 160:
            return '150~160%'
        elif val < 170:
            return '160~170%'
        elif val < 180:
            return '170~180%'
        elif val < 190:
            return '180~190%'
        elif val < 200:
            return '190~200%'
        else:
            return '200% ì´ìƒ'

    def get_gap_bucket(val):
        if pd.isna(val): return '0%ëŒ€'
        if val <= -11.0:
            return '-11% ì´í•˜'
        elif val >= 10.0:
            return '10% ì´ìƒ'
        else:
            sign = "-" if val < 0 else ""
            abs_int = int(abs(val))
            if val < 0 and abs_int == 0:
                return "-0%ëŒ€"
            return f"{sign}{abs_int}%ëŒ€"

    def get_amount_bucket(val):
        if val < 10000000000:
            return '100ì–µ ë¯¸ë§Œ'
        elif val < 20000000000:
            return '100ì–µëŒ€'
        elif val < 30000000000:
            return '200ì–µëŒ€'
        elif val < 40000000000:
            return '300ì–µëŒ€'
        elif val < 50000000000:
            return '400ì–µëŒ€'
        elif val < 60000000000:
            return '500ì–µëŒ€'
        elif val < 70000000000:
            return '600ì–µëŒ€'
        elif val < 80000000000:
            return '700ì–µëŒ€'
        elif val < 90000000000:
            return '800ì–µëŒ€'
        elif val < 100000000000:
            return '900ì–µëŒ€'
        elif val < 150000000000:
            return '1000~1500ì–µ'
        elif val < 200000000000:
            return '1500~2000ì–µ'
        elif val < 250000000000:
            return '2000~2500ì–µ'
        else:
            return '2500ì–µ ì´ìƒ'

    # ë²„í‚· ë¦¬ìŠ¤íŠ¸ ì •ì˜
    pct_buckets = ['-4.0% ì´í•˜', '-4.0~-3.5%', '-3.5~-3.0%', '-3.0~-2.5%', '-2.5~-2.0%', '-2.0~-1.5%', '-1.5~-1.0%',
                   '-1.0~-0.5%', '-0.5~0.0%', '0.0~0.5%', '0.5~1.0%', '1.0~1.5%', '1.5~2.0%', '2.0~2.5%', '2.5~3.0%',
                   '3.0~3.5%', '3.5~4.0%', '4.0% ì´ìƒ']
    adr_buckets = ['70% ë¯¸ë§Œ', '70~80%', '80~90%', '90~100%', '100~110%', '110~120%', '120~130%', '130~140%', '140~150%',
                   '150~160%', '160~170%', '170~180%', '180~190%', '190~200%', '200% ì´ìƒ']
    rsi_buckets = ['50 ì´í•˜', '50ëŒ€', '60ëŒ€', '70ëŒ€', '80ëŒ€', '90ëŒ€']
    atr_buckets = ['2% ë¯¸ë§Œ', '2%~4%', '4%~6%', '6%~8%', '8% ì´ìƒ']
    adx_buckets = ['20 ë¯¸ë§Œ', '20~40', '40~60', '60~80', '80 ì´ìƒ']
    bw_buckets = ['2% ë¯¸ë§Œ', '2~4%', '4~6%', '6~8%', '8~10%', '10~12%', '12~14%', '14~16%', '16~18%', '18~20%', '20~25%',
                  '25~30%', '30~35%', '35~40%', '40% ì´ìƒ']
    surge_buckets = ['1%ëŒ€', '2%ëŒ€', '3%ëŒ€', '4%ëŒ€', '5%ëŒ€', '6%ëŒ€', '7%ëŒ€', '8%ëŒ€', '9%ëŒ€', '10%ëŒ€', '11%ëŒ€', '12%ëŒ€', '13%ëŒ€',
                     '14%ëŒ€', '15%ëŒ€', '16%ëŒ€', '17%ëŒ€', '18%ëŒ€', '19%ëŒ€', '20%ëŒ€', '21%ëŒ€', '22%ëŒ€', '23%ëŒ€', '24%ëŒ€', '25% ì´ìƒ']
    amount_buckets = ['100ì–µ ë¯¸ë§Œ', '100ì–µëŒ€', '200ì–µëŒ€', '300ì–µëŒ€', '400ì–µëŒ€', '500ì–µëŒ€', '600ì–µëŒ€', '700ì–µëŒ€', '800ì–µëŒ€', '900ì–µëŒ€',
                      '1000~1500ì–µ', '1500~2000ì–µ', '2000~2500ì–µ', '2500ì–µ ì´ìƒ']
    vol_surge_buckets = ['300% ë¯¸ë§Œ', '300~400%', '400~500%', '500~600%', '600~700%', '700% ì´ìƒ']
    gap_buckets = ['-11% ì´í•˜', '-10%ëŒ€', '-9%ëŒ€', '-8%ëŒ€', '-7%ëŒ€', '-6%ëŒ€', '-5%ëŒ€', '-4%ëŒ€', '-3%ëŒ€', '-2%ëŒ€', '-1%ëŒ€', '-0%ëŒ€',
                   '0%ëŒ€', '1%ëŒ€', '2%ëŒ€', '3%ëŒ€', '4%ëŒ€', '5%ëŒ€', '6%ëŒ€', '7%ëŒ€', '8%ëŒ€', '9%ëŒ€', '10% ì´ìƒ']

    # í†µê³„ ë”•ì…”ë„ˆë¦¬ ì´ˆê¸°í™”
    def init_stats(buckets):
        return {b: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'gross_profit': 0, 'gross_loss': 0,
                    'sum_profit_pct': 0} for b in buckets}

    kp_ma20_stats = init_stats(pct_buckets)
    kp_gap_stats = init_stats(pct_buckets)
    kp_adr_stats = init_stats(adr_buckets)
    kd_ma20_stats = init_stats(pct_buckets)
    kd_gap_stats = init_stats(pct_buckets)
    kd_adr_stats = init_stats(adr_buckets)

    rsi_stats = init_stats(rsi_buckets)
    atr_stats = init_stats(atr_buckets)
    adx_stats = init_stats(adx_buckets)
    bw_stats = init_stats(bw_buckets)
    surge_stats = init_stats(surge_buckets)
    amount_stats = init_stats(amount_buckets)
    prev_amount_stats = init_stats(amount_buckets)
    avg_amt_20_stats = init_stats(amount_buckets)
    vol_surge_stats = init_stats(vol_surge_buckets)
    gap_stats = init_stats(gap_buckets)

    files = [os.path.join(data_dir, f) for f in os.listdir(data_dir) if f.endswith(".xlsx")]
    print(f"ğŸ“‚ ë¶„ì„ ëŒ€ìƒ: {len(files)}ê°œ ì¢…ëª©\n")

    print(f"\nğŸ“Š [ì „ì²´ ê±°ë˜ ë‚´ì—­ ìƒì„¸]")
    # í‘œ ì»¬ëŸ¼ì— 'ê°­ìƒìŠ¹(%)' ë°˜ì˜
    header_1 = f"{lpad('ì¢…ëª©ëª…', 14)} | {lpad('ë§¤ìˆ˜ì¼', 10)} | {lpad('ë§¤ìˆ˜ì‹œê°„', 8)} | {lpad('ë§¤ë„ì‹œê°„', 8)} | {rpad('ë³´ìœ (ì¼)', 8)} | {rpad('ë§¤ìˆ˜ê°€', 10)} | {rpad('ë§¤ë„ê°€', 10)} | {rpad('ëŒíŒŒìƒìŠ¹ë¥ ', 11)} | {rpad('ê°­ìƒìŠ¹(%)', 10)} | {rpad('ìˆ˜ìµë¥ ', 9)} | {rpad('ìµœëŒ€ìˆ˜ìµ', 9)} | {rpad('RSI', 6)} | {rpad('ATR(%)', 7)} | {rpad('ADX', 6)} | {rpad('ë°´ë“œí­(%)', 10)}"
    print("=" * calc_width(header_1))
    print(header_1)
    print("-" * calc_width(header_1))

    total_stats = {'trades': 0, 'profit': 0, 'wins': 0, 'slippage': 0, 'hold_days': 0, 'gross_profit': 0,
                   'gross_loss': 0}
    all_history = []

    daily_buys = defaultdict(int)
    monthly_daily_buys = defaultdict(lambda: defaultdict(int))
    yearly_daily_buys = defaultdict(lambda: defaultdict(int))

    monthly_stats = defaultdict(
        lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'hold_days': 0, 'gross_profit': 0, 'gross_loss': 0})
    yearly_stats = defaultdict(
        lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0, 'hold_days': 0, 'gross_profit': 0, 'gross_loss': 0})

    for idx, file_path in enumerate(files):
        stock_name = os.path.basename(file_path).split('_')[-1].replace('.xlsx', '')
        is_first = (idx == 0)
        res = run_single_backtest(file_path, is_first_run=is_first)

        if res and res['trades'] > 0:
            total_stats['trades'] += res['trades']
            total_stats['profit'] += res['total_profit']
            total_stats['wins'] += res['wins']

            for t in res['history']:
                t['stock_name'] = stock_name
                t['file_path'] = file_path  # ì°¨íŠ¸ ê·¸ë¦¬ê¸°ìš© íŒŒì¼ ê²½ë¡œ ì €ì¥
                all_history.append(t)

                close_date_str = t['date'] if isinstance(t['date'], str) else t['date'].strftime('%Y-%m-%d')
                open_date_str = t['open_date'] if isinstance(t['open_date'], str) else t['open_date'].strftime(
                    '%Y-%m-%d')
                open_time_str = t['open_time'] if isinstance(t['open_time'], str) else t['open_time'].strftime('%H:%M')
                close_time_str = t['close_time'] if isinstance(t['close_time'], str) else t['close_time'].strftime(
                    '%H:%M')

                hold_days = t.get('hold_days', 0)
                total_stats['hold_days'] += hold_days
                daily_buys[open_date_str] += 1

                profit_pct = t['profit_pct']
                max_profit_pct = t.get('max_profit_pct', 0.0)
                entry_price = t['entry_price']
                exit_price = t['exit_price']
                rsi_val = t.get('entry_rsi', 0)
                atr_raw = t.get('entry_atr', 0)
                atr_val = (atr_raw / entry_price * 100) if entry_price > 0 else 0
                adx_val = t.get('entry_adx', 0)

                # ì¶”ì¶œ
                surge_raw = t.get('entry_surge', 0)
                surge_pct_val = surge_raw * 100
                gap_pct_val = t.get('entry_gap_pct', 0) * 100
                amt_raw = t.get('entry_trade_amount', 0)
                prev_amt_raw = t.get('entry_prev_trade_amount', 0)
                avg_amt_20_raw = t.get('entry_avg_trade_amount_20', 0)
                vol_surge_val = t.get('entry_vol_surge', 0)
                bw_raw = t.get('entry_bandwidth', 0)
                bw_pct = bw_raw * 100

                buy_size = t.get('size', 0)
                slippage_cost = entry_price * buy_size * p['slippage_pct']

                total_stats['slippage'] += slippage_cost

                t_gross_profit = t['pnl'] if t['pnl'] > 0 else 0
                t_gross_loss = abs(t['pnl']) if t['pnl'] <= 0 else 0
                total_stats['gross_profit'] += t_gross_profit
                total_stats['gross_loss'] += t_gross_loss

                # -----------------------------------------------------
                # ì§€ìˆ˜ ë°ì´í„° ë§¤í•‘ ë° ë²„í‚·íŒ… ì²˜ë¦¬
                # -----------------------------------------------------
                try:
                    dt_key = pd.to_datetime(open_date_str)

                    if not kospi_idx_df.empty and dt_key in kospi_idx_df.index:
                        kp_row = kospi_idx_df.loc[dt_key]
                        if isinstance(kp_row, pd.DataFrame): kp_row = kp_row.iloc[0]
                        kp_ma_v = kp_row['Open_to_MA20_pct']
                        kp_gap_v = kp_row['Open_Gap_pct']
                        kp_adr_v = kp_row['Prev_ADR']
                    else:
                        kp_ma_v, kp_gap_v, kp_adr_v = 0, 0, 100

                    if not kosdaq_idx_df.empty and dt_key in kosdaq_idx_df.index:
                        kd_row = kosdaq_idx_df.loc[dt_key]
                        if isinstance(kd_row, pd.DataFrame): kd_row = kd_row.iloc[0]
                        kd_ma_v = kd_row['Open_to_MA20_pct']
                        kd_gap_v = kd_row['Open_Gap_pct']
                        kd_adr_v = kd_row['Prev_ADR']
                    else:
                        kd_ma_v, kd_gap_v, kd_adr_v = 0, 0, 100

                except Exception:
                    kp_ma_v, kp_gap_v, kp_adr_v = 0, 0, 100
                    kd_ma_v, kd_gap_v, kd_adr_v = 0, 0, 100

                kp_ma20_b = get_pct_bucket(kp_ma_v)
                kp_gap_b = get_pct_bucket(kp_gap_v)
                kp_adr_b = get_adr_bucket(kp_adr_v)

                kd_ma20_b = get_pct_bucket(kd_ma_v)
                kd_gap_b = get_pct_bucket(kd_gap_v)
                kd_adr_b = get_adr_bucket(kd_adr_v)

                for stat_dict, b_val in [(kp_ma20_stats, kp_ma20_b), (kp_gap_stats, kp_gap_b), (kp_adr_stats, kp_adr_b),
                                         (kd_ma20_stats, kd_ma20_b), (kd_gap_stats, kd_gap_b),
                                         (kd_adr_stats, kd_adr_b)]:
                    stat_dict[b_val]['games'] += 1
                    stat_dict[b_val]['profit'] += t['pnl']
                    stat_dict[b_val]['slippage'] += slippage_cost
                    stat_dict[b_val]['gross_profit'] += t_gross_profit
                    stat_dict[b_val]['gross_loss'] += t_gross_loss
                    stat_dict[b_val]['sum_profit_pct'] += profit_pct
                    if t['is_win']: stat_dict[b_val]['wins'] += 1
                # -----------------------------------------------------

                # RSI ì§‘ê³„
                bucket = ""
                if rsi_val <= 50:
                    bucket = '50 ì´í•˜'
                elif rsi_val < 60:
                    bucket = '50ëŒ€'
                elif rsi_val < 70:
                    bucket = '60ëŒ€'
                elif rsi_val < 80:
                    bucket = '70ëŒ€'
                elif rsi_val < 90:
                    bucket = '80ëŒ€'
                else:
                    bucket = '90ëŒ€'

                if bucket:
                    rsi_stats[bucket]['games'] += 1
                    rsi_stats[bucket]['profit'] += t['pnl']
                    rsi_stats[bucket]['slippage'] += slippage_cost
                    rsi_stats[bucket]['gross_profit'] += t_gross_profit
                    rsi_stats[bucket]['gross_loss'] += t_gross_loss
                    rsi_stats[bucket]['sum_profit_pct'] += profit_pct
                    if t['is_win']: rsi_stats[bucket]['wins'] += 1

                # ATR ì§‘ê³„
                a_bucket = ""
                if atr_val < 2:
                    a_bucket = '2% ë¯¸ë§Œ'
                elif atr_val < 4:
                    a_bucket = '2%~4%'
                elif atr_val < 6:
                    a_bucket = '4%~6%'
                elif atr_val < 8:
                    a_bucket = '6%~8%'
                else:
                    a_bucket = '8% ì´ìƒ'

                atr_stats[a_bucket]['games'] += 1
                atr_stats[a_bucket]['profit'] += t['pnl']
                atr_stats[a_bucket]['slippage'] += slippage_cost
                atr_stats[a_bucket]['gross_profit'] += t_gross_profit
                atr_stats[a_bucket]['gross_loss'] += t_gross_loss
                atr_stats[a_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: atr_stats[a_bucket]['wins'] += 1

                # ADX ì§‘ê³„
                dx_bucket = ""
                if adx_val < 20:
                    dx_bucket = '20 ë¯¸ë§Œ'
                elif adx_val < 40:
                    dx_bucket = '20~40'
                elif adx_val < 60:
                    dx_bucket = '40~60'
                elif adx_val < 80:
                    dx_bucket = '60~80'
                else:
                    dx_bucket = '80 ì´ìƒ'

                adx_stats[dx_bucket]['games'] += 1
                adx_stats[dx_bucket]['profit'] += t['pnl']
                adx_stats[dx_bucket]['slippage'] += slippage_cost
                adx_stats[dx_bucket]['gross_profit'] += t_gross_profit
                adx_stats[dx_bucket]['gross_loss'] += t_gross_loss
                adx_stats[dx_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: adx_stats[dx_bucket]['wins'] += 1

                # ë°´ë“œí­ ì§‘ê³„
                b_bucket = ""
                if bw_pct < 2.0:
                    b_bucket = '2% ë¯¸ë§Œ'
                elif bw_pct < 4.0:
                    b_bucket = '2~4%'
                elif bw_pct < 6.0:
                    b_bucket = '4~6%'
                elif bw_pct < 8.0:
                    b_bucket = '6~8%'
                elif bw_pct < 10.0:
                    b_bucket = '8~10%'
                elif bw_pct < 12.0:
                    b_bucket = '10~12%'
                elif bw_pct < 14.0:
                    b_bucket = '12~14%'
                elif bw_pct < 16.0:
                    b_bucket = '14~16%'
                elif bw_pct < 18.0:
                    b_bucket = '16~18%'
                elif bw_pct < 20.0:
                    b_bucket = '18~20%'
                elif bw_pct < 25.0:
                    b_bucket = '20~25%'
                elif bw_pct < 30.0:
                    b_bucket = '25~30%'
                elif bw_pct < 35.0:
                    b_bucket = '30~35%'
                elif bw_pct < 40.0:
                    b_bucket = '35~40%'
                else:
                    b_bucket = '40% ì´ìƒ'

                bw_stats[b_bucket]['games'] += 1
                bw_stats[b_bucket]['profit'] += t['pnl']
                bw_stats[b_bucket]['slippage'] += slippage_cost
                bw_stats[b_bucket]['gross_profit'] += t_gross_profit
                bw_stats[b_bucket]['gross_loss'] += t_gross_loss
                bw_stats[b_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: bw_stats[b_bucket]['wins'] += 1

                # ëŒíŒŒìƒìŠ¹ë¥  ì§‘ê³„
                surge_int = int(surge_pct_val)
                if surge_int < 2:
                    s_bucket = '1%ëŒ€'
                elif surge_int >= 25:
                    s_bucket = '25% ì´ìƒ'
                else:
                    s_bucket = f"{surge_int}%ëŒ€"

                surge_stats[s_bucket]['games'] += 1
                surge_stats[s_bucket]['profit'] += t['pnl']
                surge_stats[s_bucket]['slippage'] += slippage_cost
                surge_stats[s_bucket]['gross_profit'] += t_gross_profit
                surge_stats[s_bucket]['gross_loss'] += t_gross_loss
                surge_stats[s_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: surge_stats[s_bucket]['wins'] += 1

                # ê°­ìƒìŠ¹ ì§‘ê³„
                g_bucket = get_gap_bucket(gap_pct_val)
                gap_stats[g_bucket]['games'] += 1
                gap_stats[g_bucket]['profit'] += t['pnl']
                gap_stats[g_bucket]['slippage'] += slippage_cost
                gap_stats[g_bucket]['gross_profit'] += t_gross_profit
                gap_stats[g_bucket]['gross_loss'] += t_gross_loss
                gap_stats[g_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: gap_stats[g_bucket]['wins'] += 1

                # ì§„ì… ë´‰ ê±°ë˜ëŒ€ê¸ˆ ì§‘ê³„
                amt_bucket = get_amount_bucket(amt_raw)
                amount_stats[amt_bucket]['games'] += 1
                amount_stats[amt_bucket]['profit'] += t['pnl']
                amount_stats[amt_bucket]['slippage'] += slippage_cost
                amount_stats[amt_bucket]['gross_profit'] += t_gross_profit
                amount_stats[amt_bucket]['gross_loss'] += t_gross_loss
                amount_stats[amt_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: amount_stats[amt_bucket]['wins'] += 1

                # 1ë´‰ì „ ê±°ë˜ëŒ€ê¸ˆ ì§‘ê³„
                prev_amt_bucket = get_amount_bucket(prev_amt_raw)
                prev_amount_stats[prev_amt_bucket]['games'] += 1
                prev_amount_stats[prev_amt_bucket]['profit'] += t['pnl']
                prev_amount_stats[prev_amt_bucket]['slippage'] += slippage_cost
                prev_amount_stats[prev_amt_bucket]['gross_profit'] += t_gross_profit
                prev_amount_stats[prev_amt_bucket]['gross_loss'] += t_gross_loss
                prev_amount_stats[prev_amt_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: prev_amount_stats[prev_amt_bucket]['wins'] += 1

                # ë§¤ìˆ˜ ì „ 20ì¼ í‰ê·  ê±°ë˜ëŒ€ê¸ˆ ì§‘ê³„
                a20_bucket = get_amount_bucket(avg_amt_20_raw)
                avg_amt_20_stats[a20_bucket]['games'] += 1
                avg_amt_20_stats[a20_bucket]['profit'] += t['pnl']
                avg_amt_20_stats[a20_bucket]['slippage'] += slippage_cost
                avg_amt_20_stats[a20_bucket]['gross_profit'] += t_gross_profit
                avg_amt_20_stats[a20_bucket]['gross_loss'] += t_gross_loss
                avg_amt_20_stats[a20_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: avg_amt_20_stats[a20_bucket]['wins'] += 1

                # ê±°ë˜ëŸ‰ í­ì¦ êµ¬ê°„ë³„ ì§‘ê³„
                if vol_surge_val < 300:
                    v_bucket = '300% ë¯¸ë§Œ'
                elif vol_surge_val < 400:
                    v_bucket = '300~400%'
                elif vol_surge_val < 500:
                    v_bucket = '400~500%'
                elif vol_surge_val < 600:
                    v_bucket = '500~600%'
                elif vol_surge_val < 700:
                    v_bucket = '600~700%'
                else:
                    v_bucket = '700% ì´ìƒ'

                vol_surge_stats[v_bucket]['games'] += 1
                vol_surge_stats[v_bucket]['profit'] += t['pnl']
                vol_surge_stats[v_bucket]['slippage'] += slippage_cost
                vol_surge_stats[v_bucket]['gross_profit'] += t_gross_profit
                vol_surge_stats[v_bucket]['gross_loss'] += t_gross_loss
                vol_surge_stats[v_bucket]['sum_profit_pct'] += profit_pct
                if t['is_win']: vol_surge_stats[v_bucket]['wins'] += 1

                # ì›”ë³„/ë…„ë„ë³„ ì§‘ê³„
                dt_obj = t['open_date'] if not isinstance(t['open_date'], str) else pd.to_datetime(t['open_date'])
                ym = dt_obj.strftime('%Y-%m')
                y = dt_obj.strftime('%Y')

                monthly_daily_buys[ym][open_date_str] += 1
                yearly_daily_buys[y][open_date_str] += 1

                monthly_stats[ym]['games'] += 1
                monthly_stats[ym]['profit'] += t['pnl']
                monthly_stats[ym]['slippage'] += slippage_cost
                monthly_stats[ym]['hold_days'] += hold_days
                monthly_stats[ym]['gross_profit'] += t_gross_profit
                monthly_stats[ym]['gross_loss'] += t_gross_loss
                if t['is_win']: monthly_stats[ym]['wins'] += 1

                yearly_stats[y]['games'] += 1
                yearly_stats[y]['profit'] += t['pnl']
                yearly_stats[y]['slippage'] += slippage_cost
                yearly_stats[y]['hold_days'] += hold_days
                yearly_stats[y]['gross_profit'] += t_gross_profit
                yearly_stats[y]['gross_loss'] += t_gross_loss
                if t['is_win']: yearly_stats[y]['wins'] += 1

                mark = "ğŸ”´" if profit_pct > 0 else "ğŸ”µ"
                hold_str = f"{hold_days}ì¼"
                ep_str = f"{entry_price:,.0f}"
                xp_str = f"{exit_price:,.0f}"
                surge_str = f"{surge_pct_val:.2f}%"
                gap_str = f"{gap_pct_val:.2f}%"
                pct_str = f"{profit_pct:.2f}%"
                max_pct_str = f"{max_profit_pct:.2f}%"
                atr_str = f"{atr_val:.2f}%"
                bw_str = f"{bw_pct:.2f}%"

                # í•œê¸€ í­ ê³ ë ¤í•œ ì»¤ìŠ¤í…€ ì¶œë ¥
                row_str = f"{lpad(stock_name, 14)} | {lpad(open_date_str, 10)} | {lpad(open_time_str, 8)} | {lpad(close_time_str, 8)} | {rpad(hold_str, 8)} | {rpad(ep_str, 10)} | {rpad(xp_str, 10)} | {rpad(surge_str, 11)} | {rpad(gap_str, 10)} | {rpad(pct_str, 9)} | {rpad(max_pct_str, 9)} | {rpad(f'{rsi_val:.1f}', 6)} | {rpad(atr_str, 7)} | {rpad(f'{adx_val:.1f}', 6)} | {rpad(bw_str, 10)}"
                print(f"{row_str} {mark}")

    print("=" * calc_width(header_1))

    avg_win_rate = (total_stats['wins'] / total_stats['trades'] * 100) if total_stats['trades'] > 0 else 0
    total_virtual_profit = total_stats['profit'] - total_stats['slippage']
    total_loss_ratio = (total_stats['slippage'] / abs(total_stats['profit']) * 100) if total_stats['profit'] != 0 else 0

    total_gross_loss_with_slippage = total_stats['gross_loss'] + total_stats['slippage']
    total_loss_profit_ratio = (total_gross_loss_with_slippage / total_stats['gross_profit'] * 100) if total_stats[
                                                                                                          'gross_profit'] > 0 else 0

    avg_hold_days = (total_stats['hold_days'] / total_stats['trades']) if total_stats['trades'] > 0 else 0
    avg_daily_buys = (total_stats['trades'] / len(daily_buys)) if daily_buys else 0

    avg_1hit_rtn = ((total_virtual_profit / total_stats['trades']) / 10000000 * 100) if total_stats['trades'] > 0 else 0

    # ì¼ë´‰ ê¸°ì¤€ 1ë‹¬(20ì¼) íšŒì „ìœ¨ì„ ì¬ì¡°ì •
    turnover_rate = (20 / avg_hold_days) if avg_hold_days > 0 else 0
    expected_games = turnover_rate * 10
    expected_10slot_rtn = expected_games * avg_1hit_rtn

    print(
        f"\nğŸ“ˆ [ì „ì²´ ìš”ì•½] ì´ ë§¤ë§¤ íšŸìˆ˜: {total_stats['trades']}íšŒ, í‰ê·  ìŠ¹ë¥ : {avg_win_rate:.2f}%, "
        f"í‰ê·  ë³´ìœ ê¸°ê°„: {avg_hold_days:.1f}ì¼, ì¼í‰ê·  í¬ì°©: {avg_daily_buys:.1f}ê°œ\n"
        f"ì´ ìˆ˜ìµê¸ˆ: {total_stats['profit']:,.0f}ì› | "
        f"ê°€ìƒìˆ˜ìµê¸ˆ({p['slippage_pct'] * 100:.1f}%ìŠ¬ë¦¬í”¼ì§€): {total_virtual_profit:,.0f}ì› | "
        f"ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨: {total_loss_ratio:.2f}% | ì†ì‹¤/ìˆ˜ìµë¹„: {total_loss_profit_ratio:.2f}%\n"
        f"ğŸ’¡ [ì˜ˆìƒ ì„±ê³¼(ì›”ê¸°ì¤€)] 1íƒ€í‰ê· ìˆ˜ìµë¥ : {avg_1hit_rtn:.2f}% | íšŒì „ë¥ : {turnover_rate:.2f}íšŒ | "
        f"ì˜ˆìƒê²Œì„ìˆ˜: {expected_games:.1f}ë²ˆ | 10ìŠ¬ë¡¯ë‹¹ìˆ˜ìµë¥ : {expected_10slot_rtn:.2f}%"
    )

    # ---------------------------------------------------------
    # í†µí•© ì¶œë ¥ ë° ì°¨íŠ¸ ì €ì¥ í•¨ìˆ˜
    # ---------------------------------------------------------
    def print_and_save_stats(title, stats_dict, buckets, col_width=18):
        print(f"\n\nğŸ“Š [{title}]")
        header = f"{lpad('êµ¬ê°„', col_width)} | {rpad('ê²Œì„ìˆ˜', 10)} | {rpad('ìŠ¹ë¥ ', 10)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)}"
        print("=" * calc_width(header))
        print(header)
        print("-" * calc_width(header))
        for bucket in buckets:
            s = stats_dict[bucket]
            win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
            virtual_profit = s['profit'] - s['slippage']
            loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
            lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

            games_str = f"{s['games']}íšŒ"
            win_str = f"{win_rate:.1f}%"
            profit_str = f"{s['profit']:,.0f}ì›"
            vprofit_str = f"{virtual_profit:,.0f}ì›"
            loss_str = f"{loss_ratio:.2f}%"
            lpr_str = f"{lpr_val:.2f}%"
            print(
                f"{lpad(bucket, col_width)} | {rpad(games_str, 10)} | {rpad(win_str, 10)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)}")

        save_analysis_chart(title, stats_dict, buckets, ANALYSIS_CHART_FOLDER)

    print_and_save_stats("RSI êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", rsi_stats, rsi_buckets, 14)
    print_and_save_stats("ATR(%) êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", atr_stats, atr_buckets, 14)
    print_and_save_stats("ADX êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", adx_stats, adx_buckets, 14)
    print_and_save_stats("ì „ì¼ê¸°ì¤€ ë°´ë“œí­(%) êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", bw_stats, bw_buckets, 14)
    print_and_save_stats("ë‹¹ì¼ ê°­ìƒìŠ¹ë¥  êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", gap_stats, gap_buckets, 14)
    print_and_save_stats("ë§¤ìˆ˜ ì „ 20ì¼ í‰ê·  ê±°ë˜ëŒ€ê¸ˆ êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", avg_amt_20_stats, amount_buckets, 16)
    print_and_save_stats("1ë´‰ì „ ê±°ë˜ëŒ€ê¸ˆ êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", prev_amount_stats, amount_buckets, 14)
    print_and_save_stats("ì§„ì… ë´‰ ê±°ë˜ëŸ‰ í­ì¦ êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„", vol_surge_stats, vol_surge_buckets, 16)

    # ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ì§€ìˆ˜ ê´€ë ¨ ë¶„ì„í‘œ
    print_and_save_stats("KOSPI ë‹¹ì¼ ì‹œê°€ì˜ 20ì¼ì„  ê¸°ì¤€ ì´ê²©ë„(%) ë¶„ì„", kp_ma20_stats, pct_buckets, 18)
    print_and_save_stats("KOSPI ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ì‹œê°€ ë“±ë½ë¥ (%) ë¶„ì„", kp_gap_stats, pct_buckets, 18)

    print_and_save_stats("KOSDAQ ë‹¹ì¼ ì‹œê°€ì˜ 20ì¼ì„  ê¸°ì¤€ ì´ê²©ë„(%) ë¶„ì„", kd_ma20_stats, pct_buckets, 18)
    print_and_save_stats("KOSDAQ ì „ì¼ ì¢…ê°€ ëŒ€ë¹„ ë‹¹ì¼ ì‹œê°€ ë“±ë½ë¥ (%) ë¶„ì„", kd_gap_stats, pct_buckets, 18)

    # ì›”ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ì›”ë³„ ì„±ê³¼ ë¶„ì„]")
    header_monthly = f"{lpad('ì›” (Month)', 10)} | {rpad('ê²Œì„ìˆ˜', 7)} | {rpad('ë§¤ìˆ˜ì¢…ëª©ìˆ˜í‰ê· ', 14)} | {rpad('í‰ê· ë³´ìœ ê¸°ê°„', 12)} | {rpad('ìŠ¹ë¥ ', 9)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)} | {rpad('1íƒ€ìˆ˜ìµë¥ ', 10)} | {rpad('íšŒì „ë¥ ', 8)} | {rpad('ì˜ˆìƒê²Œì„ìˆ˜', 10)} | {rpad('10ìŠ¬ë¡¯ìˆ˜ìµë¥ ', 14)}"
    print("=" * calc_width(header_monthly))
    print(header_monthly)
    print("-" * calc_width(header_monthly))
    for ym in sorted(monthly_stats.keys()):
        s = monthly_stats[ym]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        avg_monthly_buys = s['games'] / len(monthly_daily_buys[ym]) if monthly_daily_buys[ym] else 0

        # ì¼ë´‰ ì „ìš© ì›”ë³„ ê¸°ëŒ€ìˆ˜ìµ ê³„ì‚°
        m_avg_hold = s['hold_days'] / s['games'] if s['games'] > 0 else 0
        m_1hit_rtn = ((virtual_profit / s['games']) / 10000000 * 100) if s['games'] > 0 else 0
        m_turnover = (20 / m_avg_hold) if m_avg_hold > 0 else 0
        m_exp_games = m_turnover * 10
        m_10slot_rtn = m_exp_games * m_1hit_rtn
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        buys_str = f"{avg_monthly_buys:.1f}ê°œ"
        hold_str = f"{m_avg_hold:.1f}ì¼"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        hit_str = f"{m_1hit_rtn:.2f}%"
        turn_str = f"{m_turnover:.2f}"
        exp_str = f"{m_exp_games:.1f}ë²ˆ"
        slot_str = f"{m_10slot_rtn:.2f}%"

        print(
            f"{lpad(ym, 10)} | {rpad(games_str, 7)} | {rpad(buys_str, 14)} | {rpad(hold_str, 12)} | {rpad(win_str, 9)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)} | {rpad(hit_str, 10)} | {rpad(turn_str, 8)} | {rpad(exp_str, 10)} | {rpad(slot_str, 14)}")

    # ë…„ë„ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ë…„ë„ë³„ ì„±ê³¼ ë¶„ì„]")
    header_yearly = f"{lpad('ë…„ë„ (Year)', 11)} | {rpad('ê²Œì„ìˆ˜', 7)} | {rpad('ë§¤ìˆ˜ì¢…ëª©ìˆ˜í‰ê· ', 14)} | {rpad('í‰ê· ë³´ìœ ê¸°ê°„', 12)} | {rpad('ìŠ¹ë¥ ', 9)} | {rpad('ì´ ìˆ˜ìµê¸ˆ', 18)} | {rpad('ê°€ìƒìˆ˜ìµê¸ˆ', 18)} | {rpad('ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨', 12)} | {rpad('ì†ì‹¤/ìˆ˜ìµë¹„', 11)} | {rpad('1íƒ€ìˆ˜ìµë¥ ', 10)} | {rpad('íšŒì „ë¥ (ë…„)', 10)} | {rpad('ì˜ˆìƒê²Œì„ìˆ˜', 10)} | {rpad('10ìŠ¬ë¡¯ìˆ˜ìµë¥ ', 14)}"
    print("=" * calc_width(header_yearly))
    print(header_yearly)
    print("-" * calc_width(header_yearly))
    for y in sorted(yearly_stats.keys()):
        s = yearly_stats[y]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        avg_yearly_buys = s['games'] / len(yearly_daily_buys[y]) if yearly_daily_buys[y] else 0

        # ì¼ë´‰ ì „ìš© ì—°ë„ë³„ ê¸°ëŒ€ìˆ˜ìµ ê³„ì‚°
        y_avg_hold = s['hold_days'] / s['games'] if s['games'] > 0 else 0
        y_1hit_rtn = ((virtual_profit / s['games']) / 10000000 * 100) if s['games'] > 0 else 0
        y_turnover = (240 / y_avg_hold) if y_avg_hold > 0 else 0
        y_exp_games = y_turnover * 10
        y_10slot_rtn = y_exp_games * y_1hit_rtn
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        lpr_val = ((s['gross_loss'] + s['slippage']) / s['gross_profit'] * 100) if s['gross_profit'] > 0 else 0

        games_str = f"{s['games']}íšŒ"
        buys_str = f"{avg_yearly_buys:.1f}ê°œ"
        hold_str = f"{y_avg_hold:.1f}ì¼"
        win_str = f"{win_rate:.1f}%"
        profit_str = f"{s['profit']:,.0f}ì›"
        vprofit_str = f"{virtual_profit:,.0f}ì›"
        loss_str = f"{loss_ratio:.2f}%"
        lpr_str = f"{lpr_val:.2f}%"
        hit_str = f"{y_1hit_rtn:.2f}%"
        turn_str = f"{y_turnover:.2f}"
        exp_str = f"{y_exp_games:.1f}ë²ˆ"
        slot_str = f"{y_10slot_rtn:.2f}%"

        print(
            f"{lpad(y, 11)} | {rpad(games_str, 7)} | {rpad(buys_str, 14)} | {rpad(hold_str, 12)} | {rpad(win_str, 9)} | {rpad(profit_str, 18)} | {rpad(vprofit_str, 18)} | {rpad(loss_str, 12)} | {rpad(lpr_str, 11)} | {rpad(hit_str, 10)} | {rpad(turn_str, 10)} | {rpad(exp_str, 10)} | {rpad(slot_str, 14)}")
    print("=" * calc_width(header_yearly))

    # ==========================================
    # [ì¶”ê°€] ì°¨íŠ¸ ìƒì„±: ìˆ˜ìµë¥  Top 5 / Bottom 5
    # ==========================================
    if all_history:
        chart_dir = CHART_FOLDER
        if not os.path.exists(chart_dir):
            os.makedirs(chart_dir)

        print(f"\n\nğŸ“Š [ì°¨íŠ¸ ìƒì„± ì¤‘...] '{chart_dir}' í´ë”ì— ìˆ˜ìµë¥  Top 5 / Bottom 5 ì°¨íŠ¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.")
        print(f"ğŸ“Š [ì°¨íŠ¸ ìƒì„± ì¤‘...] '{ANALYSIS_CHART_FOLDER}' í´ë”ì— êµ¬ê°„ë³„ ì„±ê³¼ ì°¨íŠ¸(ë§‰ëŒ€/ì„ )ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.")

        # ìˆ˜ìµë¥  ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        sorted_history = sorted(all_history, key=lambda x: x['profit_pct'], reverse=True)
        top_5 = sorted_history[:5]

        # ë°ì´í„°ê°€ 5ê°œ ì´ìƒì¼ ê²½ìš° í•˜ìœ„ 5ê°œ ì¶”ì¶œ
        bottom_5 = sorted_history[-5:] if len(sorted_history) > 5 else []

        targets = [("Top", i + 1, t) for i, t in enumerate(top_5)]

        # Bottomì€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë’¤ì§‘ì–´ì„œ ê°€ì¥ ìˆ˜ìµë¥ ì´ ë‚®ì€ ê²ƒì´ 1ìœ„ê°€ ë˜ë„ë¡ ì²˜ë¦¬
        targets += [("Bottom", i + 1, t) for i, t in enumerate(reversed(bottom_5))]

        for prefix, rank, t in targets:
            save_chart(t, chart_dir, prefix, rank)

        print("âœ… ëª¨ë“  ë°ì´í„° ì§‘ê³„ ë° ì°¨íŠ¸ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")


if __name__ == "__main__":
    main()
