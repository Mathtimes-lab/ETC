# ==========================================
# ğŸ“Š [ìƒì„¸ ê±°ë˜ ë‚´ì—­ ë¦¬í¬íŠ¸] ë°´ë“œí­ 12% ì´ìƒ + RSI + ì›”ë³„/ë…„ë„ë³„ ë¶„ì„ (ìˆ˜ì •íŒ)
# =================================================================================================================
# ì¢…ëª©ëª…          | ë§¤ìˆ˜ì¼       | ë§¤ë„ì¼       |     ë§¤ìˆ˜ê°€ |     ë§¤ë„ê°€ |  ìˆ˜ìµë¥  | ìµœëŒ€ìˆ˜ìµë¥  |   RSI
# -----------------------------------------------------------------------------------------------------------------
# ...
# =================================================================================================================
import matplotlib

# í™”ë©´ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì—ì„œ ì´ë¯¸ì§€ ìƒì„± (ì¶©ëŒ ë°©ì§€)
matplotlib.use('Agg')

import backtrader as bt
import pandas as pd
import os
import math
from datetime import time, timedelta
from collections import defaultdict
import matplotlib.pyplot as plt


# [ìˆ˜ì •] ë°ì´í„° íŒŒì¼ì˜ ì»¬ëŸ¼ëª…(ëŒ€ë¬¸ì)ê³¼ Backtrader ë‚´ë¶€ ë¼ì¸ì„ ë§¤í•‘
class CustomPandasData(bt.feeds.PandasData):
    lines = ('rsi',)
    params = (
        ('datetime', None),  # ì¸ë±ìŠ¤ë¥¼ ë‚ ì§œë¡œ ì‚¬ìš©
        ('open', 'Open'),  # íŒŒì¼ì˜ 'Open' ì»¬ëŸ¼
        ('high', 'High'),  # íŒŒì¼ì˜ 'High' ì»¬ëŸ¼
        ('low', 'Low'),  # íŒŒì¼ì˜ 'Low' ì»¬ëŸ¼
        ('close', 'Close'),  # íŒŒì¼ì˜ 'Close' ì»¬ëŸ¼
        ('volume', 'Volume'),  # íŒŒì¼ì˜ 'Volume' ì»¬ëŸ¼
        ('openinterest', None),  # OpenInterest ì—†ìŒ
        ('rsi', 'rsi'),  # ê³„ì‚°ëœ 'rsi' ì»¬ëŸ¼ ì‚¬ìš©
    )


# [ì¶”ê°€] RSI ê³„ì‚° í•¨ìˆ˜ (ë°ì´í„° ì „ì²˜ë¦¬ìš©)
def calculate_rsi(series, period=14):
    delta = series.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    return 100 - (100 / (1 + rs))


# ==========================================
# [ì „ëµ] ì¼ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + ë°´ë“œí­ êµ¬ê°„ í•„í„° + ì •ë°€ ë§¤ë„
# ==========================================
class CustomDailyStrategy(bt.Strategy):
    """
    [ìƒì„¸ ì „ëµ ì„¤ëª…]
    ================================================================================
    1. ë§¤ìˆ˜ ì§„ì… ì¡°ê±´ (ëª¨ë‘ ë§Œì¡± ì‹œ)
       A. [ë³€ë™ì„± ëŒíŒŒ] ì˜¤ëŠ˜ ê³ ê°€ > Max(ì „ì¼ì¢…ê°€+5%, ì •ë°°ì—´ì „í™˜ê°€)
       B. [ìœ ë™ì„±] ì „ì¼ ê±°ë˜ëŒ€ê¸ˆ 10ì–µ ì› ì´ìƒ (ì¡°ê±´ ì™„í™”ë¨)
       C. [ì¶”ì„¸] ë‹¹ì¼ ê¸°ì¤€ 3ì¼ì„  > 5ì¼ì„  ì •ë°°ì—´ (ì „ì¼ ì—­ë°°ì—´ì´ì–´ë„ ë‹¹ì¼ ì „í™˜ ì‹œ ì¸ì •)
          - ë§¤ìˆ˜ê°€ê²©ì„ 'ì •ë°°ì—´ ì „í™˜ê°€' ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì²´ê²° ì‹œì  ì •ë°°ì—´ ë³´ì¥
       D. [ìˆ˜ë ´] ì „ì¼ ê¸°ì¤€ ë°´ë“œí­ 12% ì´ìƒ
    ================================================================================
    """
    params = (
        ('target_pct', 0.05),  # 5%
        ('ma_fast', 3),  # 3ì¼
        ('ma_slow', 5),  # 5ì¼
        ('boll_period', 20),  # ë³¼ë¦°ì €ë°´ë“œ ê¸°ê°„
        ('boll_dev', 2.0),  # ë³¼ë¦°ì €ë°´ë“œ ìŠ¹ìˆ˜
        ('bandwidth_min', 0.12),  # ë°´ë“œí­ ìµœì†Œê°’
        ('bandwidth_max', 100.0),  # ë°´ë“œí­ ìµœëŒ€ê°’
        ('debug', False),  # ë””ë²„ê·¸ ëª¨ë“œ
    )

    def __init__(self):
        self.ma3 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_fast)
        self.ma5 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_slow)

        # ë³¼ë¦°ì €ë°´ë“œ ì§€í‘œ
        typical_price = (self.data.high + self.data.low + self.data.close) / 3.0
        self.bband = bt.indicators.BollingerBands(typical_price, period=self.p.boll_period, devfactor=self.p.boll_dev)

        # ìˆ˜ë™ í¬ì§€ì…˜ ê´€ë¦¬ìš© ë³€ìˆ˜ (Backtrader Broker ë¯¸ì‚¬ìš©)
        self.my_position = None
        self.trades_history = []
        self.peak_price = 0

    def next(self):
        # ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if len(self.data) < max(self.p.ma_slow + 2, self.p.boll_period + 2):
            return

        current_date = self.data.datetime.date(0)

        # ----------------------------------------------------------------------
        # [1] ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ë„(ì²­ì‚°) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position:
            # ìµœê³ ê°€ ê°±ì‹ 
            if self.data.high[0] > self.peak_price:
                self.peak_price = self.data.high[0]

            # ë°ë“œí¬ë¡œìŠ¤ ê°€ê²© ê³„ì‚° (ì˜¤ëŠ˜ ê¸°ì¤€)
            # MA3(0) < MA5(0)ê°€ ë˜ëŠ” C(0) ì°¾ê¸°
            # P0 < 1.5*(P-3 + P-4) - (P-1 + P-2)
            c_1 = self.data.close[-1]
            c_2 = self.data.close[-2]
            c_3 = self.data.close[-3]
            c_4 = self.data.close[-4]

            cross_price_raw = 1.5 * (c_3 + c_4) - (c_1 + c_2)
            cross_price = round(cross_price_raw)

            sell_signal = False
            sell_price = 0
            sell_reason = ""

            # ì¡°ê±´ 1: ì´ë¯¸ ì „ì¼ ì¢…ê°€ ê¸°ì¤€ìœ¼ë¡œ ì—­ë°°ì—´ ìƒíƒœ (ì•ˆì „ì¥ì¹˜)
            if self.ma3[-1] < self.ma5[-1]:
                sell_signal = True
                sell_price = self.data.open[0]
                sell_reason = "ì „ì¼ ì´ë¯¸ ë°ë“œí¬ë¡œìŠ¤ ìƒíƒœ"

            # ì¡°ê±´ 2: ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ (ì €ê°€ê°€ êµì°¨ ê°€ê²© ì´í•˜)
            elif self.data.low[0] <= cross_price:
                sell_signal = True
                if self.data.open[0] < cross_price:
                    sell_price = self.data.open[0]
                    sell_reason = "ê°­í•˜ë½ ë°ë“œí¬ë¡œìŠ¤"
                else:
                    sell_price = cross_price
                    sell_reason = "ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ í„°ì¹˜"

            if sell_signal:
                # ê±°ë˜ ê¸°ë¡
                entry_price = self.my_position['price']
                buy_size = self.my_position['size']
                buy_reason = self.my_position['reason']
                entry_rsi = self.my_position.get('rsi', 0)
                open_date = self.my_position['date']

                pnl = (sell_price - entry_price) * buy_size
                profit_pct = ((sell_price - entry_price) / entry_price) * 100
                max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100

                self.trades_history.append({
                    'open_date': open_date,
                    'date': current_date,
                    'profit_pct': profit_pct,
                    'max_profit_pct': max_profit_pct,
                    'pnl': pnl,
                    'is_win': pnl > 0,
                    'entry_price': entry_price,
                    'exit_price': sell_price,
                    'entry_rsi': entry_rsi,
                    'size': buy_size,
                    'status': 'Closed',
                    'buy_reason': buy_reason,
                    'sell_reason': sell_reason
                })
                self.my_position = None
                self.peak_price = 0
                return

        # ----------------------------------------------------------------------
        # [2] ë¯¸ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ìˆ˜(ì§„ì…) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position is None:
            prev_close = self.data.close[-1]

            # 1. 5% ë³€ë™ì„± ëª©í‘œê°€
            target_price = prev_close * (1 + self.p.target_pct)
            target_price = math.ceil(target_price)

            # A. 1ì°¨ í•„í„°: ê³ ê°€ê°€ ëª©í‘œê°€ ì´ìƒì¸ê°€?
            if self.data.high[0] < target_price:
                return

            # B. ìœ ë™ì„± í™•ì¸ (ì „ì¼ ê±°ë˜ëŒ€ê¸ˆ)
            trade_amount = self.data.close[-1] * self.data.volume[-1]
            if trade_amount < 5000000000:  # 50ì–µ
                return

            # [ìˆ˜ì •] C. ì •ë°°ì—´ í™•ì¸ (ì „ì¼ ê¸°ì¤€ í•„í„° ì‚­ì œ)
            if self.ma3[-1] <= self.ma5[-1]: return
            # ëŒ€ì‹  ì•„ë˜ ë§¤ìˆ˜ê°€ê²© ì„¤ì • ë¡œì§ì—ì„œ ë‹¹ì¼ ì •ë°°ì—´ ì¡°ê±´ì„ ê°•ì œí•¨

            # C-2. RSIì¡°ê±´ (80ë¯¸ë§Œì¸ ê²ƒë§Œ ì§„ì…) -> [ìˆ˜ì •] ì „ì¼ ê¸°ì¤€
            if self.data.rsi[-1] >= 80:
                return

            # D. ë°´ë“œí­ í™•ì¸ (ì „ì¼ ê¸°ì¤€)
            top = self.bband.lines.top[-1]
            bot = self.bband.lines.bot[-1]
            mid = self.bband.lines.mid[-1]

            if mid == 0: return
            bandwidth = (top - bot) / mid

            if not (self.p.bandwidth_min <= bandwidth < self.p.bandwidth_max):
                return

            # [ë§¤ìˆ˜ê°€ê²© ì„¤ì • ë¡œì§]
            # ì •ë°°ì—´ ì „í™˜ ê°€ê²©(Golden Cross Price) ê³„ì‚° (P0 > 1.5*(P3+P4) - (P1+P2))
            c_1 = self.data.close[-1]
            c_2 = self.data.close[-2]
            c_3 = self.data.close[-3]
            c_4 = self.data.close[-4]

            golden_cross_price_raw = 1.5 * (c_3 + c_4) - (c_1 + c_2)
            golden_cross_price = math.ceil(golden_cross_price_raw)

            # ìµœì¢… ë§¤ìˆ˜ ìš”êµ¬ ê°€ê²© = Max(5% ìƒìŠ¹ê°€, ì •ë°°ì—´ ì „í™˜ê°€)
            # ì „ì¼ ì—­ë°°ì—´ì´ì—ˆì–´ë„, ì˜¤ëŠ˜ ì´ ê°€ê²©ì„ ë„˜ìœ¼ë©´ ì •ë°°ì—´ì´ ë¨
            buy_req_price = max(target_price, golden_cross_price)

            # ë§¤ìˆ˜ ì²´ê²° ê°€ê²© ê²°ì •
            buy_price = 0
            # ê°­ìƒìŠ¹ ì‹œ ì‹œê°€ ë§¤ìˆ˜, ì•„ë‹ˆë©´ ì§€ì •ê°€ ë§¤ìˆ˜
            if self.data.open[0] > buy_req_price:
                buy_price = self.data.open[0]
            else:
                buy_price = buy_req_price

            # ê³ ê°€ê°€ ì‹¤ì œ ì§„ì…ê°€(buy_req_price)ì— ë„ë‹¬í–ˆëŠ”ì§€ ìµœì¢… í™•ì¸
            if self.data.high[0] < buy_req_price:
                return

            # ë§¤ìˆ˜ ê¸°ë¡ ìƒì„±
            cash = 10000000
            size = math.floor(cash / buy_price)

            buy_reason = "ì¡°ê±´ ë§Œì¡± ì§„ì…"
            self.my_position = {
                'price': buy_price,
                'date': current_date,
                'size': size,
                'reason': buy_reason,
                'rsi': self.data.rsi[-1]  # [ìˆ˜ì •] ê¸°ë¡ë„ ì „ì¼ ê¸°ì¤€
            }
            self.peak_price = buy_price

    def stop(self):
        # ë§ˆì§€ë§‰ ë‚  ê°•ì œ ì²­ì‚°
        if self.my_position:
            current_date = self.data.datetime.date(0)
            current_price = self.data.close[0]
            entry_price = self.my_position['price']
            buy_size = self.my_position['size']

            if current_price > self.peak_price:
                self.peak_price = current_price

            pnl = (current_price - entry_price) * buy_size
            profit_pct = ((current_price - entry_price) / entry_price) * 100
            max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100
            entry_rsi = self.my_position.get('rsi', 0)

            self.trades_history.append({
                'open_date': self.my_position['date'],
                'date': current_date,
                'profit_pct': profit_pct,
                'max_profit_pct': max_profit_pct,
                'pnl': pnl,
                'is_win': pnl > 0,
                'entry_price': entry_price,
                'exit_price': current_price,
                'entry_rsi': entry_rsi,
                'size': buy_size,
                'status': 'Holding',
                'buy_reason': 'ì¢…ë£Œ ì²­ì‚°',
                'sell_reason': 'ì¢…ë£Œ ì²­ì‚°'
            })


# ==========================================
# ì‹¤í–‰ í•¨ìˆ˜ (ë‹¨ì¼ êµ¬ê°„)
# ==========================================
def run_single_backtest(file_path, target_pct, bandwidth_min, bandwidth_max, is_first_run=False):
    try:
        df = pd.read_excel(file_path)

        # [ìˆ˜ì •] ì»¬ëŸ¼ëª… ê³µë°± ì œê±° (ë§¤ ì¤‘ìš”)
        df.columns = [c.strip() for c in df.columns]

        # [ë””ë²„ê·¸] ì²« íŒŒì¼ ì»¬ëŸ¼ëª… í™•ì¸
        if is_first_run:
            print(f"ğŸ” [DEBUG] ë¡œë“œëœ ì»¬ëŸ¼ëª…: {list(df.columns)}")

        # [ìˆ˜ì •] í•œê¸€ -> ì˜ì–´ ë§¤í•‘
        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date'}
        df = df.rename(columns=rename_map)

        # [ìˆ˜ì •] ë‚ ì§œ ì»¬ëŸ¼ ì²˜ë¦¬ ê°•í™” (ì¸ë±ìŠ¤ë¡œ ì„¤ì •)
        if 'Date' in df.columns:
            if pd.api.types.is_numeric_dtype(df['Date']):
                df['Date'] = df['Date'].astype(str)
            df['Date'] = pd.to_datetime(df['Date'])
            df = df.sort_values('Date').set_index('Date')
        else:
            if isinstance(df.index, pd.DatetimeIndex):
                pass
            else:
                if is_first_run: print("âŒ 'Date' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ê³  ì¸ë±ìŠ¤ë„ ë‚ ì§œê°€ ì•„ë‹™ë‹ˆë‹¤.")
                return None

        # [ì¶”ê°€] ê²€ìƒ‰ê¸°ê°„ í•„í„°: 2025ë…„ 1ì›” 1ì¼ ì´í›„ ë°ì´í„°ë§Œ ì‚¬ìš©
        df = df[df.index >= '2025-01-01']

        # [ìˆ˜ì •] ìˆ«ìí˜• ë³€í™˜ (ì½¤ë§ˆ ì œê±° í¬í•¨)
        cols_to_numeric = ['Close', 'Open', 'High', 'Low', 'Volume']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()
            else:
                if is_first_run: print(f"âŒ í•„ìˆ˜ ì»¬ëŸ¼ '{col}' ëˆ„ë½")
                return None

        df = df.dropna(subset=[c for c in cols_to_numeric if c in df.columns])

        # RSI ë¯¸ë¦¬ ê³„ì‚° ë° NaN ì²˜ë¦¬
        if len(df) >= 14:
            df['rsi'] = calculate_rsi(df['Close'], period=14)
            df['rsi'] = df['rsi'].fillna(50)
        else:
            df['rsi'] = 50

        if len(df) < 30:
            if is_first_run: print(f"âš ï¸ ë°ì´í„° ë¶€ì¡±: {len(df)}í–‰")
            return None

        cerebro = bt.Cerebro(runonce=False)
        cerebro.broker.setcash(100000000)

        # ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™” (ì²« ë²ˆì§¸ íŒŒì¼ë§Œ)
        cerebro.addstrategy(CustomDailyStrategy,
                            target_pct=target_pct,
                            bandwidth_min=bandwidth_min,
                            bandwidth_max=bandwidth_max,
                            debug=is_first_run)

        cerebro.adddata(CustomPandasData(dataname=df))

        strats = cerebro.run()
        trades_hist = strats[0].trades_history

        return {
            'trades': len(trades_hist),
            'wins': sum(1 for t in trades_hist if t['is_win']),
            'total_profit': sum(t['pnl'] for t in trades_hist),
            'history': trades_hist
        }

    except Exception as e:
        if is_first_run: print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        return None


def main():
    print(CustomDailyStrategy.__doc__)
    print("=== ğŸ¯ [ì¼ë´‰ ì „ëµ] ê°œë³„ ê²Œì„ë³„ ìƒì„¸ ì„±ê³¼ ë¦¬í¬íŠ¸ ===")
    print("ğŸ“Œ ì„¤ì •: ë³¼ë¦°ì €ë°´ë“œ(20, 2), ë°´ë“œí­ 12% ì´ìƒ, í™•ì¸ ë§¤ë§¤(ë‹¹ì¼ ì²´ê²°)")
    print("ğŸ“Œ ê¸°ê°„: 2025-01-01 ~ í˜„ì¬")

    # [ìˆ˜ì •] ë°ì´í„° ê²½ë¡œ ë³€ê²½ (stock_data_100)
    data_dir = "stock_data_500"
    if not os.path.exists(data_dir):
        print(f"ğŸš¨ '{data_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return

    files = [os.path.join(data_dir, f) for f in os.listdir(data_dir) if f.endswith(".xlsx")]
    print(f"ğŸ“‚ ë¶„ì„ ëŒ€ìƒ: {len(files)}ê°œ ì¢…ëª©\n")

    target_pct = 0.05
    # [ìˆ˜ì •] ë°´ë“œí­: 12% ~ ë¬´ì œí•œ (100.0)
    bw_min = 0.12
    bw_max = 100.0

    print(f"\nğŸ“Š [ì „ì²´ ê±°ë˜ ë‚´ì—­ ìƒì„¸]")
    print("=" * 110)
    print(f"{'ì¢…ëª©ëª…':<12} | {'ë§¤ìˆ˜ì¼':<10} | {'ë§¤ë„ì¼':<10} | {'ë§¤ìˆ˜ê°€':>9} | {'ë§¤ë„ê°€':>9} | {'ìˆ˜ìµë¥ ':>7} | {'ìµœëŒ€ìˆ˜ìµë¥ ':>9} | {'RSI':>6}")
    print("-" * 110)

    total_stats = {'trades': 0, 'profit': 0, 'wins': 0, 'slippage': 0}
    all_history = []

    rsi_stats = {
        '50 ì´í•˜': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '50ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '60ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '70ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '80ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
        '90ëŒ€': {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0},
    }

    monthly_stats = defaultdict(lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0})
    yearly_stats = defaultdict(lambda: {'games': 0, 'wins': 0, 'profit': 0, 'slippage': 0})

    for idx, file_path in enumerate(files):
        stock_name = os.path.basename(file_path).split('_')[-1].replace('.xlsx', '')

        # ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ë””ë²„ê·¸ ëª¨ë“œ ì‹¤í–‰
        is_first = (idx == 0)
        res = run_single_backtest(file_path, target_pct, bw_min, bw_max, is_first_run=is_first)

        if res and res['trades'] > 0:
            total_stats['trades'] += res['trades']
            total_stats['profit'] += res['total_profit']
            total_stats['wins'] += res['wins']

            for t in res['history']:
                t['stock_name'] = stock_name
                all_history.append(t)

                if isinstance(t['date'], str):
                    close_date_str = t['date']
                else:
                    close_date_str = t['date'].strftime('%Y-%m-%d')

                if isinstance(t.get('open_date'), str):
                    open_date_str = t.get('open_date', '-')
                elif t.get('open_date'):
                    open_date_str = t['open_date'].strftime('%Y-%m-%d')
                else:
                    open_date_str = "-"

                profit_pct = t['profit_pct']
                max_profit_pct = t.get('max_profit_pct', 0.0)
                entry_price = t['entry_price']
                exit_price = t['exit_price']
                rsi_val = t.get('entry_rsi', 0)
                buy_size = t.get('size', 0)
                slippage_cost = entry_price * buy_size * 0.01

                total_stats['slippage'] += slippage_cost

                # RSI ì§‘ê³„
                bucket = ""
                if rsi_val <= 50:
                    bucket = '50 ì´í•˜'
                elif rsi_val < 60:
                    bucket = '50ëŒ€'
                elif rsi_val < 70:
                    bucket = '60ëŒ€'
                elif rsi_val < 80:
                    bucket = '70ëŒ€'
                elif rsi_val < 90:
                    bucket = '80ëŒ€'
                else:
                    bucket = '90ëŒ€'

                if bucket:
                    rsi_stats[bucket]['games'] += 1
                    rsi_stats[bucket]['profit'] += t['pnl']
                    rsi_stats[bucket]['slippage'] += slippage_cost
                    if t['is_win']: rsi_stats[bucket]['wins'] += 1

                # ì›”ë³„/ë…„ë„ë³„ ì§‘ê³„
                dt_obj = t['open_date'] if not isinstance(t['open_date'], str) else pd.to_datetime(t['open_date'])
                ym = dt_obj.strftime('%Y-%m')
                y = dt_obj.strftime('%Y')

                monthly_stats[ym]['games'] += 1
                monthly_stats[ym]['profit'] += t['pnl']
                monthly_stats[ym]['slippage'] += slippage_cost
                if t['is_win']: monthly_stats[ym]['wins'] += 1

                yearly_stats[y]['games'] += 1
                yearly_stats[y]['profit'] += t['pnl']
                yearly_stats[y]['slippage'] += slippage_cost
                if t['is_win']: yearly_stats[y]['wins'] += 1

                mark = "ğŸ”´" if profit_pct > 0 else "ğŸ”µ"
                print(
                    f"{stock_name:<12} | {open_date_str:<10} | {close_date_str:<10} | {entry_price:9,.0f} | {exit_price:9,.0f} | {profit_pct:6.2f}% | {max_profit_pct:8.2f}% | {rsi_val:6.1f} {mark}")

    print("=" * 110)

    avg_win_rate = (total_stats['wins'] / total_stats['trades'] * 100) if total_stats['trades'] > 0 else 0
    total_virtual_profit = total_stats['profit'] - total_stats['slippage']
    total_loss_ratio = (total_stats['slippage'] / abs(total_stats['profit']) * 100) if total_stats['profit'] != 0 else 0

    print(
        f"\nğŸ“ˆ [ì „ì²´ ìš”ì•½] ì´ ë§¤ë§¤ íšŸìˆ˜: {total_stats['trades']}íšŒ, í‰ê·  ìŠ¹ë¥ : {avg_win_rate:.2f}%, "
        f"ì´ ìˆ˜ìµê¸ˆ: {total_stats['profit']:,.0f}ì› | "
        f"ê°€ìƒìˆ˜ìµê¸ˆ(1%ìŠ¬ë¦¬í”¼ì§€): {total_virtual_profit:,.0f}ì› | "
        f"ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨: {total_loss_ratio:.2f}%"
    )

    # RSI ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [RSI êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 115)
    print(f"{'RSI êµ¬ê°„':<15} | {'ê²Œì„ìˆ˜':>10} | {'ìŠ¹ë¥ ':>10} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 115)
    rsi_order = ['50 ì´í•˜', '50ëŒ€', '60ëŒ€', '70ëŒ€', '80ëŒ€', '90ëŒ€']
    for bucket in rsi_order:
        s = rsi_stats[bucket]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{bucket:<15} | {s['games']:10d}íšŒ | {win_rate:9.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")
    print("=" * 115)

    # ì›”ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ì›”ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 100)
    print(f"{'ì›” (Month)':<10} | {'ê²Œì„ìˆ˜':>6} | {'ìŠ¹ë¥ ':>8} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 100)
    for ym in sorted(monthly_stats.keys()):
        s = monthly_stats[ym]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{ym:<10} | {s['games']:6d}íšŒ | {win_rate:7.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")
    print("=" * 100)

    # ë…„ë„ë³„ ë¶„ì„ ì¶œë ¥
    print("\n\nğŸ“Š [ë…„ë„ë³„ ì„±ê³¼ ë¶„ì„]")
    print("=" * 100)
    print(f"{'ë…„ë„ (Year)':<10} | {'ê²Œì„ìˆ˜':>6} | {'ìŠ¹ë¥ ':>8} | {'ì´ ìˆ˜ìµê¸ˆ':>18} | {'ê°€ìƒìˆ˜ìµê¸ˆ':>18} | {'ìŠ¬ë¦¬í”¼ì§€ë¹„ìœ¨':>10}")
    print("-" * 100)
    for y in sorted(yearly_stats.keys()):
        s = yearly_stats[y]
        win_rate = (s['wins'] / s['games'] * 100) if s['games'] > 0 else 0
        virtual_profit = s['profit'] - s['slippage']
        loss_ratio = (s['slippage'] / abs(s['profit']) * 100) if s['profit'] != 0 else 0
        print(
            f"{y:<10} | {s['games']:6d}íšŒ | {win_rate:7.1f}% | {s['profit']:18,.0f}ì› | {virtual_profit:18,.0f}ì› | {loss_ratio:9.2f}%")
    print("=" * 100)


if __name__ == "__main__":
    main()
