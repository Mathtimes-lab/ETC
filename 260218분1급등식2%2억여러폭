# ==========================================
# ğŸ“Š [ë¶„ë´‰ ì „ëµ] ë°´ë“œí­ êµ¬ê°„ë³„ ì„±ê³¼ ë¶„ì„
# ==========================================
import matplotlib

# í™”ë©´ í‘œì‹œ ì—†ì´ ë‚´ë¶€ì—ì„œ ì´ë¯¸ì§€ ìƒì„± (ì¶©ëŒ ë°©ì§€)
matplotlib.use('Agg')

import backtrader as bt
import pandas as pd
import os
import math
from datetime import time, timedelta
from collections import defaultdict
import matplotlib.pyplot as plt


# ==========================================
# [ì „ëµ] ë¶„ë´‰ ê¸‰ë“±ì£¼ ëŒíŒŒ + ë°´ë“œí­(ìˆ˜ë ´) í•„í„° + ì •ë°€ ë§¤ë„
# ==========================================
class CustomMinuteStrategy(bt.Strategy):
    """
    [ìƒì„¸ ì „ëµ ì„¤ëª…: ë¶„ë´‰ ê¸°ì¤€]
    ================================================================================
    1. ë§¤ìˆ˜ ì§„ì… ì¡°ê±´ (ëª¨ë‘ ë§Œì¡± ì‹œ)
       A. [ë³€ë™ì„± ëŒíŒŒ]
          - (ë¶„ë´‰) í˜„ì¬ë´‰ ì¢…ê°€ê°€ ì‹œê°€ ëŒ€ë¹„ 2% ì´ìƒ ìƒìŠ¹ (ì¥ëŒ€ì–‘ë´‰)
       B. [ìœ ë™ì„±]
          - (ë¶„ë´‰) í˜„ì¬ë´‰ ê±°ë˜ëŒ€ê¸ˆ 2ì–µ ì› ì´ìƒ
       C. [ì¶”ì„¸]
          - (ë¶„ë´‰) 1ë´‰ì „ê³¼ í˜„ì¬ë´‰ ëª¨ë‘ 3ë¶„ì„  > 5ë¶„ì„  ì •ë°°ì—´ ìƒíƒœ
       D. [ìˆ˜ë ´]
          - (ë¶„ë´‰) ì „ë´‰(1ë´‰ì „) ê¸°ì¤€ ë³¼ë¦°ì €ë°´ë“œ(10, 2) ë°´ë“œí­ì´ ì„¤ì •ëœ êµ¬ê°„(Min ~ Max) ë‚´ ìœ„ì¹˜

    2. ë§¤ë„ ì²­ì‚° ì¡°ê±´ - ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ ì¦‰ì‹œ ì²­ì‚° ê°€ì •
       - ë¶„ë´‰ ê¸°ì¤€ 3ë¶„ì„ ê³¼ 5ë¶„ì„ ì´ ë§Œë‚˜ëŠ” ê°€ê²©(Cross Price) ê³„ì‚°.
       - ì˜¤ëŠ˜ ì €ê°€(Low)ê°€ ì´ ê°€ê²© ì´í•˜ë¼ë©´ ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ ë°œìƒìœ¼ë¡œ ê°„ì£¼.
       - ë§¤ë„ê°€ê²©: êµì°¨ê°€ê²©(Cross Price)ìœ¼ë¡œ ì„¤ì • (ê°­í•˜ë½ ì‹œ ì‹œê°€ ë§¤ë„)
    ================================================================================
    """
    params = (
        ('target_rise_pct', 0.02),  # 2% ìƒìŠ¹ (ì‹œê°€ ëŒ€ë¹„ ì¢…ê°€)
        ('ma_fast', 3),  # 3ë¶„ì„ 
        ('ma_slow', 5),  # 5ë¶„ì„ 
        ('boll_period', 10),  # ë³¼ë¦°ì €ë°´ë“œ ê¸°ê°„
        ('boll_dev', 2.0),  # ë³¼ë¦°ì €ë°´ë“œ ìŠ¹ìˆ˜
        ('bandwidth_min', 0.0),    # ë°´ë“œí­ ìµœì†Œê°’ (ê¸°ë³¸ê°’)
        ('bandwidth_max', 0.02),   # ë°´ë“œí­ ìµœëŒ€ê°’ (ê¸°ë³¸ê°’)
        ('min_volume_amt', 200000000), # ê±°ë˜ëŒ€ê¸ˆ 2ì–µ ì›
        ('debug', False),
    )

    def __init__(self):
        self.ma3 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_fast)
        self.ma5 = bt.indicators.SimpleMovingAverage(self.data.close, period=self.p.ma_slow)

        # ë³¼ë¦°ì €ë°´ë“œ ì§€í‘œ (ë¶„ë´‰ ê¸°ì¤€)
        typical_price = (self.data.high + self.data.low + self.data.close) / 3.0
        self.bband = bt.indicators.BollingerBands(typical_price, period=self.p.boll_period, devfactor=self.p.boll_dev)

        # ìˆ˜ë™ í¬ì§€ì…˜ ê´€ë¦¬ìš© ë³€ìˆ˜
        self.my_position = None
        self.trades_history = []
        
        self.buy_points = []
        self.sell_points = []

        self.peak_price = 0

    def log(self, txt, dt=None):
        if self.p.debug:
            dt = dt or self.data.datetime.datetime(0)
            print(f'[{dt}] {txt}')

    def next(self):
        # ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if len(self.data) < max(self.p.ma_slow + 2, self.p.boll_period + 2):
            return
        
        current_dt = self.data.datetime.datetime(0)
        
        # ----------------------------------------------------------------------
        # [1] ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ë„(ì²­ì‚°) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position:
            # ìµœê³ ê°€ ê°±ì‹ 
            if self.data.high[0] > self.peak_price:
                self.peak_price = self.data.high[0]

            # ë°ë“œí¬ë¡œìŠ¤ ê°€ê²© ê³„ì‚° (ë¶„ë´‰ ê¸°ì¤€)
            # MA3(0) < MA5(0)ê°€ ë˜ëŠ” C(0) ì°¾ê¸°
            # ì‹: C0 = 1.5 * (C-3 + C-4) - (C-1 + C-2)
            c_1 = self.data.close[-1]
            c_2 = self.data.close[-2]
            c_3 = self.data.close[-3]
            c_4 = self.data.close[-4]
            
            cross_price_raw = 1.5 * (c_3 + c_4) - (c_1 + c_2)
            cross_price = round(cross_price_raw)

            sell_signal = False
            sell_price = 0
            sell_reason = ""

            # ì¡°ê±´ 1: ì´ì „ ë´‰ì—ì„œ ì´ë¯¸ ë°ë“œí¬ë¡œìŠ¤ ìƒíƒœ (ì•ˆì „ì¥ì¹˜)
            if self.ma3[-1] < self.ma5[-1]:
                sell_signal = True
                sell_price = self.data.open[0]
                sell_reason = "ì „ë´‰ ë°ë“œí¬ë¡œìŠ¤ ìƒíƒœ ì§€ì†"

            # ì¡°ê±´ 2: ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ (ì €ê°€ê°€ êµì°¨ ê°€ê²© ì´í•˜)
            elif self.data.low[0] <= cross_price:
                sell_signal = True
                # ê°­í•˜ë½(ì‹œê°€ < êµì°¨ê°€)ì´ë©´ ì‹œê°€ ë§¤ë„, ì•„ë‹ˆë©´ êµì°¨ê°€ ë§¤ë„
                if self.data.open[0] < cross_price:
                    sell_price = self.data.open[0]
                    sell_reason = f"ê°­í•˜ë½ ë°ë“œí¬ë¡œìŠ¤ (êµì°¨ê°’: {cross_price})"
                else:
                    sell_price = cross_price
                    sell_reason = f"ì¥ì¤‘ ë°ë“œí¬ë¡œìŠ¤ í„°ì¹˜ (êµì°¨ê°’: {cross_price})"

            if sell_signal:
                # ê±°ë˜ ê¸°ë¡ ë° í¬ì§€ì…˜ ì •ë¦¬
                entry_price = self.my_position['price']
                buy_size = self.my_position['size']
                buy_reason = self.my_position['reason']
                open_date = self.my_position['date']
                
                pnl = (sell_price - entry_price) * buy_size
                profit_pct = ((sell_price - entry_price) / entry_price) * 100
                max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100

                self.trades_history.append({
                    'open_date': open_date,
                    'date': current_dt,
                    'profit_pct': profit_pct,
                    'max_profit_pct': max_profit_pct,
                    'pnl': pnl,
                    'is_win': pnl > 0,
                    'entry_price': entry_price,
                    'exit_price': sell_price,
                    'status': 'Closed',
                    'buy_reason': buy_reason,
                    'sell_reason': sell_reason
                })
                
                self.sell_points.append((current_dt, sell_price))
                self.my_position = None
                self.peak_price = 0
                return

        # ----------------------------------------------------------------------
        # [2] ë¯¸ë³´ìœ  ì¤‘ì¼ ë•Œ: ë§¤ìˆ˜(ì§„ì…) ì¡°ê±´ í™•ì¸
        # ----------------------------------------------------------------------
        if self.my_position is None:
            # A. [ë³€ë™ì„± ëŒíŒŒ] ì‹œê°€ ëŒ€ë¹„ ì¢…ê°€ 2% ì´ìƒ ìƒìŠ¹
            if self.data.close[0] < self.data.open[0] * (1 + self.p.target_rise_pct):
                return

            # B. [ìœ ë™ì„±] ê±°ë˜ëŒ€ê¸ˆ 2ì–µ ì´ìƒ
            trade_amount = self.data.close[0] * self.data.volume[0]
            if trade_amount < self.p.min_volume_amt:
                return

            # C. [ì¶”ì„¸] 1ë´‰ì „, í˜„ì¬ë´‰ ëª¨ë‘ ì •ë°°ì—´ (MA3 > MA5)
            if not (self.ma3[-1] > self.ma5[-1] and self.ma3[0] > self.ma5[0]):
                return

            # D. [ìˆ˜ë ´] ì „ë´‰(1ë´‰ì „) ê¸°ì¤€ ë°´ë“œí­ < 2% (ë˜ëŠ” ì„¤ì •ê°’)
            # ë°´ë“œí­ ê³„ì‚°: (Top - Bot) / Mid
            top_prev = self.bband.lines.top[-1]
            bot_prev = self.bband.lines.bot[-1]
            mid_prev = self.bband.lines.mid[-1]
            
            if mid_prev == 0: return
            bandwidth = (top_prev - bot_prev) / mid_prev

            # ë°´ë“œí­ ì¡°ê±´ ì²´í¬ (Min <= Bandwidth < Max)
            if not (self.p.bandwidth_min <= bandwidth < self.p.bandwidth_max):
                return

            # ë§¤ìˆ˜ ì§„ì… (ì¢…ê°€ ë§¤ìˆ˜ ê°€ì •)
            buy_price = self.data.close[0]
            
            # ìê¸ˆ ê´€ë¦¬ (1íšŒ 100ë§Œì› ê°€ì • - ë¶„ë´‰ ë‹¨íƒ€ëŠ” ì†Œì•¡ ê°€ì •, í•„ìš” ì‹œ ìˆ˜ì •)
            cash = 10000000 
            size = math.floor(cash / buy_price)
            
            buy_reason = (f"ğŸš€ [ì§„ì…] 2% ê¸‰ë“± & ìˆ˜ë ´ ëŒíŒŒ\n"
                          f"   - ìƒìŠ¹ë¥ : {(buy_price/self.data.open[0]-1)*100:.2f}%\n"
                          f"   - ê±°ë˜ëŒ€ê¸ˆ: {trade_amount/100000000:.2f}ì–µ\n"
                          f"   - ì „ë´‰ ë°´ë“œí­: {bandwidth*100:.2f}% ({self.p.bandwidth_min*100}% ~ {self.p.bandwidth_max*100}%)")

            self.my_position = {
                'price': buy_price,
                'date': current_dt,
                'size': size,
                'reason': buy_reason
            }
            self.peak_price = buy_price
            self.buy_points.append((current_dt, buy_price))


    def stop(self):
        # ê°•ì œ ì²­ì‚°
        if self.my_position:
            current_dt = self.data.datetime.datetime(0)
            current_price = self.data.close[0]
            entry_price = self.my_position['price']
            buy_size = self.my_position['size']
            
            if current_price > self.peak_price:
                self.peak_price = current_price

            pnl = (current_price - entry_price) * buy_size
            profit_pct = ((current_price - entry_price) / entry_price) * 100
            max_profit_pct = ((self.peak_price - entry_price) / entry_price) * 100
            
            self.trades_history.append({
                'open_date': self.my_position['date'],
                'date': current_dt,
                'profit_pct': profit_pct,
                'max_profit_pct': max_profit_pct,
                'pnl': pnl,
                'is_win': pnl > 0,
                'entry_price': entry_price,
                'exit_price': current_price,
                'status': 'Holding',
                'buy_reason': self.my_position['reason'],
                'sell_reason': "ë°±í…ŒìŠ¤íŠ¸ ì¢…ë£Œ"
            })


# ==========================================
# ì‹¤í–‰ í•¨ìˆ˜
# ==========================================
def run_single_backtest(file_path, bandwidth_min, bandwidth_max):
    try:
        df = pd.read_excel(file_path)
        # ì»¬ëŸ¼ ë§¤í•‘ (ë¶„ë´‰ ë°ì´í„° í˜•ì‹ì— ë§ì¶° ì¡°ì • í•„ìš” ì‹œ ìˆ˜ì •)
        rename_map = {'í˜„ì¬ê°€': 'Close', 'ì¢…ê°€': 'Close', 'ì‹œê°€': 'Open', 'ê³ ê°€': 'High', 'ì €ê°€': 'Low', 'ê±°ë˜ëŸ‰': 'Volume',
                      'ì¼ì': 'Date', 'ì‹œê°„': 'Time'} # 'ì‹œê°„' ì»¬ëŸ¼ì´ ë³„ë„ë¡œ ìˆì„ ê²½ìš°
        df = df.rename(columns=rename_map)

        # ë‚ ì§œ/ì‹œê°„ ì²˜ë¦¬
        if 'Date' in df.columns:
            # Date ì»¬ëŸ¼ì´ ë¬¸ìì—´ì´ê±°ë‚˜ datetimeì¸ ê²½ìš° ì²˜ë¦¬
            if df['Date'].dtype == 'object':
                 df['Date'] = pd.to_datetime(df['Date'])
            
            # ë¶„ë´‰ì´ë¯€ë¡œ ì¸ë±ìŠ¤ ì„¤ì • ì‹œ ì£¼ì˜
            df = df.sort_values('Date').set_index('Date')
        else:
            return None

        # ìˆ«ì ë³€í™˜
        cols_to_numeric = ['Close', 'Open', 'High', 'Low', 'Volume']
        for col in cols_to_numeric:
            if col in df.columns:
                if df[col].dtype == 'object':
                    df[col] = df[col].astype(str).str.replace(',', '')
                df[col] = pd.to_numeric(df[col], errors='coerce').abs()
        df = df.dropna(subset=[c for c in cols_to_numeric if c in df.columns])
        
        if len(df) < 20: return None

        cerebro = bt.Cerebro(runonce=False)
        cerebro.broker.setcash(100000000)

        # ì „ëµ ì¶”ê°€ (ë°´ë“œí­ ë²”ìœ„ ì¡°ê±´ ì „ë‹¬)
        cerebro.addstrategy(CustomMinuteStrategy, bandwidth_min=bandwidth_min, bandwidth_max=bandwidth_max)

        cerebro.adddata(bt.feeds.PandasData(dataname=df))
        
        strats = cerebro.run()
        trades_hist = strats[0].trades_history

        if not trades_hist:
            return {'trades': 0, 'wins': 0, 'win_rate': 0, 'total_profit': 0, 'history': []}

        total_trades = len(trades_hist)
        wins = sum(1 for t in trades_hist if t['is_win'])
        win_rate = (wins / total_trades * 100) if total_trades > 0 else 0
        total_profit = sum(t['pnl'] for t in trades_hist)

        return {
            'trades': total_trades,
            'wins': wins,
            'win_rate': win_rate,
            'total_profit': total_profit,
            'history': trades_hist
        }

    except Exception as e:
        return None


def main():
    print(CustomMinuteStrategy.__doc__)
    print("=== ğŸ¯ [ë¶„ë´‰ ì „ëµ] ë°´ë“œí­ êµ¬ê°„ë³„ ìƒì„¸ ê±°ë˜ ë‚´ì—­ ===")
    
    # í´ë” ê²½ë¡œ
    data_dir = "stock_data_min"
    if not os.path.exists(data_dir):
        print(f"ğŸš¨ '{data_dir}' í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return

    files = [os.path.join(data_dir, f) for f in os.listdir(data_dir) if f.endswith(".xlsx")]
    print(f"ğŸ“‚ ë¶„ì„ ëŒ€ìƒ: {len(files)}ê°œ ì¢…ëª© (ë¶„ë´‰ ë°ì´í„°)\n")
    
    # [ìˆ˜ì •] 5ê°€ì§€ ë°´ë“œí­ ì‹œë‚˜ë¦¬ì˜¤
    scenarios = [
        {'label': '2% ë¯¸ë§Œ',     'min': 0.0,  'max': 0.02},
        {'label': '2% ~ 3%',    'min': 0.02, 'max': 0.03},
        {'label': '3% ~ 4%',    'min': 0.03, 'max': 0.04},
        {'label': '4% ~ 5%',    'min': 0.04, 'max': 0.05},
        {'label': '5% ì´ìƒ',     'min': 0.05, 'max': 100.0},
    ]

    scenario_results = []

    for sc in scenarios:
        print(f"\nğŸš€ [ì‹œë‚˜ë¦¬ì˜¤] ë°´ë“œí­ {sc['label']} ì‹¤í–‰ ì¤‘...")
        # ìƒì„¸ ë‚´ì—­ í—¤ë” ì¶œë ¥
        print(f"{'ì¢…ëª©ëª…':<10} | {'ë§¤ìˆ˜ì¼ì‹œ':<16} | {'ë§¤ë„ì¼ì‹œ':<16} | {'ë§¤ìˆ˜ê°€':>9} | {'ë§¤ë„ê°€':>9} | {'ìˆ˜ìµë¥ ':>7}")
        print("-" * 80)

        total_stats = {'trades': 0, 'profit': 0, 'wins': 0}
        active_stocks = 0

        for file_path in files:
            stock_name = os.path.basename(file_path).split('_')[-1].replace('.xlsx', '')
            
            res = run_single_backtest(file_path, sc['min'], sc['max'])

            if res and res['trades'] > 0:
                active_stocks += 1
                total_stats['trades'] += res['trades']
                total_stats['profit'] += res['total_profit']
                total_stats['wins'] += res['wins']
                
                # ê° ê±°ë˜ ë‚´ì—­ ì¶œë ¥
                for t in res['history']:
                    # ë‚ ì§œ/ì‹œê°„ í¬ë§·íŒ…
                    buy_date = t['open_date'].strftime('%Y-%m-%d %H:%M')
                    sell_date = t['date'].strftime('%Y-%m-%d %H:%M')
                    
                    # ìˆ˜ìµë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë§ˆí¬ (í„°ë¯¸ë„ìš©)
                    mark = "ğŸ”´" if t['profit_pct'] > 0 else "ğŸ”µ"
                    
                    print(f"{stock_name:<10} | {buy_date:<16} | {sell_date:<16} | {t['entry_price']:9,.0f} | {t['exit_price']:9,.0f} | {t['profit_pct']:6.2f}% {mark}")

        print("-" * 80)
        avg_win_rate = (total_stats['wins'] / total_stats['trades'] * 100) if total_stats['trades'] > 0 else 0
        
        scenario_results.append({
            'label': sc['label'],
            'trades': total_stats['trades'],
            'win_rate': avg_win_rate,
            'total_profit': total_stats['profit'],
            'active_stocks': active_stocks
        })

    print("\n\nğŸ“Š [ìµœì¢… ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„±ê³¼ ë¹„êµ]")
    print("=" * 80)
    print(f"{'êµ¬ê°„ (Bandwidth)':<15} | {'ì²´ê²° ì¢…ëª©ìˆ˜':>10} | {'ì´ ë§¤ë§¤íšŸìˆ˜':>10} | {'ì „ì²´ ìŠ¹ë¥ ':>10} | {'ì´ ìˆ˜ìµê¸ˆ':>18}")
    print("-" * 80)

    for res in scenario_results:
        print(f"{res['label']:<15} | {res['active_stocks']:10d}ê°œ | {res['trades']:10d}íšŒ | {res['win_rate']:9.1f}% | {res['total_profit']:18,.0f}ì›")
    print("=" * 80)

if __name__ == "__main__":
    main()
